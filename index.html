<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIB Ads WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap'); 

        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Vazirmatn', Arial, Helvetica, sans-serif;overflow:hidden;background: #0d0c1d;}
        
        .app-screen {
            position: fixed;
            inset: 0;
            background: url('img.png') no-repeat center center;
            background-size: cover;
            transition: opacity .5s ease-in;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none; 
            z-index: 10; 
        }
        .app-screen.visible {
            opacity: 1;
            pointer-events: auto;
            z-index: 20; 
        }

        /* Loading Screen - Minimalistic Spinning Circle */
        .loading-screen{
            position:fixed;inset:0;
            background: #0d0c1d;
            display:flex;flex-direction:column;justify-content:center;align-items:center;
            z-index:9999;transition:opacity .5s ease-out;
        }
        .loading-screen.hidden{opacity:0;pointer-events:none}
        
        .spinner-circle {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-top: 8px solid #00ffff; /* Neon color */
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6); /* Neon glow */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* End of Loading Screen */

        /* Main Screen */
        .main-screen{
            background-color: #f0f0f0; 
        }
        
        .main-content{flex:1;display:flex;justify-content:center;align-items:center}
        
        /* User Circle */
        .user-circle{
            position:absolute;top:20px;left:20px;width:70px;height:70px;border:2px dashed #ccc;
            border-radius:50%;display:flex;flex-direction:column;justify-content:center;
            align-items:center;cursor:pointer;transition:all .3s ease;z-index:100;overflow:hidden
        }
        .user-circle:hover{border-color:#4a90e2;background:rgba(74,144,226,.05)}
        .user-circle img{width:100%;height:100%;object-fit:cover;border-radius:50%;display:none}
        .user-circle .placeholder{color:#999;font-size:12px;text-align:center}
        
        .user-username{
            position: absolute;
            top: 95px;
            left: 20px;
            width: 70px;
            font-size:13px;color:#555;white-space:nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-id{
            position: absolute;
            top: 115px;
            left: 20px;
            width: 70px;
            font-size:11px;color:#888;white-space:nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .balance{position:absolute;top:20px;right:20px;background:#fff;border:1px solid #ff5a5a;border-radius:12px;padding:8px 12px;font-family:'Courier New',monospace;font-size:16px;color:#ff2a2a;text-shadow:0 0 2px #ffbbbb;letter-spacing:1px;z-index:101;box-shadow:0 4px 6px rgba(0,0,0,.05)}
        
        /* Shared Progress Containers */
        .progress-group-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 90%;
            max-width: 300px;
            z-index: 102;
        }
        .daily-progress-container, .spin-progress-container {
            background: #fff;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,.1);
            text-align: center;
            border-left: 5px solid #4a90e2; 
        }
        .spin-progress-container {
            border-left: 5px solid #ff8c00; 
        }
        .daily-progress-text, .spin-progress-text {font-size:14px;color:#333;margin-bottom:4px; font-weight: bold;}
        .daily-progress-bar, .spin-progress-bar {width:100%;height:12px;background:rgba(0,0,0,.1);border-radius:10px;overflow:hidden;margin-top:6px}
        .daily-progress-fill {height:100%;background:linear-gradient(90deg,#00f2fe,#4facfe);border-radius:10px;width:0%;transition:width .4s ease}
        .spin-progress-fill {height:100%;background:linear-gradient(90deg,#ff8c00, #ff4500);border-radius:10px;width:0%;transition:width .4s ease}

        /* Button Adjustments - Equal width for 5 buttons */
        .button-container{
            position:absolute;bottom:40px;left:50%;transform:translateX(-50%);
            display:grid; /* Change to grid for better control */
            grid-template-columns: repeat(5, 1fr); /* 5 equal columns (UPDATED) */
            gap: 8px; /* Slightly reduced gap */
            background:rgba(240,240,240,.9);padding:10px 10px; /* Reduced padding */
            border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,.1);backdrop-filter:blur(10px);
            width: 95%; /* Increased width for more space */
            max-width: 450px;
        }
        .nav-button{
            position:relative;background:linear-gradient(145deg,#4a90e2,#357abd);color:#fff;border:none;padding:10px 0; /* Adjust padding for height control */
            border-radius:10px;font-size:11px; /* Reduced font size for better fit */
            font-weight:bold;cursor:pointer;transition:all .1s ease;
            flex-grow: 1;
            min-width: auto;
            text-transform:uppercase;letter-spacing:.5px;box-shadow:0 5px 0 #2c5aa0,0 8px 12px rgba(0,0,0,.15);transform:translateY(0);
            text-align: center;
            line-height: 1; /* Ensure text fits */
        }
        .nav-button:hover{transform:translateY(-1px);box-shadow:0 6px 0 #2c5aa0,0 10px 15px rgba(0,0,0,.2)}
        .nav-button:active{transform:translateY(2px);box-shadow:0 3px 0 #2c5aa0,0 5px 8px rgba(0,0,0,.15)}
        .nav-button span{display:block;text-shadow:0 1px 2px rgba(0,0,0,.3)}

        .nav-button.task-btn{
            background:linear-gradient(145deg,#ffc107,#ff9800);
            box-shadow:0 5px 0 #cc9a00,0 8px 12px rgba(0,0,0,.15);
        }
        .nav-button.task-btn:hover{box-shadow:0 6px 0 #cc9a00,0 10px 15px rgba(0,0,0,.2)}
        .nav-button.task-btn:active{box-shadow:0 3px 0 #cc9a00,0 5px 8px rgba(0,0,0,.15)}

        /* NEW Style for Withdraw Nav Button */
        .nav-button.withdraw-btn-nav{
            background:linear-gradient(145deg,#ff2a2a,#cc2121);
            box-shadow:0 5px 0 #991919,0 8px 12px rgba(0,0,0,.15);
        }
        .nav-button.withdraw-btn-nav:hover{box-shadow:0 6px 0 #991919,0 10px 15px rgba(0,0,0,.2)}
        .nav-button.withdraw-btn-nav:active{box-shadow:0 3px 0 #991919,0 5px 8px rgba(0,0,0,.15)}

        /* ===== Task Screen - REDESIGNED STYLING ===== */
        .task-screen{
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content: flex-start; 
            padding-top: 50px; 
            padding-bottom: 120px; 
            overflow-y: auto;
            background: #ffffed; /* Light, paper-like background */
        }
        .task-header{ 
            text-align: center;
            margin-bottom: 30px;
            width: 90%;
            max-width: 350px;
        }
        .task-title{ 
             font-family: 'Vazirmatn', sans-serif; 
             font-size:24px; 
             color:#333; /* Dark pencil color */
             font-weight:700; 
             text-shadow: 1px 1px 0 #fff; 
             border-bottom: 2px dashed #a0a0a0;
             padding-bottom: 10px;
        }
        
        /* New Task Card Style based on user's input (Paper Style) */
        .task-content-container {
            width: 100%;
            padding: 0 10px;
            max-width: 400px;
        }

        .task-item-card {
            background:#ffffff; /* White card */
            margin:10px 0;
            padding:18px;
            border-radius:10px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            border: 1px solid #ddd; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .task-text-info {
            color: #555; /* Slightly lighter text */
            font-size: 16px;
            font-weight: 500;
        }

        /* Button style from user's input (Pencil Style Action Button) */
        .task-action-btn-new {
            background:linear-gradient(145deg, #ffc107, #ff9800);
            border:1px solid #cc9a00;
            color:#fff;
            padding:10px 20px;
            border-radius:8px;
            cursor:pointer;
            font-size:1em;
            font-weight: bold;
            min-width: 90px; 
            transition: all 0.1s ease;
            box-shadow: 0 4px 0 #cc9a00;
            text-transform: uppercase;
        }
        .task-action-btn-new:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 0 #cc9a00;
        }
        .task-action-btn-new:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #cc9a00;
        }
        .task-action-btn-new:disabled {
            background:#ccc;
            border-color:#aaa;
            color:#666;
            cursor:not-allowed;
            box-shadow: 0 4px 0 #aaa;
            transform: translateY(0);
        }
        
        .task-action-btn-new.completed {
            background:linear-gradient(145deg, #28a745, #1e7e34); /* Green for completed */
            border-color: #1c6d32;
            color: #fff;
            cursor: default;
            box-shadow: 0 4px 0 #1c6d32;
        }
        .task-action-btn-new.completed:disabled {
             background:linear-gradient(145deg, #1e7e34, #1c6d32); /* Darker green when disabled (after completion) */
             color: #ccc;
             box-shadow: 0 4px 0 #1c6d32;
        }
        
        /* Task Note style - REMOVED */
        .task-screen .note{ display: none; }

        /* Back Button Style - FIXED at bottom */
        .task-back-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background:linear-gradient(145deg, #6c757d, #5a6268);
            color:#fff;border:none;padding:15px 40px; /* Larger padding */
            border-radius:12px;
            font-size:16px;
            font-weight:bold;
            cursor:pointer;
            box-shadow:0 6px 0 #4e555b; /* Larger shadow */
            transition:all .1s ease;
            width: 90%;
            max-width: 350px;
            z-index: 1000; /* Ensure it's above other elements */
        }
        .task-back-btn:active{transform:translateY(3px) translateX(-50%);box-shadow:0 3px 0 #4e555b}
        
        /* ===== Spin Screen ===== */
        .spin-screen{
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            transition:opacity .3s ease;
        }
        #wheelBox{position:relative;margin-bottom:25px}
        #wheelCanvas{
            border-radius:50%;
            /* Enhanced 3D Look */
            box-shadow:0 0 0 10px #eee, 0 15px 35px rgba(0,0,0,0.4); 
            background-color: #fefefe; 
            border: 2px solid #ccc; 
        }
        .arrow{
            position:absolute;top:-16px;left:50%;transform:translateX(-50%);
            width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;
            border-top:28px solid #ff3366;filter:drop-shadow(0 3px 2px rgba(0,0,0,.3));z-index:10;
        }
        .spin-btn{background:#ff3366;color:#fff;border:none;padding:12px 35px;border-radius:30px;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 6px 0 #cc2950;transition:all .1s ease}
        .spin-btn:active{transform:translateY(3px);box-shadow:0 3px 0 #cc2950}
        .spin-result{margin-top:18px;font-size:18px;color:#333}
        .spin-back{margin-top:25px;background:#6c757d;color:#fff;border:none;padding:10px 25px;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;box-shadow:0 4px 0 #5a6268}
        .spin-back:active{transform:translateY(2px);box-shadow:0 2px 0 #5a6268}

        /* ===== Withdraw Screen - (No changes needed) ===== */
        .withdraw-screen{
            display:flex;flex-direction:column;align-items:center;padding:20px 20px;
            transition:opacity .3s ease;
            overflow-y: auto;
        }
        .withdraw-header{
            text-align: center;
            margin-bottom: 25px;
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .withdraw-title{
            font-size:28px;color:#ff2a2a;font-weight:700; text-shadow: 0 1px 1px rgba(0,0,0,.1);
        }
        .current-balance-info{
            font-size: 16px;
            color: #555;
            margin-top: 10px;
            font-weight: bold;
        }
        .input-form-container {
            width: 100%;
            max-width: 400px;
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,.1);
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .input-group{
            width:100%;margin-bottom:15px;
        }
        .input-group label{display:block;margin-bottom:8px;font-size:14px;color:#555;font-weight:600;}
        .input-group input{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:10px;font-size:16px;transition:border-color .3s ease, box-shadow .3s ease;outline:none;}
        .input-group input:focus{border-color:#ff8c00;box-shadow:0 0 0 3px rgba(255,140,0,0.2);}
        .withdraw-buttons{display:flex;gap:15px;margin-top:20px;justify-content: center;}
        .withdraw-btn{
            background:linear-gradient(145deg, #28a745, #1e7e34);
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #1c6d32;transition:all .1s ease;
            width: 100%;
        }
        .withdraw-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #1c6d32}
        .back-btn{
            background:linear-gradient(145deg, #6c757d, #5a6268);
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #4e555b;transition:all .1s ease;
        }
        .back-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #4e555b}
        .note{margin-top:15px;font-size:13px;color:#777;max-width:400px;text-align:center;background:rgba(255,140,0,0.1);padding:10px;border-radius:10px;border-left: 5px solid #ff8c00;}

        /* Withdrawal History Table */
        .history-section{
            width: 100%;
            max-width: 400px;
            margin-top: 30px;
            padding: 20px 0;
            border-top: 1px solid #eee;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .history-title{
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 700;
            text-align: center;
        }
        .history-table{
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .history-table th, .history-table td{
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        .history-table th{
            background-color: #f0f4f8;
            color: #4a90e2;
            font-weight: 700;
        }
        .history-table tr:last-child td{
            border-bottom: none;
        }
        .status-pending{color: #ff8c00; font-weight: bold;}
        .status-completed{color: #28a745; font-weight: bold;}
        .no-records{text-align: center; color: #999; padding: 20px;}
        
        /* ===== Invite Screen - (No changes needed) ===== */
        .invite-screen{
            display:flex;flex-direction:column;align-items:center;padding:20px 20px;
            transition:opacity .3s ease;
            overflow-y: auto;
        }
        .invite-header{ 
            text-align: center;
            margin-bottom: 25px;
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .invite-title{ 
             font-size:28px;color:#4a90e2;font-weight:700; text-shadow: 0 1px 1px rgba(0,0,0,.1);
        }
        .referrals-count-info{
            font-size: 18px;
            color: #333;
            margin-top: 15px;
            font-weight: bold;
            padding: 10px 15px;
            background: #e6f0ff;
            border-radius: 10px;
            border: 1px solid #cce0ff;
            box-shadow: 0 2px 5px rgba(0,0,0,.05);
            width: 100%;
        }
        .invite-buttons{
            width: 100%;
            margin-top: 15px;
        }
        .copy-link-btn{
            background:linear-gradient(145deg, #00bfff, #0077b3);
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #005a8d;transition:all .1s ease;
            width: 100%; 
        }
        .copy-link-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #005a8d}
        #referralLinkInput{
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            color: #4a90e2;
            background: #f8f8f8;
            word-break: break-all;
            white-space: normal;
        }
        
        /* Custom Alert Overlay - (No changes needed) */
        .custom-alert-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .custom-alert-overlay.visible {
            display: flex;
            opacity: 1;
        }

        /* Custom Alert Box - 3D Pencil Style - SLIGHTLY SMALLER - (No changes needed) */
        .custom-alert-box {
            width: 90%;
            max-width: 280px; /* Smaller max width */
            background: #ffffed; /* Off-white paper background */
            border-radius: 15px;
            padding: 20px; /* Reduced padding */
            text-align: center;
            box-shadow: 
                0 8px 15px rgba(0, 0, 0, 0.3), /* Base shadow */
                inset 0 0 10px rgba(0, 0, 0, 0.05); /* Inner light effect */
            border: 3px solid #6b4d32; /* Pencil/Wood border */
            transform: perspective(600px) rotateX(0deg) scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Spring effect */
        }
        .custom-alert-overlay.visible .custom-alert-box {
            transform: perspective(600px) rotateX(0deg) scale(1);
        }

        .alert-title {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 20px; /* Slightly smaller title */
            font-weight: 700;
            color: #4CAF50; 
            margin-bottom: 8px; /* Reduced margin */
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.1); 
            letter-spacing: 0.5px;
        }

        .alert-message {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 13px; /* Slightly smaller message */
            color: #333; 
            margin-bottom: 18px; /* Reduced margin */
            white-space: pre-wrap; 
        }

        .alert-icon {
            font-size: 35px; /* Slightly smaller icon */
            margin-bottom: 12px;
        }
        .alert-icon::before {
            content: 'â­';
        }

        .alert-close-btn {
            background: #6b4d32; 
            color: #fff;
            border: none;
            padding: 9px 18px; /* Slightly smaller button */
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #543b27;
            transition: all 0.1s ease;
        }
        .alert-close-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #543b27;
        }

        /* Specific styles for Success */
        .custom-alert-box.success .alert-title { color: #28a745; }
        .custom-alert-box.success .alert-icon::before { content: 'ğŸ®'; }

        /* Specific styles for Error/Warning */
        .custom-alert-box.error .alert-title { color: #dc3545; }
        .custom-alert-box.error .alert-icon::before { content: 'ğŸ¤¦'; }

        /* Specific styles for Warning/Info - Using Yellow/Brown for Pencil/Paper Theme */
        .custom-alert-box.warning .alert-title { color: #8B4513; } /* Brown */
        .custom-alert-box.warning .alert-icon::before { content: 'âœï¸'; } /* Pencil/Writing Icon */

    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner-circle"></div> 
    </div>
    
    <div class="app-screen main-screen" id="mainScreen">
        <div class="balance" id="shibBalance">0 SHIB</div>
        
        <div class="progress-group-container">
            <div class="daily-progress-container">
                <div class="daily-progress-text">Ads today: <span id="adsCount">0</span> / 100</div>
                <div class="daily-progress-bar">
                    <div class="daily-progress-fill" id="dailyProgressFill"></div>
                </div>
            </div>
            <div class="spin-progress-container">
                <div class="spin-progress-text">Spins today: <span id="spinsCount">0</span> / 15</div>
                <div class="spin-progress-bar">
                    <div class="spin-progress-fill" id="spinProgressFill"></div>
                </div>
            </div>
        </div>
        
        <div class="user-circle" onclick="circleClick()">
            <img id="userImage" src="" alt="User">
            <div class="placeholder">+</div>
        </div>
        <div class="user-username" id="userName"></div>
        <div class="user-id" id="userId"></div>
        
        <div class="main-content">
            </div>

        <div class="button-container">
            <button class="nav-button" onclick="watchAds()"><span>Ads</span></button>
            <button class="nav-button task-btn" onclick="showTask()"><span>Task</span></button>
            <button class="nav-button" onclick="showSpin()"><span>Spin</span></button>
            <button class="nav-button withdraw-btn-nav" onclick="showWithdraw()"><span>Withdraw</span></button>
            <button class="nav-button" onclick="inviteFriends()"><span>Invite</span></button>
        </div>
    </div>
    
    <div class="app-screen task-screen" id="taskScreen">
        <div class="task-header">
            <h2 class="task-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø© ğŸ“</h2>
        </div>

        <div class="task-content-container" id="tasks-list">
            <p class="loading-message" style="text-align:center; color:#555; margin-top: 20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…...</p>
        </div>
        <button class="task-back-btn" onclick="hideTask()">Back to Main</button>
    </div>
    
    <div class="app-screen spin-screen" id="spinScreen">
        <div id="wheelBox">
            <div class="arrow"></div>
            <canvas id="wheelCanvas" width="280" height="280"></canvas>
        </div>
        <button class="spin-btn" id="spinBtn" onclick="startSpin()">SPIN</button>
        <div class="spin-result" id="spinResult"></div>
        <button class="spin-back" onclick="hideSpin()">Back</button>
    </div>
    
    <div class="app-screen withdraw-screen" id="withdrawScreen">
        <div class="withdraw-header">
            <h2 class="withdraw-title">ğŸ’° Request SHIB Withdrawal</h2>
            <div class="current-balance-info">Your Balance: <span id="withdrawBalanceDisplay">0 SHIB</span></div>
        </div>
        <div class="input-form-container">
            <div class="input-group">
                <label>Binance User ID</label>
                <input type="text" id="binanceId" placeholder="Enter your Binance ID">
            </div>
            <div class="input-group">
                <label>Amount in SHIB (Min 400)</label>
                <input type="number" id="withdrawAmount" min="400" value="" placeholder="">
            </div>
            <div class="withdraw-buttons">
                <button class="withdraw-btn" onclick="confirmWithdraw()">Send Request</button>
            </div>
        </div>
        <div class="note"> âš ï¸ **Important:** The withdrawal will be processed manually within **24 hours**. Ensure your Binance ID is correct. </div>
        <div class="history-section">
            <h3 class="history-title">Withdrawal History</h3>
            <div id="withdrawalHistoryContainer"> 
                </div>
        </div>
        <button class="back-btn" onclick="hideWithdraw()">Back to Main</button>
    </div>
    
    <div class="app-screen invite-screen" id="inviteScreen">
        <div class="invite-header">
            <h2 class="invite-title">ğŸ¤ Invite Friends & Earn SHIB</h2>
            <div class="referrals-count-info"> Your Referrals: <span id="referralsCountDisplay">0</span> </div>
        </div>
        <div class="input-form-container">
            <div class="input-group">
                <label>Your Referral Link</label>
                <input type="text" id="referralLinkInput" readonly value="Generating Link...">
            </div>
            <div class="invite-buttons">
                <button class="copy-link-btn" onclick="copyReferralLink()">Copy Link</button>
            </div>
        </div>
        <div class="note"> ğŸš€ Share this link to invite new users. You will earn 5% of the revenue from every referral you bring through ads! </div>
        <button class="back-btn" onclick="hideInvite()">Back to Main</button>
    </div>
    
    <div id="customAlert" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <div class="alert-icon" id="alertIcon"></div>
            <div class="alert-title" id="alertTitle"></div>
            <div class="alert-message" id="alertMessage"></div>
            <button class="alert-close-btn" onclick="document.getElementById('customAlert').classList.remove('visible')">OK</button>
        </div>
    </div>
    
    <audio id="backgroundAudio" loop>
        <source src="audio.mp3" type="audio/mp3">
        Your browser does not support the audio element.
    </audio>
    <audio id="successSFX">
        <source src="success.mp3" type="audio/mp3">
    </audio>
    <audio id="errorSFX">
        <source src="error.mp3" type="audio/mp3">
    </audio>
    

    <script>
        // --- Global Variables ---
        const tg = window.Telegram.WebApp;
        let userId = null;
        let userData = {};
        let isBanned = false; 
        let actionIDCounter = 0;
        let adsCount = 0;
        let spinsCount = 0;

        const loadingScreen = document.getElementById('loadingScreen');
        const mainScreen = document.getElementById('mainScreen');
        const shibBalanceDisplay = document.getElementById('shibBalance');
        
        // --- Utility Functions ---

        function showLoading() {
            loadingScreen.classList.remove('hidden');
        }

        function hideLoading() {
            loadingScreen.classList.add('hidden');
        }

        function showCustomAlert(title, message, type = 'info') {
            const alertOverlay = document.getElementById('customAlert');
            const alertBox = alertOverlay.querySelector('.custom-alert-box');
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            
            alertBox.className = `custom-alert-box ${type}`;

            if (type === 'success') {
                document.getElementById('successSFX')?.play();
            } else if (type === 'error') {
                document.getElementById('errorSFX')?.play();
            }

            alertOverlay.classList.add('visible');
        }

        // Plays background music
        function playBGAudio() {
            const audio = document.getElementById('backgroundAudio');
            if (audio) {
                audio.volume = 0.2; // Set low volume
                audio.play().catch(e => console.log("Audio play failed:", e));
            }
        }

        // --- Navigation Functions ---

        function navigate(screenId) {
            document.querySelectorAll('.app-screen').forEach(screen => {
                screen.classList.remove('visible');
            });
            document.getElementById(screenId).classList.add('visible');
        }

        function showTask(){
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('taskScreen').classList.add('visible');
            // ğŸŸ¢ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‡Ø§Ù…
            loadTasks();
        }

        function hideTask(){
            // Ù…Ø³Ø­ Ø£ÙŠ Ù…Ø¤Ù‚ØªØ§Øª Ø¬Ø§Ø±ÙŠØ© Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø´Ø§Ø´Ø©
            for (const taskId in currentTaskVerification) {
                clearInterval(currentTaskVerification[taskId]);
            }
            currentTaskVerification = {};
            
            document.getElementById('taskScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }

        function showSpin(){
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            navigate('spinScreen');
        }

        function hideSpin(){
            navigate('mainScreen');
        }

        function showWithdraw(){
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            navigate('withdrawScreen');
            document.getElementById('withdrawBalanceDisplay').textContent = userData.balance ? parseFloat(userData.balance).toLocaleString() + ' SHIB' : '0 SHIB';
            displayWithdrawals();
        }

        function hideWithdraw(){
            navigate('mainScreen');
        }

        function inviteFriends(){
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            navigate('inviteScreen');
            document.getElementById('referralsCountDisplay').textContent = userData.referrals_count || 0;
            generateReferralLink();
        }

        function hideInvite(){
            navigate('mainScreen');
        }

        function watchAds(){
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            // Temporarily removed ad logic for simplification, but the API handler is ready.
            showCustomAlert('Watching Ad', 'Simulating Ad viewing... Please wait 5 seconds.', 'info');
            showLoading();

            setTimeout(async () => {
                const actionId = await requestActionId('watchAd');
                if (!actionId) {
                    hideLoading();
                    return;
                }

                const result = await fetchApi({
                    type: 'watchAd',
                    action_id: actionId
                });

                hideLoading();
                if (result.ok) {
                    updateState({ 
                        balance: result.data.new_balance, 
                        ads_count: result.data.ads_count
                    });
                    showCustomAlert('Success!', `You earned ${result.data.reward} SHIB. Ads watched today: ${result.data.ads_count}/100.`, 'success');
                } else {
                    showCustomAlert('Error', result.error || 'Failed to watch ad. Try again.', 'error');
                }
            }, 5000); 
        }

        function updateProgressBars() {
            const maxAds = 100;
            const maxSpins = 15;

            document.getElementById('adsCount').textContent = userData.ads_count || 0;
            document.getElementById('spinsCount').textContent = userData.spins_count || 0;

            const adsPercent = Math.min(100, ((userData.ads_count || 0) / maxAds) * 100);
            document.getElementById('dailyProgressFill').style.width = adsPercent + '%';

            const spinsPercent = Math.min(100, ((userData.spins_count || 0) / maxSpins) * 100);
            document.getElementById('spinProgressFill').style.width = spinsPercent + '%';
        }

        function updateState(newState) {
            userData = { ...userData, ...newState };
            shibBalanceDisplay.textContent = parseFloat(userData.balance).toLocaleString() + ' SHIB';
            updateProgressBars();
            
            if (document.getElementById('withdrawBalanceDisplay')) {
                 document.getElementById('withdrawBalanceDisplay').textContent = parseFloat(userData.balance).toLocaleString() + ' SHIB';
            }
            
            // If tasks are currently being displayed, reload them to update completion status
            if (document.getElementById('taskScreen').classList.contains('visible')) {
                loadTasks();
            }
        }


        // --- API Communication ---

        const API_URL = 'YOUR_VERCEL_API_URL/api'; // âš ï¸ ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ¹Ù„ÙŠ Ù„ÙˆØ§Ø¬Ù‡Ø© Vercel API

        async function fetchApi(body) {
            const dataToSend = {
                initData: tg.initData,
                user_id: userId,
                ...body
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                });

                const data = await response.json();
                
                if (!response.ok) {
                    return { ok: false, error: data.error || 'Server error' };
                }

                return { ok: true, data };
            } catch (error) {
                console.error('API Error:', error);
                return { ok: false, error: 'Network or connection error.' };
            }
        }

        // --- User Data and Initialization ---

        async function loadUserData() {
            if (!userId) return;

            const result = await fetchApi({ type: 'getUserData' });
            
            if (result.ok) {
                userData = result.data.user;
                isBanned = userData.is_banned;
                updateState(userData);
                
                // Set User Info
                document.getElementById('userName').textContent = tg.initDataUnsafe.user?.username ? `@${tg.initDataUnsafe.user.username}` : (tg.initDataUnsafe.user?.first_name || 'User');
                document.getElementById('userId').textContent = `ID: ${userId}`;
            } else {
                // If getUserData fails, try to register the user
                if (result.error.includes('User not found')) {
                    await registerUser();
                } else {
                    showCustomAlert('Error', `Failed to load data: ${result.error}`, 'error');
                }
            }
        }

        async function registerUser() {
            showLoading();
            const result = await fetchApi({
                type: 'register',
                username: tg.initDataUnsafe.user?.username || null,
                referrer_id: getReferrerIdFromInitData()
            });
            hideLoading();

            if (result.ok) {
                userData = result.data.user;
                updateState(userData);
                showCustomAlert('Welcome!', 'Registration complete. Start earning SHIB!', 'success');
            } else {
                showCustomAlert('Error', `Registration failed: ${result.error}`, 'error');
            }
        }
        
        // --- Action ID (Security) ---

        async function requestActionId(actionName) {
            try {
                const result = await fetchApi({ type: 'actionId', action_name: actionName });
                if (result.ok && result.data.action_id) {
                    return result.data.action_id;
                }
                showCustomAlert('Security Error', result.error || 'Failed to get security token. Try again.', 'error');
                return null;
            } catch (error) {
                console.error('Action ID Request Error:', error);
                showCustomAlert('Security Error', 'Failed to communicate with security server.', 'error');
                return null;
            }
        }

        // --- Referral Logic ---

        function getReferrerIdFromInitData() {
            const startParam = tg.initDataUnsafe.start_param;
            if (startParam && !isNaN(parseInt(startParam))) {
                return parseInt(startParam);
            }
            return null;
        }

        function generateReferralLink() {
            const botUsername = 'YOUR_BOT_USERNAME'; // âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø§Ù„Ù€ username Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¨ÙˆØª
            const link = `https://t.me/${botUsername}?start=${userId}`;
            document.getElementById('referralLinkInput').value = link;
            return link;
        }

        function copyReferralLink() {
            const link = generateReferralLink();
            navigator.clipboard.writeText(link).then(() => {
                showCustomAlert('Copied!', 'Referral link copied to clipboard.', 'success');
            }).catch(err => {
                showCustomAlert('Error', 'Failed to copy link. Please copy manually.', 'error');
                console.error('Copy failed', err);
            });
        }
        
        // --- Withdraw Logic ---
        
        function displayWithdrawals() {
            const historyContainer = document.getElementById('withdrawalHistoryContainer');
            historyContainer.innerHTML = ''; // Clear previous data

            if (!userData.withdrawals || userData.withdrawals.length === 0) {
                historyContainer.innerHTML = '<div class="no-records">No withdrawal requests found.</div>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'history-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Amount</th>
                        <th>Binance ID</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            userData.withdrawals.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            userData.withdrawals.forEach(withdrawal => {
                const statusClass = withdrawal.status === 'completed' ? 'status-completed' : 'status-pending';
                const statusText = withdrawal.status === 'completed' ? 'Completed' : 'Pending';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${parseFloat(withdrawal.amount).toLocaleString()}</td>
                    <td>${withdrawal.binance_id}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                `;
                tbody.appendChild(row);
            });

            historyContainer.appendChild(table);
        }

        async function confirmWithdraw() {
            const binanceId = document.getElementById('binanceId').value.trim();
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const minWithdrawal = 400; 

            if (!binanceId) {
                showCustomAlert('Error', 'Binance User ID is required.', 'error');
                return;
            }

            if (isNaN(amount) || amount < minWithdrawal) {
                showCustomAlert('Error', `Minimum withdrawal amount is ${minWithdrawal.toLocaleString()} SHIB.`, 'error');
                return;
            }
            
            if (amount > parseFloat(userData.balance)) {
                showCustomAlert('Error', `Insufficient balance. Your current balance is ${parseFloat(userData.balance).toLocaleString()} SHIB.`, 'error');
                return;
            }
            
            showLoading();

            try {
                // 1. Request Action ID from the Server
                const actionId = await requestActionId('withdraw');
                if (!actionId) {
                    hideLoading();
                    return;
                }

                // 2. Send withdrawal request via API
                const result = await fetchApi({
                    type: 'withdraw',
                    binanceId: binanceId,
                    amount: amount,
                    action_id: actionId 
                });
                
                hideLoading();

                if (result.ok) {
                    // 3. Update balance with trusted server value
                    updateState({ balance: result.data.new_balance });
                    
                    // 4. Reload withdrawal history with new data
                    await loadUserData(); 
                    displayWithdrawals(); 
                    
                    showCustomAlert('Request Sent!', `Details:\nBinance ID: ${binanceId}\nAmount: ${amount.toLocaleString()} SHIB\n\nThe transfer will be processed within 24 hours.`, 'success');
                } else {
                    showCustomAlert('Error', result.error || 'Withdrawal failed. Please check your details.', 'error');
                }
            } catch (error) {
                 hideLoading();
                 showCustomAlert('Error', 'An unexpected error occurred during withdrawal.', 'error');
            }
        }
        
        // --- Spin Wheel Logic --- (Simplified for this update)

        function startSpin() {
            showCustomAlert('Spinning...', 'Spin wheel functionality is currently under development. Please check back later!', 'warning');
        }


        // ------------------------------------------------------------------
        // ğŸŸ¢ NEW/UPDATED: Dynamic Tasks Management Functions
        // ------------------------------------------------------------------
        let availableTasks = []; // Ù„ØªØ®Ø²ÙŠÙ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù„Ù…ÙŠ
        let currentTaskVerification = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„ÙƒÙ„ Ù…Ù‡Ù…Ø© (taskId: intervalId)

        /**
         * Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ¹Ø±Ø¶Ù‡Ø§.
         */
        async function loadTasks() {
            // 1. Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const tasksListContainer = document.getElementById('tasks-list');
            if (tasksListContainer) {
                tasksListContainer.innerHTML = '<p class="loading-message" style="text-align:center; color:#555; margin-top: 20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…...</p>';
            }
            
            // 2. Ø·Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            const result = await fetchApi({ type: 'getTasks' });
            
            if (result.ok && result.data && Array.isArray(result.data.tasks)) {
                availableTasks = result.data.tasks;
                renderTasks(availableTasks);
            } else {
                // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
                if (tasksListContainer) {
                    tasksListContainer.innerHTML = `<p class="loading-message error-message" style="text-align:center; color:#dc3545; margin-top: 20px;">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‡Ø§Ù…: ${result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>`;
                }
            }
            
            // ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¥Ù† ÙˆØ¬Ø¯
            loadUserData(); 
        }

        /**
         * Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
         */
        function renderTasks(tasks) {
            const tasksListContainer = document.getElementById('tasks-list');
            if (!tasksListContainer) return;

            tasksListContainer.innerHTML = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹

            if (tasks.length === 0) {
                tasksListContainer.innerHTML = '<p class="loading-message" style="text-align:center; color:#999; margin-top: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                return;
            }

            tasks.forEach(task => {
                const isCompleted = task.is_completed;
                let buttonText;
                let buttonDisabled = isCompleted ? 'disabled' : '';
                let buttonClass = 'task-action-btn-new';

                if (isCompleted) {
                    buttonText = 'Ù…ÙƒØªÙ…Ù„Ø©'; 
                    buttonClass += ' completed';
                } else if (task.action_state === 'CLAIM') {
                    // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù„Ù… ÙŠØ¹Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø£Ù†Ù‡ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
                    buttonText = 'Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø¥ÙƒÙ…Ø§Ù„';
                    buttonDisabled = '';
                } else {
                    buttonText = 'Ø§Ù†Ø¶Ù…Ø§Ù… ÙˆÙƒØ³Ø¨';
                    buttonDisabled = '';
                }

                const taskItem = document.createElement('div');
                taskItem.className = 'task-item-card'; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ù„ÙÙƒ
                
                taskItem.innerHTML = `
                    <div class="task-text-info">
                        ${task.name} <br>
                        **Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©:** ${parseFloat(task.reward).toLocaleString()} SHIB
                    </div>
                    <button 
                        class="${buttonClass}" 
                        data-task-id="${task.task_id}"
                        data-task-link="${task.link}"
                        data-task-state="${isCompleted ? 'COMPLETED' : 'JOIN'}"
                        onclick="handleTaskButtonClick(this)"
                        ${buttonDisabled}
                    >
                        ${buttonText}
                    </button>
                `;
                tasksListContainer.appendChild(taskItem);
            });
        }


        /**
         * Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¶ØºØ·Ø© Ø²Ø± Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ (ØªÙ†Ù‚Ø³Ù… Ø¥Ù„Ù‰ Ù…Ø±Ø­Ù„ØªÙŠÙ†)
         */
        async function handleTaskButtonClick(buttonElement) {
            const taskId = buttonElement.getAttribute('data-task-id');
            const taskLink = buttonElement.getAttribute('data-task-link');
            let currentState = buttonElement.getAttribute('data-task-state');
            
            if (currentState === 'COMPLETED' || buttonElement.disabled) return; 

            // Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ù†Ø§Ø©
            if (currentState === 'JOIN') {
                buttonElement.disabled = true;
                buttonElement.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...';
                
                // ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·
                try {
                    if (typeof Telegram.WebApp.openTelegramLink === 'function') {
                         Telegram.WebApp.openTelegramLink(taskLink);
                    } else {
                         window.open(taskLink, '_blank');
                    }
                } catch (e) {
                    // ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ openTelegramLink (Ù‚Ø¯ ÙŠØ­Ø¯Ø« ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ¦Ø§Øª)
                    window.open(taskLink, '_blank');
                }
                
                // ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ "Ø§Ù„ØªØ­Ù‚Ù‚" Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø©
                setTimeout(() => {
                    buttonElement.disabled = false;
                    buttonElement.textContent = 'Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø¥ÙƒÙ…Ø§Ù„';
                    buttonElement.setAttribute('data-task-state', 'CLAIM');
                    
                    showCustomAlert('Ø§Ù†Ø¶Ù…Ø§Ù…', 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹. Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø¥ÙƒÙ…Ø§Ù„" Ù„Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©.', 'warning');
                }, 1500);

            // Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø¥ÙƒÙ…Ø§Ù„
            } else if (currentState === 'CLAIM') {
                await startVerificationCountdown(buttonElement, taskId);
            }
        }


        /**
         * ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±.
         */
        async function startVerificationCountdown(buttonElement, taskId) {
            if (currentTaskVerification[taskId]) return; // ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬

            buttonElement.disabled = true; 
            buttonElement.setAttribute('data-task-state', 'PROCESSING');
            
            const countdownTime = 5; 
            let countdown = countdownTime; 
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ù‡Ù…Ø©
            buttonElement.textContent = countdown;
            
            currentTaskVerification[taskId] = setInterval(() => {
                countdown--;
                if (countdown >= 0) {
                    buttonElement.textContent = countdown;
                     // Ø¥Ø¸Ù‡Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ ÙŠÙˆØ¶Ø­ Ø£Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ø¬Ø§Ø±ÙŠØ©
                     // showCustomAlert('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...', `ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${countdown} Ø«ÙˆØ§Ù†Ù Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¶ÙˆÙŠØªÙƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©.`, 'warning');

                } else {
                    // ØªÙˆÙ‚Ù Ø§Ù„Ù…Ø¤Ù‚Øª ÙˆØ§Ù„Ù…Ø¶ÙŠ Ù‚Ø¯Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                    clearInterval(currentTaskVerification[taskId]);
                    delete currentTaskVerification[taskId];
                    buttonElement.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
                    
                    completeTask(buttonElement, taskId);
                }
            }, 1000);
        }

        /**
         * Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© ÙˆØ§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© (Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ).
         */
        async function completeTask(buttonElement, taskId) {
            showLoading();
            
            try {
                // 1. Ø·Ù„Ø¨ Action ID Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                const actionId = await requestActionId(`completeTask_${taskId}`);
                if (!actionId) return;

                // 2. Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ (ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø±Ø³Ø§Ù„ task_id Ù‡Ù†Ø§)
                const result = await fetchApi({
                    type: 'completeTask',
                    task_id: taskId, // ğŸ‘ˆ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù€ task_id
                    action_id: actionId
                });
                
                if (result.ok) {
                    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
                    // updateState will be called inside loadTasks, but we update locally first for responsiveness
                    
                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
                    buttonElement.textContent = 'Ù…ÙƒØªÙ…Ù„Ø©';
                    buttonElement.classList.add('completed');
                    buttonElement.setAttribute('data-task-state', 'COMPLETED');
                    buttonElement.disabled = true;
                    
                    showCustomAlert('ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ğŸ¥³', `Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ ${parseFloat(result.data.actual_reward).toLocaleString()} SHIB.`, 'success');

                } else {
                    // Ø¥Ø°Ø§ ÙØ´Ù„ (Ù…Ø«Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ù†Ø§Ø©)
                    showCustomAlert('ÙØ´Ù„ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„', result.error || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ Ù…Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ "Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©"
                    buttonElement.textContent = 'Ø§Ù†Ø¶Ù…Ø§Ù… ÙˆÙƒØ³Ø¨';
                    buttonElement.setAttribute('data-task-state', 'JOIN');
                }
            } catch (error) {
                console.error('Error completing task:', error);
                showCustomAlert('Ø®Ø·Ø£ ÙÙ†ÙŠ', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©.', 'error');
            } finally {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ ÙÙ‚Ø· (Ø¥Ø°Ø§ Ù†Ø¬Ø­ØŒ ÙŠØ¨Ù‚Ù‰ Ù…Ø¹Ø·Ù„Ø§Ù‹ ÙˆÙ…ÙƒØªÙˆØ¨ Ø¹Ù„ÙŠÙ‡ 'Ù…ÙƒØªÙ…Ù„Ø©')
                if (buttonElement.getAttribute('data-task-state') !== 'COMPLETED') {
                     buttonElement.disabled = false;
                }
                hideLoading();
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§
                await loadTasks(); 
            }
        }
        // ------------------------------------------------------------------
        // âŒ ØªÙ… Ø­Ø°Ù Ø¯Ø§Ù„Ø© handleTaskAction ÙˆØ§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ø£Ø®Ø±Ù‰ Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ù…Ù‡Ø§Ù…
        // ------------------------------------------------------------------


        // --- Initialization ---

        function init() {
            tg.ready();
            tg.expand();

            if (tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
                userId = tg.initDataUnsafe.user.id;
                loadUserData();
                mainScreen.classList.add('visible');
            } else {
                showCustomAlert('Error', 'Telegram User ID not available.', 'error');
            }
            
            // Ensure main screen is shown after initialization
            navigate('mainScreen');
            hideLoading();
        }

        // Final event listener to ensure background audio starts on the first user interaction
        document.addEventListener('click', function handler() {
            playBGAudio();
            document.removeEventListener('click', handler); // Remove after first successful click
        });

        // Initialize the app
        init();
    </script>
</body>
</html>
