<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>SHIB Ads WebApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
<style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap'); 

        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
:root{
            --glass-bg: rgba(255,255,255,0.04);
            --glass-border: rgba(255,255,255,0.12);
            --neon-start: #00f2fe;
            --neon-mid: #7a5cff;
            --neon-end: #ff5aa2;
            --accent: #00bfff;
            --accent-dark: #0077b3;
            --button-depth: rgba(0,0,0,0.45);
            --shadow-deep: 0 18px 40px rgba(0,0,0,0.55);
            --glass-blur: 10px;

            /* Toast specific color tokens (derived to keep app identity) */
            --toast-success: #28a745; /* green */
            --toast-error: #dc3545; /* red */
            --toast-warning: #ff8c00; /* orange */
            --toast-info: #00bfff; /* blue */

            /* Unified primary button gradient */
            --primary-start: #0b86d6;
            --primary-end: #006bb3;
            --primary-shadow: rgba(4,77,135,0.5);
        }

        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Plus Jakarta Sans','Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;overflow:hidden;background: #0d0c1d;color:#111; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}

        html, body{
            touch-action: manipulation;
            -ms-touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
        }
        /* Prevent iOS zoom-on-focus */
        @media (max-width: 768px){
            input, select, textarea{ font-size: 16px !important; }
        }

        
        .app-screen {
            position: fixed;
            inset: 0;
            background: url('https://app.crybblewars.org/main/back_map/map.webp?v=2.0.3.14') no-repeat center center;
            background-size: cover;
            transition: opacity .5s ease-in;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none; 
            z-index: 10; 
        }
        .app-screen.visible {
            opacity: 1;
            pointer-events: auto;
            z-index: 20; 
        }

        /* Loading Screen - 4 dots color spinner */
        .loading-screen {
            position: fixed;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity .5s ease-out;
            background: url('back.png') no-repeat center center;
            background-size: cover; /* use provided image */
        }
        .loading-screen.hidden{opacity:0;pointer-events:none}

        .loading-spinner{
            display:flex;
            flex-direction: column;
            align-items:center;
            justify-content:center;
            gap: 10px;
                    transform: translateY(-15vh);
        }


        /* Bigger circle (badge) above the dots */
        .loading-badge{
            width: 130px;
            height: 130px;
            border-radius: 50%;
            background: url('back2.png') no-repeat center center;
            background-size: cover;
            box-shadow: 0 18px 40px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.14);
            margin-top: -115px;
        }
        .loading-dots{
            display:flex;
            align-items:center;
            justify-content:center;
            gap: 6px;
        }
        .loading-dot{
            width: 14px;
            height: 14px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.75), rgba(255,255,255,0.0) 45%),
                        linear-gradient(145deg, #27d3ff, #0b86d6);
            box-shadow:
              0 0 0 1px rgba(255,255,255,0.10),
              0 10px 22px rgba(11,134,214,0.25),
              0 0 18px rgba(0,191,255,0.55);
            filter: saturate(1.15);
            animation: dotPulse 2.1s infinite ease-in-out;
            transform: translateY(0) scale(0.5);
            opacity: 0.55;
            margin-top: 35px;
            will-change: transform, opacity;
        }
        /* loading dots unified (blue) */
        .loading-dot:nth-child(1){ animation-delay: 0s; }
        .loading-dot:nth-child(2){ animation-delay: 0.25s; }
        .loading-dot:nth-child(3){ animation-delay: 0.50s; }
        .loading-dot:nth-child(4){ animation-delay: 0.75s; }

        @keyframes dotPulse{
            0%, 100% { transform: translateY(0) scale(0.55); opacity: 0.50; }
            45%      { transform: translateY(-3px) scale(1.05); opacity: 1; }
        }
/* End of loading spinner styles */

        /* Main Screen */
        .main-screen{
            background-color: #f0f0f0; 
        }
        
        .main-content{flex:1;display:flex;justify-content:center;align-items:center}
        
        /* User Circle (PRO) */
        .user-circle{
            position:absolute;
            top:12px;
            left:17px;
            width:60px;
            height:60px;
            border:none;
            border-radius:50%;
            display:flex;
            flex-direction:column;
            justify-content:center;
            align-items:center;
            cursor:pointer;
            transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
            z-index:100;
            overflow:hidden;

            /* glass */
            background: rgba(255,255,255,0.06);
            backdrop-filter: blur(10px) saturate(130%);
            -webkit-backdrop-filter: blur(10px) saturate(130%);
            box-shadow: 0 14px 34px rgba(0,0,0,0.40), inset 0 1px 0 rgba(255,255,255,0.16);
        }

        /* Gradient ring (avoids "dashed/cut" look) */
        .user-circle::before{
            content:"";
            position:absolute;
            inset:-1px;
            border-radius:50%;
            padding:2px;
            background: conic-gradient(from 120deg, var(--neon-start), var(--neon-mid), var(--neon-end), var(--neon-start));
            -webkit-mask:
              linear-gradient(#000 0 0) content-box,
              linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events:none;
            opacity: 0.92;
        }
        .user-circle:hover{transform: translateY(-1px) scale(1.02); box-shadow: 0 18px 44px rgba(0,0,0,0.48), inset 0 1px 0 rgba(255,255,255,0.18);} 
        .user-circle:active{transform: translateY(1px) scale(0.995);}

        .user-circle img{width:100%;height:100%;object-fit:cover;border-radius:50%;display:none}
        .user-circle .placeholder{
            width:100%;height:100%;
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight: 900;
            font-size: 18px;
            letter-spacing: 0.2px;
            color: rgba(255,255,255,0.88);
            text-shadow: 0 1px 0 rgba(0,0,0,0.35);
            user-select:none;
        }
        
        .user-username{
            position: absolute;
            top: 74px;
            left: 6px;
            width: 84px;
            font-size:13px;color:#555;white-space:nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-id{
            position: absolute;
            top: 90px;
            left: 6px;
            width: 84px;
            font-size:11px;color:#888;white-space:nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Balance with small image in front (plain image, not inside a circular button) */
        .balance {
            position:absolute;top:20px;right: 3px;
            background:#fff;border:1px solid #ff5a5a;border-radius:12px;padding:8px 12px;font-family:'Inter','Vazirmatn', Arial, Helvetica, sans-serif;font-size:12px;color: grey;text-shadow:0 0 2px #ffbbbb;letter-spacing:1px;z-index:101;box-shadow:0 4px 6px rgba(0,0,0,.05);
            display:flex;align-items:center;gap:8px;
            
        }
        .balance img#shibIcon { width:25px; height:25px; object-fit:cover; display:inline-block; border-radius: 50%; }

        /* Improved balance number typography */
        .balance #shibBalanceText {
            font-family: 'Inter','Orbitron', 'Courier New', monospace;
            font-variant-numeric: tabular-nums;
            font-size: 10px;
            font-weight: 900;
            color: grey;
            letter-spacing: 0.6px;
            text-shadow: 0 1px 0 rgba(255,255,255,0.6);
            -webkit-font-smoothing:antialiased;
        }

        /* Contest button still exists but kept visually separate (we won't rely on it for the SHIB image anymore) */
        .contest-btn-under-balance {
            position: absolute;
            top: 70px;
            right: 20px;
            background: transparent;
            color: #fff;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all .1s ease;
            z-index: 101;
            display:flex;
            align-items:center;
            justify-content:center;
            padding: 0;
            overflow: hidden;
        }
        .contest-btn-under-balance:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 0 var(--primary-shadow), 0 10px 15px rgba(0,0,0,.22);
        }
        .contest-btn-under-balance:active {
            transform: translateY(2px) scale(.98);
            box-shadow: 0 2px 0 var(--primary-shadow), 0 4px 8px rgba(0,0,0,.15);
        }
        .contest-btn-under-balance img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20%;
            display: block;
            pointer-events: none; /* allow click to be handled by button */
        }

        /* ===== PROGRESS GROUP (CENTERED GLASS + NEON STYLING) ===== */
        .progress-group-container {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            width: 100%;
            max-width: 760px;
            padding: 24px;
            pointer-events: none; /* groups shouldn't block interactions beneath them; individual buttons inside will still be interactive if needed */
            z-index: 105;
        }

        /* Card wrapper for each progress bar - glass + neon glow */
        .daily-progress-container, .spin-progress-container {
            pointer-events: auto; /* allow interactions like tooltip if needed */
            width: min(92%, 420px);
            background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
            border-radius: 16px;
            padding: 18px;
            box-shadow:
              0 20px 40px rgba(2,6,23,0.65),
              0 6px 18px rgba(0,0,0,0.5),
              0 0 32px rgba(122,92,255,0.06) inset;
            backdrop-filter: blur(var(--glass-blur)) saturate(120%);
            border: 1px solid rgba(255,255,255,0.06);
            text-align: left;
            transition: transform .35s cubic-bezier(.2,.9,.2,1), box-shadow .35s ease;
            position: relative;
            overflow: visible;
        }

        .daily-progress-container:hover, .spin-progress-container:hover {
            transform: translateY(-6px);
            box-shadow:
              0 30px 70px rgba(2,6,23,0.75),
              0 12px 32px rgba(0,0,0,0.65),
              0 0 48px rgba(122,92,255,0.14) inset;
        }

        /* subtle pulsing neon halo */
        @keyframes neonPulse {
            0% { box-shadow:
                0 18px 40px rgba(2,6,23,0.6),
                0 6px 18px rgba(0,0,0,0.45),
                0 0 18px rgba(0,191,255,0.04) inset; }
            50% { box-shadow:
                0 28px 60px rgba(2,6,23,0.75),
                0 12px 30px rgba(0,0,0,0.6),
                0 0 36px rgba(122,92,255,0.08) inset; }
            100% { box-shadow:
                0 18px 40px rgba(2,6,23,0.6),
                0 6px 18px rgba(0,0,0,0.45),
                0 0 18px rgba(0,191,255,0.04) inset; }
        }
        .daily-progress-container, .spin-progress-container { animation: neonPulse 6.5s ease-in-out infinite; }

        .daily-progress-text, .spin-progress-text {font-size:14px;color:#e6eefb;margin-bottom:8px; font-weight:700; letter-spacing:0.4px;}
        .daily-progress-bar, .spin-progress-bar {
            width:100%;
            height:16px;
            background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.04);
            box-shadow: inset 0 -4px 12px rgba(0,0,0,0.45);
            position: relative;
        }

        /* moving animated gradient fill with glow + sheen */
        .daily-progress-fill, .spin-progress-fill {
            height:100%;
            width:0%;
            border-radius: 999px;
            transition: width .7s cubic-bezier(.2,.9,.25,1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 6px 28px rgba(0,0,0,0.6), 0 0 18px rgba(0,191,255,0.12);
            display:flex; align-items:center; justify-content:center;
        }

        /* different gradients for the two fills for variety yet harmony */
        .daily-progress-fill {
            background: linear-gradient(90deg, var(--neon-start), var(--neon-mid), var(--neon-end));
            background-size: 240% 100%;
            animation: shiftGradient 4.5s linear infinite;
            box-shadow: 0 10px 30px rgba(122,92,255,0.18), 0 0 28px rgba(0,191,255,0.12);
        }
        .spin-progress-fill {
            background: linear-gradient(90deg, #ff9a00, #ff5a5a, #ff2a9a);
            background-size: 220% 100%;
            animation: shiftGradient 3.6s linear infinite reverse;
            box-shadow: 0 10px 30px rgba(255,90,90,0.14), 0 0 28px rgba(255,90,90,0.10);
        }

        /* shimmer sheen */
        .daily-progress-fill::after, .spin-progress-fill::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -40%;
            width: 60%;
            height: 300%;
            background: linear-gradient(120deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.18) 50%, rgba(255,255,255,0.06) 100%);
            transform: rotate(18deg);
            opacity: 0.6;
            pointer-events: none;
            animation: sheenMove 3.2s linear infinite;
            mix-blend-mode: overlay;
        }

        /* animated diagonal stripes overlay to give "ad-progress" vibe */
        .daily-progress-bar::before, .spin-progress-bar::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image: linear-gradient(135deg, rgba(255,255,255,0.03) 25%, rgba(0,0,0,0.02) 25%, rgba(0,0,0,0.02) 50%, rgba(255,255,255,0.03) 50%, rgba(255,255,255,0.03) 75%, rgba(0,0,0,0.02) 75%, rgba(0,0,0,0.02) 100%);
            background-size: 24px 24px;
            pointer-events: none;
            opacity: 0.45;
            mix-blend-mode: overlay;
            animation: stripeMove 6s linear infinite;
        }
        @keyframes stripeMove {
            0% { background-position: 0 0; }
            100% { background-position: 48px 0; }
        }

        @keyframes shiftGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes sheenMove {
            0% { transform: translateX(-120%) rotate(18deg); opacity:0; }
            10% { opacity:0.8; }
            50% { transform: translateX(200%) rotate(18deg); opacity:0.6; }
            90% { opacity:0.0; }
            100% { transform: translateX(200%) rotate(18deg); opacity:0; }
        }

        /* percent label inside fills */
        .progress-percent {
            position: relative;
            z-index: 2;
            font-weight: 900;
            font-size: 12px;
            color: rgba(0,0,0,0.7);
            text-shadow: 0 1px 2px rgba(255,255,255,0.25);
            padding: 0 6px;
            pointer-events: none;
        }

        /* End of progress styling */

        /* Button Adjustments - Equal width for 5 buttons */
        .button-container{
            position:absolute;bottom:40px;left:50%;transform:translateX(-50%);
            display:grid; /* Change to grid for better control */
            grid-template-columns: repeat(5, 1fr); /* 5 equal columns (UPDATED) */
            gap: 8px; /* Slightly reduced gap */
            background: transparent;padding:10px 10px; /* Reduced padding */
            border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,.1);backdrop-filter:blur(10px);
            width: 95%; /* Increased width for more space */
            max-width: 450px;
        }
        /* 3D Elevated Button Base (applied to many button classes below) */
        .nav-button{
            position:relative;display:flex;align-items:center;justify-content:center;
            --btn-h:48px;
            height:var(--btn-h);
            background: linear-gradient(145deg,var(--primary-start),var(--primary-end));
            color:#fff;border:none;padding:10px 0;border-radius:12px;font-size:12px;
            font-weight:900;cursor:pointer;transition:transform .18s cubic-bezier(.2,.9,.2,1), box-shadow .18s ease, filter .18s ease;
            transform-style:preserve-3d;
            box-shadow: var(--shadow-deep), 0 6px 0 var(--primary-shadow), inset 0 -6px 18px rgba(255,255,255,0.02);
            text-transform:uppercase;letter-spacing:.6px;
        }
        .nav-button span{display:block;text-shadow:0 1px 4px rgba(0,0,0,.35)}

        /* Pseudo element to create a realistic "base" for 3D look */
        .nav-button::after {
            content: "";
            position: absolute;
            left: 8%;
            right: 8%;
            bottom: -10px;
            height: 10px;
            background: linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.2));
            border-radius: 8px;
            filter: blur(8px);
            z-index: -1;
            transition: bottom .18s ease, height .18s ease, opacity .18s ease;
            opacity: 0.9;
        }

        .nav-button:hover{
            transform: translateY(-8px) scale(1.02) rotateX(6deg);
            box-shadow: 0 34px 60px rgba(2,6,23,0.8), 0 14px 36px rgba(0,0,0,0.6), 0 0 40px rgba(74,144,226,0.14);
            filter: saturate(1.05);
        }
        .nav-button:active{
            transform: translateY(4px) scale(.985);
            box-shadow: 0 8px 18px rgba(2,6,23,0.6), 0 4px 8px rgba(0,0,0,0.45);
        }
        .nav-button[disabled]{
            opacity:.7; cursor:not-allowed;
            transform:none; box-shadow: 0 6px 12px rgba(0,0,0,0.45);
        }

        .nav-button.task-btn{
            /* keep same unified color but change visual accent */
            box-shadow: var(--shadow-deep), 0 6px 0 rgba(4,77,135,0.6), inset 0 -6px 14px rgba(255,255,255,0.02);
            color: #fff;
        }

        /* NEW Style for Withdraw Nav Button */
        .nav-button.withdraw-btn-nav{
            /* unified look */
            box-shadow: var(--shadow-deep), 0 6px 0 var(--primary-shadow), inset 0 -6px 14px rgba(255,255,255,0.02);
        }
        .nav-button.withdraw-btn-nav:hover{
            box-shadow: 0 34px 60px rgba(2,6,23,0.8), 0 14px 36px rgba(0,0,0,0.62), 0 0 40px rgba(255,42,42,0.16);
        }

        /* Generic 3D for other primary buttons */
        .task-action-btn-new,
        .withdraw-btn,
        .back-btn,
        .copy-link-btn,
        .contest-watch-btn,
        .contest-rank-btn,
        .contest-back-btn,
        .task-back-btn,
        .spin-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 22px;
            border-radius: 12px;
            font-weight: 900;
            cursor: pointer;
            transition: transform .16s cubic-bezier(.2,.9,.2,1), box-shadow .16s ease, filter .16s ease;
            transform-style: preserve-3d;
            color: #fff;
            border: none;
            text-decoration: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 18px 48px rgba(2,6,23,0.6), 0 6px 0 rgba(0,0,0,0.5);
            background: linear-gradient(145deg,var(--primary-start),var(--primary-end));
        }

        .task-action-btn-new {
            color: #fff;
            box-shadow: 0 18px 48px rgba(4,77,135,0.5), 0 6px 0 var(--primary-shadow), inset 0 -6px 12px rgba(255,255,255,0.02);
        }
        .task-action-btn-new:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 32px 68px rgba(40,30,10,0.72); }
        .task-action-btn-new:active { transform: translateY(4px) scale(.99); box-shadow: 0 8px 18px rgba(0,0,0,0.5); }

        .withdraw-btn {
            box-shadow: 0 18px 48px rgba(10,50,20,0.5), 0 6px 0 #1c6d32, inset 0 -6px 12px rgba(255,255,255,0.02);
        }
        .back-btn {
            background: linear-gradient(145deg,#6c757d,#5a6268);
            box-shadow: 0 18px 48px rgba(10,10,10,0.55), 0 6px 0 #4e555b, inset 0 -6px 12px rgba(255,255,255,0.02);
        }
        .copy-link-btn {
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #005a8d;transition:all .1s ease;
            width: 100%; 
        }
        .contest-watch-btn, .contest-rank-btn {
            color: #fff;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 0 #cc3700, 0 8px 15px rgba(0,0,0,.2);
            transition: all .1s ease;
            background: linear-gradient(145deg,var(--primary-start),var(--primary-end));
        }
        .contest-watch-btn.locked { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }
        .contest-watch-btn:hover, .contest-rank-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 0 #005a8d, 0 10px 20px rgba(0,0,0,.25);
        }
        .contest-back-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(145deg, #6c757d, #5a6268);
            color: #fff;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px 0 #4e555b;
            transition: all .1s ease;
            width: 90%;
            max-width: 350px;
            z-index: 1000;
        }
        .contest-back-btn:active {
            transform: translateY(3px) translateX(-50%);
            box-shadow: 0 3px 0 #4e555b;
        }

        /* ===== Task Screen - Professional glass UI ===== */
        .task-screen{
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:flex-start;
            padding-top: 12px;
            padding-bottom: 140px;
            overflow-y:auto;
            background:
              radial-gradient(1000px 700px at 10% 0%, rgba(122,92,255,0.28), transparent 55%),
              radial-gradient(900px 700px at 110% 20%, rgba(255,90,162,0.20), transparent 55%),
              linear-gradient(180deg, rgba(6,12,24,0.92), rgba(5,11,22,0.94));
        }
        .task-header{
            width: 92%;
            max-width: 420px;
            margin: 10px 0 12px;
            padding: 14px 14px;
            border-radius: 18px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            backdrop-filter: blur(10px) saturate(130%);
            -webkit-backdrop-filter: blur(10px) saturate(130%);
            box-shadow: 0 18px 52px rgba(0,0,0,0.36);
            position: sticky;
            top: 10px;
            z-index: 300;
            text-align: left;
        }
        .task-title{
            font-family: 'Orbitron','Inter','Vazirmatn', sans-serif;
            font-size: 18px;
            font-weight: 900;
            color: rgba(255,255,255,0.95);
            letter-spacing: 0.4px;
            margin: 0;
            text-shadow: 0 8px 24px rgba(0,0,0,0.35);
        }

        .task-content-container{
            width: 92%;
            max-width: 420px;
            padding: 0;
        }

        .task-link-container{
            width: 100%;
            max-width: none;
            background: rgba(11,20,42,0.78);
            padding: 12px;
            border-radius: 18px;
            box-shadow: 0 16px 46px rgba(0,0,0,0.34);
            border: 1px solid rgba(255,255,255,0.10);
            margin-bottom: 12px;
            display:flex;
            flex-direction:column;
            gap: 8px;
            align-items: stretch;
            font-size: 13px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .task-link-title{
            font-size: 13px;
            color: rgba(255,255,255,0.88);
            font-weight: 800;
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap: 10px;
        }
        .task-link-progress-bar{
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.10);
            border-radius: 999px;
            overflow:hidden;
            transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
        }

        .task-item-card{
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 16px 44px rgba(0,0,0,0.30);
            margin: 10px 0;
            padding: 14px;
            border-radius: 18px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap: 12px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .task-left{
            display:flex;
            align-items:flex-start;
            gap: 12px;
            min-width: 0;
            flex: 1 1 auto;
        }
        .task-dot{
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.65), rgba(255,255,255,0.0) 45%),
                        linear-gradient(145deg, #27d3ff, #0b86d6);
            box-shadow: 0 10px 22px rgba(11,134,214,0.22), 0 0 16px rgba(0,191,255,0.35);
            flex: 0 0 10px;
            margin-top: 6px;
        }
        .task-text-info{
            display:flex;
            flex-direction:column;
            gap: 6px;
            min-width: 0;
        }
        .task-name{
            color: rgba(255,255,255,0.95);
            font-weight: 900;
            font-size: 14px;
            line-height: 1.25;
            overflow:hidden;
            text-overflow: ellipsis;
        }
        .task-meta{
            display:flex;
            align-items:center;
            gap: 8px;
            flex-wrap: wrap;
            color: rgba(255,255,255,0.70);
            font-size: 12px;
            font-weight: 700;
        }
        .task-reward{
            padding: 5px 10px;
            border-radius: 999px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.88);
            font-weight: 900;
            font-variant-numeric: tabular-nums;
        }

        .task-action-btn-new{
            border: 1px solid rgba(255,255,255,0.16);
            color: rgba(255,255,255,0.95);
            padding: 10px 14px;
            border-radius: 14px;
            cursor:pointer;
            font-size: 13px;
            font-weight: 900;
            min-width: 96px;
            transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
            background: linear-gradient(145deg, var(--primary-start), var(--primary-end));
            box-shadow: 0 10px 26px rgba(0,0,0,0.35);
            letter-spacing: 0.3px;
            text-transform: none;
            white-space: nowrap;
        }
        .task-action-btn-new:hover{transform: translateY(-1px); filter: brightness(1.03);}
        .task-action-btn-new:active{transform: translateY(1px);}
        .task-action-btn-new:disabled{
            opacity: 0.55;
            cursor:not-allowed;
            transform:none;
            box-shadow:none;
            filter:saturate(0.85);
        }
        .task-action-btn-new.completed{
            background: linear-gradient(145deg, #28a745, #1e7e34);
            border-color: rgba(255,255,255,0.14);
            box-shadow: 0 10px 26px rgba(0,0,0,0.30);
        }
        .task-screen .note{ display:none; }

        .no-channel-tasks{
            margin-top: 12px;
            font-size: 13px;
            color: rgba(255,255,255,0.75);
            text-align:center;
            background: rgba(255,255,255,0.06);
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.10);
        }

        /* Back Button Style - fixed at bottom */
        .task-back-btn{
            position: fixed;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 420px;
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.16);
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(10px) saturate(130%);
            -webkit-backdrop-filter: blur(10px) saturate(130%);
            color: rgba(255,255,255,0.92);
            font-size: 15px;
            font-weight: 900;
            padding: 14px 16px;
            cursor:pointer;
            box-shadow: 0 18px 55px rgba(0,0,0,0.40);
            transition: transform .12s ease, filter .12s ease;
            z-index: 1000;
        }
        .task-back-btn:active{ transform: translateX(-50%) translateY(1px); filter: brightness(0.98); }
        
        /* ===== Spin Screen ===== */
        .spin-screen{
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            transition:opacity .3s ease;
        }
        #wheelBox{position:relative;margin-bottom:25px}

        /* Premium idle "breathing" (very subtle) */
        #wheelBox.idle{
            transform-origin:center;
        }
        /* Reduce constant animation to prevent lag on low-end phones */
        @media (prefers-reduced-motion: no-preference){
            .idle{ animation: wheelBreath 14s ease-in-out infinite; }
            #wheelBox.spinning{ animation: none; }
        }
        @media (prefers-reduced-motion: reduce){
            .idle{ animation: none; }
            #wheelBox.spinning{ animation: none; }
        }

        @keyframes wheelBreath{
            0%,100%{ transform: scale(1); }
            50%{ transform: scale(1.002); }
        }

/* Subtle light flash during spin start */
        #wheelBox .spin-light{
            position:absolute;
            inset:0;
            border-radius:50%;
            pointer-events:none;
            opacity:0;
            background: radial-gradient(circle at 30% 20%,
                rgba(255,255,255,0.16),
                rgba(255,255,255,0.00) 55%);
            mix-blend-mode: screen;
            filter: blur(3px);
        }
        #wheelBox.spin-flash .spin-light{
            animation: spinFlash 0.65s ease-out forwards;
        }
        @keyframes spinFlash{
            0%{ opacity:0; }
            18%{ opacity:0.12; }
            100%{ opacity:0; }
        }
        #wheelCanvas{
            border-radius:50%;
            background-color: #fefefe;
            border: 1px solid rgba(255,255,255,0.35);
            /* Premium depth (neutral, no slice color changes) */
            box-shadow:
              0 0 0 10px #eee,
              0 18px 48px rgba(0,0,0,0.50),
              inset 0 2px 2px rgba(255,255,255,0.55),
              inset 0 -14px 22px rgba(0,0,0,0.18);
            transform-origin: center center;
            transition: transform 3.2s cubic-bezier(0.22,0,0.2,1);
            will-change: transform;
        }
        /* Extra visual effect while spinning (neutral, very subtle) */
        #wheelCanvas.spinning {
            filter: drop-shadow(0 10px 18px rgba(0,0,0,0.22));
        }
        .arrow{
            position:absolute;top:-16px;left:50%;transform:translateX(-50%);
            width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;
            border-top:28px solid #ff3366;filter:drop-shadow(0 3px 2px rgba(0,0,0,.3));z-index:10;
        }
        .spin-btn{background:linear-gradient(145deg,var(--primary-start),var(--primary-end));color:#fff;border:none;padding:12px 35px;border-radius:30px;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 6px 0 var(--primary-shadow);transition:all .1s ease}
        .spin-btn:active{transform:translateY(3px);box-shadow:0 3px 0 var(--primary-shadow)}
        .spin-result{display:none !important;}
        .spin-back{margin-top:25px;background:#6c757d;color:#fff;border:none;padding:10px 25px;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;box-shadow:0 4px 0 #5a6268}
        .spin-back:active{transform:translateY(2px);box-shadow:0 2px 0 #5a6268}

                /* ===== Withdraw Screen - Fintech / Web3 Redesign (Mobile First) ===== */
        .withdraw-screen{
            display:flex;
            flex-direction:column;
            align-items:center;
            padding:16px;
            transition:opacity .3s ease;
            overflow-y:auto;
            background:linear-gradient(180deg,#0b1d3a,#08162c);
            background-size:cover;
        }

        .withdraw-container{
            width:100%;
            max-width:420px;
            display:flex;
            flex-direction:column;
            gap:16px;
            padding-bottom:18px;
        }

        /* Banner (keep existing image with.png, scaled down ~35%, no white frame) */
        .withdraw-banner{
            width:100%;
            height:110px;
            background:url(with.png) center/contain no-repeat;
            border-radius: 0;
        }

        /* Soft white card */
        .withdraw-card{
            background:rgba(255,255,255,0.94);
            border-radius:16px;
            box-shadow:0 10px 28px rgba(0,0,0,0.12);
            padding:18px;
        }

        /* Section title */
        .withdraw-section-title{
            color:#e5e7eb;
            font-weight:800;
            font-size:13px;
            margin:2px 2px 0 2px;
        }

        /* Balance Card */
        .withdraw-balance-value{
            font-size:34px;
            font-weight:800;
            letter-spacing:0.4px;
            text-align:center;
            color:#0f172a;
        }
        .withdraw-balance-currency{
            margin-top:4px;
            font-size:13px;
            font-weight:700;
            text-align:center;
            color:#64748b;
        }

        /* Method Selection Cards */
        .withdraw-method-toggle{
            width:100%;
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:12px;
        }

        .method-option{
            background:rgba(255,255,255,0.94);
            border-radius:16px;
            box-shadow:0 10px 28px rgba(0,0,0,0.10);
            padding:14px;
            display:flex;
            align-items:center;
            gap:10px;
            cursor:pointer;
            border:2px solid transparent;
            transition:all .15s ease;
            user-select:none;
        }

        .method-option input{
            position:absolute;
            opacity:0;
            pointer-events:none;
        }

        .method-option .method-icon{
            width:30px;
            height:30px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:20px;
        }

        .method-option .label{
            font-weight:800;
            font-size:13px;
            color:#0f172a;
        }

        .method-option.active{
            border-color:var(--primary-start);
            box-shadow:0 12px 34px rgba(11,134,214,0.22);
        }

        /* Form Card (reuse existing input classes) */
        .input-form-container{
            width:100%;
            max-width:420px;
            background:rgba(255,255,255,0.94);
            padding:18px;
            border-radius:16px;
            box-shadow:0 10px 28px rgba(0,0,0,0.12);
            border:none;
            margin-bottom:0;
        }

        .input-group{
            width:100%;
            margin-bottom:14px;
        }
        .input-group label{
            display:block;
            margin-bottom:6px;
            font-size:13px;
            color:#64748b;
            font-weight:700;
        }
        .input-group input{
            width:100%;
            padding:12px 14px;
            border:1px solid #e5e7eb;
            border-radius:12px;
            font-size:15px;
            transition:border-color .2s ease, box-shadow .2s ease;
            outline:none;
            background:#fff;
        }
        .input-group input:focus{
            border-color:var(--primary-start);
            box-shadow:0 0 0 3px rgba(11,134,214,0.18);
        }

        .withdraw-min-note{
            margin-top:-8px;
            margin-bottom:14px;
            font-size:12px;
            color:#64748b;
        }

        /* Primary / Secondary Buttons */
        .withdraw-btn{
            width:100%;
            background:linear-gradient(145deg,var(--primary-start),var(--primary-end));
            color:#fff;
            border:none;
            padding:14px 18px;
            border-radius:16px;
            font-size:16px;
            font-weight:800;
            cursor:pointer;
            box-shadow:0 12px 30px rgba(11,134,214,0.35);
            transition:transform .1s ease, box-shadow .1s ease, opacity .1s ease;
        }

        /* --- Withdraw UX tweaks (v2) --- */
        .w-actions{
            width:100%;
            display:flex;
            gap:12px;
            margin-top:6px;
        }
        .w-actions .withdraw-btn{flex:1;width:auto}
        .withdraw-btn.w-outline{
            background:linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
            color:#ffffff;
            border:1px solid rgba(255,255,255,0.18);
            box-shadow:0 12px 30px rgba(2,6,23,0.35);
        }
        .withdraw-btn.w-outline:hover{
            transform:translateY(-1px);
            background:linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.08));
        }

        /* Make numbers clearer inside Telegram / mobile */
        #withdrawBalanceDisplay,
        #withdrawAmount,
        .w-meta-pill,
        .w-chip,
        .history-item .amount{
            font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            font-variant-numeric: tabular-nums;
            letter-spacing:0.2px;
            text-shadow:none;
        }
        #withdrawBalanceDisplay{font-weight:800}
        #withdrawAmount{font-weight:700}

        /* Make numbers clearer across the app (Main / Contest / History) */
        #shibBalanceText,
        .contest-ticket-value,
        .prize-value,
        .contest-countdown{
            font-variant-numeric: tabular-nums;
        }

        .withdraw-btn:active{transform:translateY(2px)}
        .withdraw-btn:disabled{
            opacity:0.6;
            box-shadow:none;
            cursor:not-allowed;
        }

        .withdraw-secondary-btn{
            width:100%;
            background:rgba(255,255,255,0.10);
            color:#e5e7eb;
            border:1px solid rgba(255,255,255,0.18);
            padding:12px 18px;
            border-radius:16px;
            font-size:14px;
            font-weight:800;
            cursor:pointer;
            transition:transform .1s ease, background .15s ease;
        }
        .withdraw-secondary-btn:active{transform:translateY(2px)}
        .withdraw-secondary-btn:hover{background:rgba(255,255,255,0.14)}

        /* Info Bar */
        .withdraw-info-bar{
            width:100%;
            display:flex;
            align-items:center;
            gap:10px;
            padding:12px 14px;
            border-radius:16px;
            background:rgba(255,255,255,0.08);
            border:1px solid rgba(255,255,255,0.14);
            color:#e5e7eb;
            font-size:13px;
        }
        .withdraw-info-bar .icon{
            font-size:18px;
            line-height:1;
        }
/* Withdrawal History Table */
        .history-section{
            width: 100%;
            max-width: 400px;
            margin-top: 30px;
            padding: 20px 0;
            border-top: 1px solid #eee;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .history-title{
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 700;
            text-align: center;
        }
        .history-table{
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .history-table th, .history-table td{
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        .history-table th{
            background-color: #f0f4f8;
            color: #4a90e2;
            font-weight: 700;
        }
        .history-table tr:last-child td{
            border-bottom: none;
        }
        .status-pending{color: #ff8c00; font-weight: bold;}
        .status-completed{color: #28a745; font-weight: bold;}
        .no-records{text-align: center; color: #999; padding: 20px;}
        
        /* ===== Invite Screen - (No changes needed) ===== */
        .invite-screen{
            display:flex;flex-direction:column;align-items:center;padding:20px 20px;
            transition:opacity .3s ease;
            overflow-y: auto;
        }
        .invite-header{ 
            text-align: center;
            margin-bottom: 25px;
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .invite-title{ 
             background: url(refal.png) center;
            background-size: cover;
            width: 200px;
            height: 150px;
            padding: 10px; 
            border-radius: 25px;
            border: solid transparent;
            margin-left: 50px;
        }
        .referrals-count-info{
            font-size: 18px;
            color: #333;
            margin-top: 15px;
            font-weight: bold;
            padding: 10px 15px;
            background: #e6f0ff;
            border-radius: 10px;
            border: 1px solid #cce0ff;
            box-shadow: 0 2px 5px rgba(0,0,0,.05);
            width: 100%;
        }
        .invite-buttons{
            width: 100%;
            margin-top: 15px;
        }
        .copy-link-btn{
            background:linear-gradient(145deg,var(--primary-start),var(--primary-end));
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 var(--primary-shadow);transition:all .1s ease;
            width: 100%; 
        }
        .copy-link-btn:active{transform:translateY(3px);box-shadow:0 2px 0 var(--primary-shadow)}
        #referralLinkInput{
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            color: #4a90e2;
            background: #f8f8f8;
            word-break: break-all;
            white-space: normal;
        }
        
        /* Custom Alert Overlay - (left in place but we'll migrate to toast) */
        .custom-alert-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .custom-alert-overlay.visible {
            display: flex;
            opacity: 1;
        }

        /* Custom Alert Box - 3D Pencil Style - SLIGHTLY SMALLER - (left for compatibility but not used for toasts) */
        .custom-alert-box {
            width: 90%;
            max-width: 280px; /* Smaller max width */
            background: #ffffed; /* Off-white paper background */
            border-radius: 15px;
            padding: 20px; /* Reduced padding */
            text-align: center;
            box-shadow: 
                0 8px 15px rgba(0, 0, 0, 0.3), /* Base shadow */
                inset 0 0 10px rgba(0, 0, 0, 0.05); /* Inner light effect */
            border: 3px solid #6b4d32; /* Pencil/Wood border */
            transform: perspective(600px) rotateX(0deg) scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Spring effect */
        }
        .custom-alert-overlay.visible .custom-alert-box {
            transform: perspective(600px) rotateX(0deg) scale(1);
        }

        .alert-title {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 20px; /* Slightly smaller title */
            font-weight: 700;
            color: #4CAF50; 
            margin-bottom: 8px; /* Reduced margin */
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.1); 
            letter-spacing: 0.5px;
        }

        .alert-message {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 13px; /* Slightly smaller message */
            color: #333; 
            margin-bottom: 18px; /* Reduced margin */
            white-space: pre-wrap; 
        }

        .alert-icon {
            font-size: 35px; /* Slightly smaller icon */
            margin-bottom: 12px;
        }
        .alert-icon::before {
            content: '‚≠ê';
        }

        .alert-close-btn {
            background: #6b4d32; 
            color: #fff;
            border: none;
            padding: 9px 18px; /* Slightly smaller button */
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #543b27;
            transition: all 0.1s ease;
        }
        .alert-close-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #543b27;
        }

        /* Specific styles for Success */
        .custom-alert-box.success .alert-title { color: #28a745; }
        .custom-alert-box.success .alert-icon::before { content: 'üéÆ'; }

        /* Specific styles for Error/Warning */
        .custom-alert-box.error .alert-title { color: #dc3545; }
        .custom-alert-box.error .alert-icon::before { content: 'üîî'; }

        /* Specific styles for Warning/Info - Using Yellow/Brown for Pencil/Paper Theme */
        .custom-alert-box.warning .alert-title { color: #8B4513; } /* Brown */
        .custom-alert-box.warning .alert-icon::before { content: '‚úçÔ∏è'; } /* Pencil/Writing Icon */

        /* ===== Task Link Progress (COMPACT) ===== */
        /* NOTE: Base layout colors are aligned with the new Task glass UI */
        .task-link-container {
            width: 100%;
            max-width: none;
            background: rgba(11,20,42,0.78);
            padding: 12px;
            border-radius: 18px;
            box-shadow: 0 16px 46px rgba(0,0,0,0.34);
            border: 1px solid rgba(255,255,255,0.10);
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
            font-size: 13px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .task-link-title {
            font-size: 13px;
            color: rgba(255,255,255,0.88);
            font-weight: 800;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .task-link-progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.10);
            border-radius: 999px;
            overflow: hidden;
        }
        .task-link-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg,#ff9a00,#ff5a5a);
            border-radius: 8px;
            transition: width .4s ease;
        }

        /* 3D push button style for task link - smaller */
        .task-link-button {
            margin-top: 6px;
            align-self: center;
            background: linear-gradient(145deg,#ff7a7a,#ff3b3b);
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 0 #b02323, 0 12px 30px rgba(0,0,0,0.12);
            transform: translateY(0);
            transition: all .12s ease;
            letter-spacing: 0.4px;
            text-transform: none;
        }
        .task-link-button:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #b02323, 0 10px 25px rgba(0,0,0,0.10);
        }
        .task-link-button[disabled] {
            background: #ddd;
            color: #888;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        /* small helper text removed to keep it minimal as requested */
        .task-link-small {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .no-channel-tasks {
            margin-top: 12px;
            font-size: 13px;
            color: rgba(255,255,255,0.75);
            text-align: center;
            background: rgba(255,255,255,0.06);
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.10);
        }

        /* ===== Withdraw method toggle ===== */
        .withdraw-method-toggle {
            display:flex;
            gap:8px;
            background:#fff;padding:8px;border-radius:12px;border:1px solid #eee;
            align-items:center;justify-content:center;width:100%;
        }
        .method-option {
            display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;cursor:pointer;border:1px solid transparent;
            transition:all .12s ease;
            background:linear-gradient(180deg,#fafafa,#fff);
        }
        .method-option input{display:none}
        .method-option.active{border-color:#ff8c00;box-shadow:0 6px 0 rgba(255,140,0,0.12)}
        .method-option .label {font-weight:700;color:#333;font-size:14px}

        /* ===== Fullscreen withdrawal history page ===== */
        .withdraw-history-full {
            display:flex;flex-direction:column;padding:20px 20px;overflow-y:auto;background:#fff;
  padding-bottom: 96px;
}
        .withdraw-history-header {
            display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px;
        }
        .history-list {
            width:100%;max-width:720px;margin:0 auto;padding-bottom:40px;
        }
        .history-item {
            display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:#f8f8f8;margin-bottom:10px;border:1px solid #eee;
        }
        .history-item .left {display:flex;flex-direction:column;gap:6px}
        .history-item .right {text-align:right}
        .history-item .amount {font-weight:800;color:#ff2a2a}
        .history-empty {text-align:center;color:#777;padding:30px}

        /* ===== Contest Button under Balance (UPDATED TO 45x45 CIRCLE) ===== */
        /* (Now uses an image inside the circular button; styles above) */

        /* ===== Contest Screen Styles (UPDATED LAYOUT) ===== */
        .contest-screen{
            display:flex;
            flex-direction:column;
            align-items:center;
            padding: 18px 14px 96px;
            overflow-y:auto;
            color:#fff;
            position:relative;
            background:
              radial-gradient(1200px 800px at 15% 0%, rgba(0,191,255,0.20), transparent 55%),
              radial-gradient(1000px 700px at 110% 20%, rgba(255,90,162,0.16), transparent 55%),
              linear-gradient(135deg, #07162f, #061029 55%, #060b1f);
        }

        .contest-header{
            width:100%;
            max-width: 460px;
            display:flex;
            flex-direction:column;
            gap:14px;
        }

        .contest-hero{
            position:relative;
            padding: 14px 14px 12px;
            border-radius: 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.10);
            backdrop-filter: blur(10px) saturate(130%);
            -webkit-backdrop-filter: blur(10px) saturate(130%);
            box-shadow: 0 18px 50px rgba(0,0,0,0.35);
            overflow:hidden;
        }
        .contest-hero::before{
            content:"";
            position:absolute;
            inset:-1px;
            border-radius: 16px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(0,242,254,0.65), rgba(122,92,255,0.55), rgba(255,90,162,0.55));
            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events:none;
            opacity:0.85;
        }

        .contest-hero-top{
            display:flex;
            align-items:flex-start;
            justify-content:space-between;
            gap: 10px;
        }

        .contest-title{
            font-family:'Orbitron','Inter','Vazirmatn', sans-serif;
            font-size: 24px;
            font-weight: 900;
            letter-spacing: 0.4px;
            margin: 0;
            color: rgba(255,255,255,0.96);
            text-shadow: 0 10px 26px rgba(0,0,0,0.40);
        }

        .contest-badge{
            flex: 0 0 auto;
            font-weight: 900;
            font-size: 11px;
            letter-spacing: 0.8px;
            padding: 8px 10px;
            border-radius: 999px;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.90);
            text-transform: uppercase;
            white-space: nowrap;
        }

        .contest-meta{
            margin-top: 10px;
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .meta-pill{
            border-radius: 14px;
            padding: 10px 10px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.10);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
            display:flex;
            flex-direction:column;
            gap: 6px;
            align-items:flex-start;
            min-width: 0;
        }

        .meta-label{
            font-size: 12px;
            font-weight: 800;
            color: rgba(255,255,255,0.70);
            letter-spacing: 0.2px;
        }

        .meta-value,
        .contest-countdown{
            font-size: 16px;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255,215,0,0.22);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Prize list */
        .prize-vertical-box{
            display:flex;
            flex-direction:column;
            gap: 10px;
            padding: 12px;
            border-radius: 16px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.10);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 18px 50px rgba(0,0,0,0.30);
        }

        .prize-item{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 10px;
            padding: 12px 12px;
            border-radius: 14px;
            background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.10);
            overflow:hidden;
        }
        .prize-item:hover{
            transform: translateY(-2px);
            box-shadow: 0 16px 34px rgba(0,0,0,0.22);
        }

        .prize-item.prize-top{
            border-color: rgba(255,215,0,0.22);
            box-shadow: 0 22px 55px rgba(255,215,0,0.06), 0 18px 50px rgba(0,0,0,0.28);
            background: linear-gradient(180deg, rgba(255,215,0,0.10), rgba(255,255,255,0.03));
        }
        .prize-item.prize-second{
            border-color: rgba(192,192,192,0.22);
            background: linear-gradient(180deg, rgba(210,210,210,0.08), rgba(255,255,255,0.02));
        }

        .prize-left{
            display:flex;
            align-items:center;
            gap: 10px;
            min-width: 0;
        }
        .prize-medal{
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display:flex;
            align-items:center;
            justify-content:center;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.14);
            box-shadow: 0 10px 24px rgba(0,0,0,0.25);
            flex: 0 0 36px;
            font-size: 18px;
        }
        .prize-text{
            display:flex;
            flex-direction:column;
            gap: 3px;
            min-width: 0;
        }
        .prize-label{
            font-weight: 900;
            font-size: 14px;
            color: rgba(255,255,255,0.95);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .prize-sub{
            font-size: 12px;
            font-weight: 800;
            color: rgba(255,255,255,0.68);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .prize-amount{
            display:flex;
            align-items:baseline;
            gap: 6px;
            flex: 0 0 auto;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
        }
        .prize-value{
            font-size: 18px;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255,215,0,0.18);
        }
        .prize-unit{
            font-size: 12px;
            color: rgba(255,255,255,0.75);
            letter-spacing: 0.4px;
        }

        /* Tickets container */
        .contest-tickets-container{
            width: 100%;
            max-width: 460px;
            margin-top: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255,255,255,0.10);
            padding: 12px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display:flex;
            gap: 12px;
            align-items:center;
            justify-content:space-between;
            box-shadow: 0 18px 50px rgba(0,0,0,0.25);
        }
        .contest-ticket-row{
            display:flex;
            flex-direction:column;
            gap: 6px;
            min-width: 0;
        }
        .contest-ticket-label{
            font-size: 12px;
            font-weight: 800;
            color: rgba(255,255,255,0.75);
            display:flex;
            align-items:center;
            gap: 6px;
        }
        .contest-ticket-value{
            font-size: 16px;
            font-weight: 900;
            color: rgba(255,255,255,0.95);
            white-space: nowrap;
            overflow:hidden;
            text-overflow: ellipsis;
        }

        .contest-buttons-horizontal{
            display:flex;
            gap: 10px;
            justify-content:center;
            margin-top: 14px;
        }

        .contest-watch-btn, .contest-rank-btn{
            background: linear-gradient(145deg,var(--primary-start),var(--primary-end));
            color:#fff;
            border:none;
            padding: 12px 18px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 900;
            cursor:pointer;
            box-shadow: 0 6px 0 var(--primary-shadow), 0 16px 34px rgba(0,0,0,.28);
            transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
            white-space: nowrap;
        }
        .contest-watch-btn.locked{opacity:0.6;cursor:not-allowed;box-shadow:none;transform:none}
        .contest-watch-btn:hover, .contest-rank-btn:hover{transform:translateY(-2px);filter:saturate(1.05)}
        .contest-watch-btn:active, .contest-rank-btn:active{transform:translateY(2px);box-shadow: 0 4px 0 var(--primary-shadow), 0 10px 22px rgba(0,0,0,.22);}

        .contest-back-btn{
            position: fixed;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 420px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.14);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: rgba(255,255,255,0.92);
            padding: 14px 16px;
            border-radius: 18px;
            font-size: 15px;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 18px 55px rgba(0,0,0,0.40);
            z-index: 1000;
        }
        .contest-back-btn:active{
            transform: translateX(-50%) translateY(1px);
            filter: brightness(0.98);
        }

        @media (max-width: 360px){
            .contest-title{font-size:22px}
            .contest-badge{font-size:10px}
            .meta-value, .contest-countdown{font-size:15px}
            .prize-value{font-size:17px}
        }

/* ===== Contest Ranking Screen ===== */
        .contest-rank-screen {
            display: flex;
            flex-direction: column;
            padding: 14px;
            overflow-y: auto;
            background: linear-gradient(135deg, #001f3f, #003366);
            color: #fff;
            align-items:center;
        }
        .contest-rank-header {
            display: flex;
            justify-content:space-between;
            align-items:center;
            gap: 10px;
            width: 100%;
            max-width: 720px;
            margin-bottom: 12px;
        }
        .contest-rank-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            color: #00bfff;
            font-weight: 700;
            text-shadow: 0 0 8px #00bfff;
        }
        .contest-rank-list {
            width: 100%;
            max-width: 720px;
            margin: 0 auto;
            padding-bottom: 40px;
            box-sizing: border-box;
        }

        /* NEW: Personal user info box (golden) - placed inside ranking page for visibility */
        .personal-info-box {
            width: 100%;
            max-width: 720px;
            background: linear-gradient(90deg, #2b2a2a 0%, rgba(255, 215, 0, 0.06) 100%);
            border: 2px solid rgba(255, 215, 0, 0.25);
            border-radius: 12px;
            padding: 10px 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 30px rgba(255,215,0,0.06), inset 0 0 12px rgba(255,215,0,0.02);
            color: #fff;
            background-color: rgba(32,24,12,0.12);
        }
        .personal-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            flex: 0 0 64px;
            border: 2px solid rgba(255,215,0,0.9);
            background: #fff;
        }
        .personal-info-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex: 1 1 auto;
        }
        .personal-id, .personal-username, .personal-tickets, .personal-rank {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 0;
        }
        .personal-id .label, .personal-username .label, .personal-tickets .label, .personal-rank .label {
            font-size: 12px;
            color: rgba(255,255,255,0.75);
            font-weight: 700;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: .6px;
        }
        .personal-id .value, .personal-username .value, .personal-tickets .value, .personal-rank .value {
            font-size: 16px;
            font-weight: 900;
            color: #ffd700;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 220px;
        }
        /* Ensure username sits visually centered between id and tickets */
        .personal-username .value {
            color: #fff;
            font-size: 18px;
            letter-spacing: .3px;
            color: #ffd700;
        }

        /* NEW: make golden box stand out on small screens */
        @media (max-width:720px) {
            .personal-info-box { padding: 8px; gap: 10px; }
            .personal-avatar { width:56px; height:56px; flex:0 0 56px; }
            .personal-id .value, .personal-username .value, .personal-tickets .value { font-size: 15px; }
            .personal-username .value { font-size: 16px; }
            .contest-rank-list { padding: 6px; }
        }

        /* NEW: Ranking row styles to satisfy layout requirements */
        .contest-rank-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.03);
            margin-bottom: 10px;
            backdrop-filter: blur(6px);
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }
        .contest-rank-item:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0,0,0,0.25); }

        /* fixed-size circular avatar to avoid layout shifts */
        .contest-rank-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            flex: 0 0 56px;
            border: 2px solid rgba(255,255,255,0.06);
            background: #ffffff;
        }

        /* Name column: show first_name, add 'You' note if current */
        /* Make the name flexible so userid and tickets can have fixed space to show full values */
        .contest-rank-name {
            font-size: 14px; /* slightly smaller to allow more room */
            font-weight: 800;
            color: #e6f7ff;
            white-space: nowrap; /* keep single line */
            overflow: hidden; /* allow truncation only if absolutely necessary */
            text-overflow: ellipsis;
            min-width: 0;
            flex: 1 1 auto; /* flexible, take remaining space */
            max-width: none; /* remove previous max-width to allow the layout to decide */
            display:flex;
            flex-direction:column;
            gap:2px;
        }
        .contest-rank-name .name-main { font-weight:900; color:#e6f7ff; }
        .contest-rank-username { font-size:12px; color: rgba(255,255,255,0.7); font-weight:700; letter-spacing:0.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

        /* user id column - reserve fixed width so the id can display fully */
        .contest-rank-userid {
            font-size: 13px; /* slightly smaller as requested */
            color: #cfeeff;
            white-space: nowrap;
            overflow: visible; /* allow full display */
            text-overflow: clip;
            flex: 0 0 120px; /* fixed width to ensure full id visibility */
            max-width: 120px;
            text-align: left;
        }

        /* tickets - reserve fixed width and slightly smaller font so full ticket numbers like "400" display without truncation */
        .contest-rank-tickets {
            font-size: 14px; /* slightly reduced */
            font-weight: 900;
            color: #ffd700;
            white-space: nowrap;
            overflow: visible; /* show full number */
            text-overflow: clip;
            text-align: right;
            flex: 0 0 110px; /* fixed width for tickets column */
            max-width: 110px;
            margin-left: 8px;
        }

        /* position (rank) shown at the far right */
        .contest-rank-position {
            font-size: 16px;
            font-weight: 700;
            color: #00bfff;
            width: 44px;
            text-align: center;
            flex: 0 0 44px;
        }

        /* Highlight current user row without changing order/position */
        .contest-rank-item.current-player {
            border: 1px solid rgba(255,215,0,0.12);
            background: linear-gradient(90deg, rgba(255,215,0,0.03), rgba(0,191,255,0.01));
            box-shadow: 0 8px 20px rgba(0,191,255,0.04);
        }
        .contest-rank-item.current-player .contest-rank-name { color: #ffd700; }
        .contest-rank-item.current-player .contest-rank-tickets { color: #ffd700; font-weight:900; }

        /* ensure the whole UI never produces horizontal scroll */
        html, body { max-width:100%; overflow-x:hidden; }

        /* Hide top user info when ranking screen is active (added/removed via body class) */
        .hide-top-user .user-circle,
        .hide-top-user #userName,
        .hide-top-user #userId {
            display: none !important;
        }

        /* Make ranking list responsive and prevent horizontal overflow */
        @media (max-width: 420px) {
            .contest-rank-name { font-size: 13px; }
            .contest-rank-userid { flex: 0 0 90px; max-width: 90px; font-size: 12px; }
            .contest-rank-tickets { flex: 0 0 80px; max-width: 80px; font-size: 13px; }
            .contest-rank-position { width: 40px; flex: 0 0 40px; }
            .contest-rank-avatar { width: 48px; height: 48px; flex: 0 0 48px; }
            .personal-avatar { width:48px; height:48px; flex:0 0 48px; }
            .progress-group-container { padding: 12px; gap: 12px; }
            .daily-progress-container, .spin-progress-container { width: 100%; padding: 14px; border-radius: 14px; }
            .daily-progress-text, .spin-progress-text { font-size:13px; }
            .daily-progress-bar, .spin-progress-bar { height: 12px; }
        }

        /* ===== Ticket image smaller per request ===== */
        .contest-ticket-img {
            width: 26px;
            height: 26px;
            object-fit: cover;
            display: inline-block;
        }

        /* =========================
           NEW: Toast Notification CSS (IMPROVED CONTRAST & SIZE)
           Glassmorphism + Top Toast, larger, more legible, contains multi-line details
           ========================= */

        .toast-container {
            position: fixed;
            top: 14px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            width: 100%;
            max-width: 720px;
            padding: 8px;
            z-index: 1000000; /* very high to be above UI but non-blocking */
            pointer-events: none; /* do not block interactions */
        }

        /* Larger, higher-contrast black notification */
        .toast {
            pointer-events: none;
            width: calc(100% - 32px);
            max-width: 700px;
            display: flex;
            align-items: center;
            gap: 14px;
            background: #000; /* solid black for max contrast as requested */
            border-radius: 14px;
            padding: 14px 16px; /* increased padding */
            color: #fff; /* white text */
            box-shadow: 0 12px 40px rgba(0,0,0,0.6);
            backdrop-filter: blur(6px) saturate(120%);
            border: 1px solid rgba(255,255,255,0.06);
            transform-origin: top center;
            opacity: 0;
            transform: translateY(-12px) scale(0.995);
            font-family: 'Vazirmatn', sans-serif;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            will-change: transform, opacity;
        }

        .toast.show {
            animation: toastIn 320ms cubic-bezier(.2,.9,.2,1) forwards;
        }
        .toast.hide {
            animation: toastOut 260ms cubic-bezier(.2,.9,.2,1) forwards;
        }

        /* Content layout */
        .toast .toast-icon {
            flex: 0 0 52px;
            width: 52px;
            height: 52px;
            border-radius: 12px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:22px;
            background: #111; /* darker tile for icon as requested */
            color: #fff;
            box-shadow: inset 0 -2px 6px rgba(0,0,0,0.2);
        }
        .toast .toast-content {
            display:flex;
            flex-direction:column;
            gap:6px;
            min-width: 0;
        }
        .toast .toast-title {
            font-weight: 900;
            font-size: 16px; /* increased size */
            color: #ffffff;
            line-height: 1.05;
            white-space:normal;
            font-family: 'Orbitron', 'Vazirmatn', sans-serif; /* stronger numeric-friendly font */
        }
        .toast .toast-message {
            font-size: 14px; /* increased size */
            color: rgba(255,255,255,0.95);
            line-height: 1.25;
            max-height: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: pre-wrap;
            font-weight: 700;
        }

        /* Type accents are still preserved by border-left */
        .toast--success { border-left: 6px solid var(--toast-success); }
        .toast--error   { border-left: 6px solid var(--toast-error);   }
        .toast--warning { border-left: 6px solid var(--toast-warning); }
        .toast--info    { border-left: 6px solid var(--toast-info);    }

        /* Entrance / Exit animations */
        @keyframes toastIn {
            0% { opacity: 0; transform: translateY(-14px) scale(.995); }
            60% { opacity: 1; transform: translateY(8px) scale(1.02); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toastOut {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-12px) scale(.995); }
        }

        /* Error shake animation (subtle) */
        @keyframes toastShake {
            0% { transform: translateX(0); }
            15% { transform: translateX(-6px); }
            30% { transform: translateX(6px); }
            45% { transform: translateX(-4px); }
            60% { transform: translateX(4px); }
            75% { transform: translateX(-2px); }
            100% { transform: translateX(0); }
        }

        .toast--error.shake {
            animation: toastIn 260ms cubic-bezier(.2,.9,.2,1) forwards, toastShake 420ms ease-in-out 0ms;
        }

        /* Small screens tweak */
        @media (max-width: 480px) {
            .toast { padding: 10px 12px; border-radius: 10px; max-width: calc(100% - 24px); gap: 10px; }
            .toast .toast-icon { width: 44px; height: 44px; font-size:18px; border-radius:10px; }
            .toast .toast-title { font-size:15px; }
            .toast .toast-message { font-size:13px; }
            .toast-container { top: 8px; gap:8px; padding: 4px; }
        }

        /* small helper to visually hide old overlay (we won't use it anymore but keep DOM for compatibility) */
        .custom-alert-overlay { display: none !important; opacity: 0 !important; pointer-events: none !important; }

    

        /* ============================
           Invite Screen (v3 / EN / solid)
           ============================ */
        .invite-screen{
            display:flex;
            flex-direction:column;
            align-items:stretch;
            padding: 16px 16px 26px;
            overflow-y:auto;
            background:
                radial-gradient(900px 500px at 10% 10%, rgba(0,242,254,0.18), rgba(0,0,0,0) 60%),
                radial-gradient(900px 500px at 90% 20%, rgba(255,90,162,0.14), rgba(0,0,0,0) 60%),
                linear-gradient(180deg, #0b1220 0%, #070b13 100%);
        }
        .invite-screen *{ box-sizing: border-box; }
        .invite-shell{
            width:100%;
            max-width: 460px;
            margin: 0 auto;
            display:flex;
            flex-direction:column;
            gap: 14px;
            position: relative;
            z-index: 1;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        }

        .invite-topbar{
            display:flex;
            align-items:center;
            gap: 12px;
            padding: 6px 2px;
        }
        .invite-back-icon{
            width: 44px;
            height: 44px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.14);
            background: #0f1a2b;
            color: #fff;
            font-size: 18px;
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow: 0 10px 22px rgba(0,0,0,0.38);
            transition: transform .15s ease, filter .15s ease;
        }
        .invite-back-icon:active{ transform: translateY(1px) scale(0.99); }
        .invite-topbar-title{ display:flex; flex-direction:column; line-height:1.1; }
        .invite-topbar-kicker{
            font-size: 12px;
            letter-spacing: .18em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.62);
        }
        .invite-topbar-headline{
            font-size: 18px;
            font-weight: 800;
            color: #fff;
        }

        .invite-hero-card{
            display:flex;
            gap: 14px;
            padding: 14px;
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.12);
            background: linear-gradient(180deg, #0f1a2b 0%, #0b1424 100%);
            box-shadow: 0 18px 40px rgba(0,0,0,0.45);
            position: relative;
            overflow:hidden;
        }
        .invite-hero-card::after{
            content:"";
            position:absolute;
            inset:-2px;
            background: radial-gradient(420px 240px at 20% 20%, rgba(0,242,254,0.12), rgba(0,0,0,0) 65%),
                        radial-gradient(420px 240px at 80% 10%, rgba(122,92,255,0.12), rgba(0,0,0,0) 65%);
            pointer-events:none;
        }
        .invite-hero-art{
            width: 92px;
            height: 76px;
            border-radius: 16px;
            background: url(refal.png) center/cover no-repeat, linear-gradient(135deg, #00f2fe 0%, #7a5cff 45%, #ff5aa2 100%);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.18), 0 14px 28px rgba(0,0,0,0.35);
            flex: 0 0 auto;
            position: relative;
            z-index: 1;
        }
        .invite-hero-text{ position:relative; z-index:1; }
        .invite-hero-title{
            font-size: 18px;
            font-weight: 900;
            color:#fff;
        }
        .invite-hero-sub{
            margin-top: 6px;
            font-size: 13px;
            color: rgba(255,255,255,0.78);
            line-height: 1.35;
        }
        .invite-hero-sub strong{ color:#fff; font-weight: 900; }

        .invite-stats{
            display:grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
        }
        .invite-stat{
            padding: 12px 12px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.10);
            background: #0f1a2b;
            box-shadow: 0 14px 30px rgba(0,0,0,0.35);
        }
        .invite-stat .label{
            font-size: 11px;
            letter-spacing: .12em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.60);
        }
        .invite-stat .value{
            margin-top: 6px;
            font-size: 18px;
            font-weight: 900;
            color: #fff;
        }
        .pill{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 800;
            background: linear-gradient(135deg, #00f2fe 0%, #7a5cff 55%, #ff5aa2 100%);
            color: #0b1220;
        }

        .invite-link-card,
        .invite-note-card{
            padding: 14px;
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.12);
            background: #0f1a2b;
            box-shadow: 0 18px 40px rgba(0,0,0,0.45);
        }
        .invite-link-label{
            font-size: 12px;
            letter-spacing: .14em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.68);
            margin-bottom: 10px;
        }
        .invite-link-row{
            display:flex;
            gap: 10px;
            align-items:center;
        }
        .invite-link-input{
            width:100%;
            height: 46px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.12);
            background: #0b1424;
            color: #fff;
            padding: 0 12px;
            font-size: 13px;
            outline: none;
        }
        .invite-mini-btn{
            height: 46px;
            padding: 0 14px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.14);
            background: #14213a;
            color: #fff;
            font-weight: 800;
            box-shadow: 0 14px 28px rgba(0,0,0,0.35);
            transition: transform .15s ease;
            white-space: nowrap;
        }
        .invite-mini-btn:active{ transform: translateY(1px) scale(0.99); }

        .invite-actions{
            display:flex;
            gap: 10px;
            margin-top: 12px;
        }
        .invite-primary-btn{
            flex: 1 1 auto;
            height: 48px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(135deg, #00f2fe 0%, #7a5cff 55%, #ff5aa2 100%);
            color: #0b1220;
            font-weight: 900;
            letter-spacing: .02em;
            box-shadow: 0 18px 34px rgba(0,0,0,0.45);
            transition: transform .15s ease, filter .15s ease;
        }
        .invite-primary-btn:active{ transform: translateY(1px) scale(0.99); }

        .invite-ghost-btn{
            flex: 0 0 auto;
            height: 48px;
            padding: 0 14px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.14);
            background: #0b1424;
            color: #fff;
            font-weight: 800;
        }

        .invite-hint{
            margin-top: 10px;
            font-size: 12px;
            color: rgba(255,255,255,0.72);
            line-height: 1.35;
        }

        .invite-note-title{
            font-size: 14px;
            font-weight: 900;
            color: #fff;
            margin-bottom: 10px;
        }
        .invite-note-list{
            margin: 0;
            padding-left: 18px;
            color: rgba(255,255,255,0.80);
            font-size: 13px;
            line-height: 1.45;
        }
        .invite-note-list li{ margin: 6px 0; }

        .invite-back-btn{
            background: #0f1a2b !important;
            border: 1px solid rgba(255,255,255,0.14) !important;
            color: #fff !important;
            border-radius: 18px !important;
            box-shadow: 0 18px 40px rgba(0,0,0,0.45) !important;
        }

        @media (max-width: 360px){
            .invite-stats{ grid-template-columns: 1fr; }
        }



/* ===== Withdraw Page: Ultra Pro Upgrade (2026) ===== */
.withdraw-screen{
  background: radial-gradient(1200px 800px at 20% -10%, rgba(122,92,255,0.45), transparent 55%),
              radial-gradient(900px 700px at 110% 10%, rgba(255,90,162,0.35), transparent 55%),
              linear-gradient(180deg, #060c18 0%, #070f22 50%, #050b16 100%);
  padding: 18px 16px 26px;
}

.withdraw-container{max-width:460px; gap:14px;}

.w-hero{
  background: linear-gradient(180deg, #0c1630 0%, #0a1328 100%);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 22px;
  padding: 16px 16px 14px;
  box-shadow: 0 18px 55px rgba(0,0,0,0.38);
}
.w-hero-top{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
.w-badge{
  display:inline-flex; align-items:center; gap:8px;
  font-weight:800; letter-spacing:.3px; font-size:12px;
  color: rgba(255,255,255,0.86);
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.10);
  padding: 8px 10px;
  border-radius: 999px;
}
.w-icon-btn{
  width:38px; height:38px; border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.92);
  cursor:pointer;
  transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
}
.w-icon-btn:active{transform: translateY(1px);}
.w-hero-title{
  font-family: 'Orbitron', sans-serif;
  font-size: 22px;
  color: rgba(255,255,255,0.95);
  letter-spacing: .2px;
  margin-bottom: 6px;
}
.w-hero-sub{
  color: rgba(255,255,255,0.72);
  font-size: 13px;
  line-height: 1.45;
}

.w-balance-card{
  background: #0b142a;
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 22px;
  padding: 16px;
  box-shadow: 0 16px 45px rgba(0,0,0,0.35);
}
.w-balance-label{color: rgba(255,255,255,0.68); font-size: 12px; font-weight: 700;}
.w-balance-row{display:flex; align-items:baseline; gap:10px; margin-top:8px;}
.w-balance-value{
  font-family: 'Orbitron', sans-serif;
  font-size: 34px;
  color: rgba(255,255,255,0.98);
  letter-spacing: .4px;
}
.w-balance-unit{color: rgba(255,255,255,0.72); font-weight:800; font-size: 12px; letter-spacing:.5px;}
.w-balance-meta{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;}
.w-meta-pill{
  color: rgba(255,255,255,0.78);
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  padding: 7px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 700;
}

.w-panel{
  background: #0b142a;
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 22px;
  padding: 14px;
  box-shadow: 0 16px 45px rgba(0,0,0,0.30);
}
.w-panel-head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
.w-panel-title{
  color: rgba(255,255,255,0.92);
  font-weight: 900;
  font-size: 13px;
  letter-spacing: .2px;
  margin-bottom: 10px;
}
.w-panel-head .w-panel-title{margin-bottom:0;}
.w-link-btn{
  border: none;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  color: rgba(255,255,255,0.88);
  font-weight: 800;
  font-size: 12px;
  padding: 9px 12px;
  border-radius: 12px;
  cursor: pointer;
  transition: transform .12s ease, background .12s ease;
}
.w-link-btn:active{transform: translateY(1px);}

.withdraw-method-toggle{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.method-option{
  background: #0f1f3a;
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 18px;
  padding: 12px;
  box-shadow: 0 14px 40px rgba(0,0,0,0.30);
  transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease, background .14s ease;
  position: relative;
  overflow:hidden;
}
.method-option::after{
  content:"";
  position:absolute; inset:-40%;
  background: radial-gradient(circle at 20% 30%, rgba(122,92,255,0.35), transparent 55%),
              radial-gradient(circle at 80% 40%, rgba(255,90,162,0.25), transparent 55%);
  opacity: 0;
  transition: opacity .18s ease;
}
.method-option *{position: relative;}
.method-option .method-icon{font-size: 18px;}
.method-option .label{color: rgba(255,255,255,0.92); font-weight: 900; font-size: 13px;}
.w-method-note{
  display:block;
  margin-top:4px;
  font-size: 11px;
  color: rgba(255,255,255,0.62);
  font-weight: 700;
}
.method-option.active{
  border-color: rgba(255,255,255,0.22);
  transform: translateY(-1px);
  box-shadow: 0 18px 55px rgba(0,0,0,0.38);
}
.method-option.active::after{opacity:1;}

.w-hint{
  margin-top: 10px;
  color: rgba(255,255,255,0.70);
  font-size: 12px;
  line-height: 1.45;
}

.withdraw-screen .input-group label{
  color: rgba(255,255,255,0.78);
  font-size: 12px;
  font-weight: 800;
  letter-spacing: .2px;
}
.withdraw-screen .input-group input{
  background: #081127;
  border: 1px solid rgba(255,255,255,0.12);
  color: rgba(255,255,255,0.92);
  border-radius: 16px;
  padding: 12px 12px;
}
.withdraw-screen .input-group input::placeholder{color: rgba(255,255,255,0.48);}
.withdraw-screen .input-group input:focus{
  border-color: rgba(122,92,255,0.65);
  box-shadow: 0 0 0 4px rgba(122,92,255,0.16);
}

.w-chips{display:flex; gap:8px; flex-wrap:wrap;}
.w-chip{
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.90);
  padding: 9px 12px;
  border-radius: 999px;
  font-weight: 900;
  font-size: 12px;
  cursor: pointer;
  transition: transform .12s ease, background .12s ease;
}
.w-chip:active{transform: translateY(1px);}

.withdraw-min-note{
  color: rgba(255,255,255,0.60);
  font-size: 12px;
  margin-top: 10px;
}

.withdraw-btn.w-primary{
  width: 100%;
  border-radius: 18px;
  padding: 14px 16px;
  font-weight: 1000;
  letter-spacing: .2px;
  background: linear-gradient(90deg, var(--neon-start), var(--neon-mid), var(--neon-end));
  border: 1px solid rgba(255,255,255,0.18);
  box-shadow: 0 18px 55px rgba(0,0,0,0.42);
}
.withdraw-btn.w-primary:disabled{
  opacity: 0.45;
  filter: saturate(0.75);
  box-shadow: none;
}
.withdraw-secondary-btn.w-secondary{
  width: 100%;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.16);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.90);
  font-weight: 900;
  padding: 13px 14px;
}
.withdraw-secondary-btn.w-secondary:active{transform: translateY(1px);}

.withdraw-info-bar{
  background: #0b142a;
  border: 1px solid rgba(255,255,255,0.10);
  color: rgba(255,255,255,0.78);
  border-radius: 18px;
}

/* ===== Withdrawal History Upgrade ===== */
.withdraw-history-screen{
  background: radial-gradient(1000px 700px at 10% 0%, rgba(122,92,255,0.35), transparent 55%),
              radial-gradient(900px 700px at 110% 20%, rgba(255,90,162,0.25), transparent 55%),
              linear-gradient(180deg, #060c18 0%, #050b16 100%);
  padding: 0;              /* scrolling moved to inner container so the bottom alert stays fixed */
  overflow: hidden;
}
.withdraw-history-full{
  background: transparent;
  max-width: 720px;
  margin: 0 auto;
  flex: 1;
  height: 100%;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 18px 16px 120px; /* extra bottom space so content never hides behind the fixed alert */
}

.w-history-hero{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
  background: linear-gradient(180deg, #0c1630 0%, #0a1328 100%);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 22px;
  padding: 16px;
  box-shadow: 0 18px 55px rgba(0,0,0,0.38);
  margin-bottom: 12px;
  position: sticky;
  top: 12px;
  z-index: 200;
}
.w-history-title{
  font-family: 'Orbitron', sans-serif;
  color: rgba(255,255,255,0.95);
  font-size: 18px;
  font-weight: 900;
  margin-bottom: 4px;
}
.w-history-sub{
  color: rgba(255,255,255,0.70);
  font-size: 12px;
  line-height: 1.45;
}
.back-btn.w-history-back{
  border-radius: 14px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.14);
  color: rgba(255,255,255,0.90);
  font-weight: 900;
  padding: 10px 14px;
}
.back-btn.w-history-back:active{transform: translateY(1px);}

.history-list{
  width: 100%;
  max-width: 720px;
  margin: 0 auto;
  padding-bottom: 50px;
}

.history-item{
  background: #0b142a;
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 18px;
  padding: 14px;
  display:flex;
  justify-content:space-between;
  gap: 12px;
  box-shadow: 0 16px 45px rgba(0,0,0,0.32);
  margin-bottom: 10px;
}
.history-item .left{color: rgba(255,255,255,0.80); font-size: 12px; line-height: 1.5;}
.history-item .left strong{color: rgba(255,255,255,0.92);}
.history-item .right{text-align:right;}
.history-item .amount{
  font-family: 'Orbitron', sans-serif;
  color: rgba(255,255,255,0.95);
  font-size: 14px;
  font-weight: 900;
  margin-bottom: 6px;
}
.history-row{display:flex;gap:8px;align-items:flex-start;}
.history-row strong{min-width:52px;}
.history-dest{word-break:break-all;}
.status-pending, .status-completed{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 7px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 900;
  border: 1px solid rgba(255,255,255,0.14);
}
.status-pending{background: rgba(255,183,77,0.14); color: rgba(255,211,132,0.95);}
.status-completed{background: rgba(70,255,188,0.12); color: rgba(140,255,212,0.95);}

.history-empty{
  background: #0b142a;
  border: 1px solid rgba(255,255,255,0.10);
  color: rgba(255,255,255,0.78);
  border-radius: 18px;
  padding: 16px;
  text-align:center;
  box-shadow: 0 16px 45px rgba(0,0,0,0.32);
}

/* Small screens */
@media (max-width: 380px){
  .withdraw-method-toggle{grid-template-columns: 1fr;}
}

/* === Withdraw refinements (v3) === */
:root{
  --app-font: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

/* One font across the app */
html, body, button, input, textarea, select, .app, .app *{
  font-family: var(--app-font) !important;
}

/* Make header compact (title removed) */
.withdraw-screen{ padding-bottom: 92px; }
.w-hero{ padding:14px 14px 12px; }
.w-hero .w-badge{ font-weight:800; letter-spacing:.2px; }

/* Numbers clarity */
.w-balance-value,
#withdrawBalanceDisplay,
#withdrawAmount,
.withdrawal-amount,
.withdrawal-balance,
.w-meta-pill{
  font-variant-numeric: tabular-nums;
  letter-spacing: .2px;
}

/* Method switch (segmented, solid) */
.withdraw-method-toggle{
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.method-option{
  background:#0d2343;
  border:1px solid rgba(255,255,255,0.14);
  box-shadow:none;
  border-radius:16px;
  padding:14px 14px;
}

.method-option .label{
  color:#e2e8f0;
  font-weight:800;
  font-size:13px;
}

.method-option .method-icon{
  font-size:18px;
  width:28px;
  height:28px;
  border-radius:10px;
  background:rgba(255,255,255,0.10);
}

.method-option.active{
  background:#ffffff;
  border-color:#ffffff;
  box-shadow:0 10px 26px rgba(0,0,0,0.18);
}

.method-option.active .label{
  color:#0f172a;
}

.method-option.active .method-icon{
  background:rgba(15,23,42,0.06);
}

/* Actions row: tidy + equal buttons */
.w-actions{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-top:14px;
}

.withdraw-btn{
  width:100%;
  height:48px;
  border-radius:16px;
  font-weight:800;
}

/* Bottom alert (restored style) */
.w-bottom-alert{
  position:fixed;
  left:50%;
  bottom:calc(12px + env(safe-area-inset-bottom));
  transform:translateX(-50%);
  width:min(380px, calc(100% - 32px));
  background:rgba(11,26,51,0.55);
  border:1px solid rgba(255,255,255,0.16);
  color:#e7eefc;
  padding:10px 12px;
  border-radius:14px;
  box-shadow:0 10px 24px rgba(0,0,0,0.22);
  display:flex;
  gap:10px;
  align-items:flex-start;
  z-index:9000;
  font-size:12.5px;
  line-height:1.35;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.w-alert-dot{
  width:10px;
  height:10px;
  border-radius:999px;
  margin-top:4px;
  background:#38bdf8;
  flex:0 0 auto;
}


        /* ===== Withdraw Screen - Modern Controls (v5) ===== */
        .w-actions{
            gap:10px;
            margin-top:10px;
        }
        .withdraw-btn{
            height:46px;
            border-radius:16px;
            font-size:15px;
            letter-spacing:0.2px;
            -webkit-tap-highlight-color: transparent;
        }
        .withdraw-btn:active{ transform:translateY(1px); }

        /* Anti double-tap / loading state */
        .withdraw-btn.is-loading{
            opacity:0.85;
            pointer-events:none;
        }
        .withdraw-btn.is-loading::after{
            content:"";
            width:16px;height:16px;
            border-radius:999px;
            border:2px solid rgba(255,255,255,0.55);
            border-top-color: rgba(255,255,255,0.10);
            margin-left:10px;
            display:inline-block;
            vertical-align:middle;
            animation: wspin 0.9s linear infinite;
        }
        @keyframes wspin{ to { transform:rotate(360deg); } }

        /* Modern segmented method toggle */
        .withdraw-method-toggle{
            display:flex;
            gap:6px;
            padding:6px;
            border-radius:18px;
            background:rgba(255,255,255,0.08);
            border:1px solid rgba(255,255,255,0.14);
            box-shadow:0 14px 34px rgba(0,0,0,0.22);
        }
        .method-option{
            flex:1;
            background:transparent;
            border:0;
            box-shadow:none;
            padding:12px 10px;
            border-radius:14px;
            color:rgba(255,255,255,0.86);
            justify-content:center;
            gap:8px;
            transition:transform .12s ease, background .12s ease, color .12s ease;
        }
        .method-option .label{ font-weight:800; }
        .method-option .method-icon{ filter:drop-shadow(0 6px 14px rgba(0,0,0,0.22)); }
        .method-option:hover{ transform:translateY(-1px); }
        .method-option.active{
            background:rgba(255,255,255,0.96);
            color:#0b1d3a;
            box-shadow:0 12px 26px rgba(0,0,0,0.18);
        }
        .method-option.active .label{ color:#0b1d3a; }
        .method-option input{ display:none; }

        /* Bottom alert: fixed, subtle, and never above the loader */
        .w-bottom-alert{
            pointer-events:none;
            font-size:12.5px;
            line-height:1.35;
        }

        @media (max-width:360px){
            .withdraw-btn{ height:44px; font-size:14.5px; }
            .method-option{ padding:11px 8px; }
        }


/* ===== Modern typography ===== */
:root{
  --font-sans: 'Plus Jakarta Sans','Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
}
body{ font-family: var(--font-sans); }

/* ===== Contest (English/LTR polish) ===== */
.contest-header{ direction:ltr; }
.contest-title{ letter-spacing:-0.02em; }
.contest-badge{ backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
.meta-pill{ border: 1px solid rgba(255,255,255,0.10); }
.prize-item{ border: 1px solid rgba(255,255,255,0.10); }

/* ===== Leaderboard redesign ===== */
.contest-rank-screen{
  background: radial-gradient(900px 500px at 20% 0%, rgba(255,215,0,0.18), transparent 60%),
              radial-gradient(900px 500px at 90% 20%, rgba(0,170,255,0.16), transparent 55%),
              linear-gradient(135deg, #07101d, #0b1a2f 55%, #0a1730);
  color:#fff;
  padding: 14px;
}
.contest-rank-header{
  position: sticky;
  top: 0;
  z-index: 3;
  padding: 10px 10px 12px;
  margin: -14px -14px 12px;
  background: rgba(7,16,29,0.18); /* more transparent */
  border-bottom: 0;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
}
.contest-rank-title{
  margin:0;
  font-weight: 800;
  font-size: 18px;
  letter-spacing: -0.02em;
}
.rank-header-left{
  display:flex;
  flex-direction:column;
  min-width:0;
}
.rank-sub{
  font-size: 12px;
  color: rgba(255,255,255,0.65);
  margin-top: 2px;
}
.rank-header-actions{
  display:flex;
  align-items:center;
  gap: 8px;
  flex: 0 0 auto;
}
.lb-refresh{
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,215,0,0.12);
  color:#fff;
  border-radius: 14px;
  padding: 10px 12px;
  font-weight: 700;
  cursor:pointer;
  transition: transform .15s ease, background .15s ease;
}
.lb-refresh:active{ transform: scale(0.98); }
.lb-refresh:hover{ background: rgba(255,215,0,0.18); }

.contest-rank-list{
  width: min(980px, 100%);
  margin: 0 auto;
  display:flex;
  flex-direction: column;
  gap: 10px;
}

/* Row cards */
.contest-rank-item{
  border-radius: 16px;
  padding: 10px 12px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.10);
  display:grid;
  grid-template-columns: 54px 1fr 160px 120px 72px;
  align-items:center;
  gap: 10px;
  box-shadow: 0 10px 26px rgba(0,0,0,0.18);
}
.contest-rank-item img{
  width: 46px !important;
  height: 46px !important;
  border-radius: 14px !important;
  border: 1px solid rgba(255,255,255,0.14);
}
.contest-rank-name .name-main{
  font-weight: 800;
  letter-spacing:-0.01em;
}
.contest-rank-username{
  margin-top: 2px;
  font-size: 12px;
  color: rgba(255,255,255,0.65);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.contest-rank-userid{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  font-size: 12px;
  color: rgba(255,255,255,0.70);
  opacity: 0.9;
  overflow:hidden;
  text-overflow: ellipsis;
}
.contest-rank-tickets{
  font-weight: 800;
  text-align:right;
}
.contest-rank-position{
  justify-self: end;
  font-weight: 900;
  padding: 8px 10px;
  border-radius: 12px;
  background: rgba(255,215,0,0.10);
  border: 1px solid rgba(255,215,0,0.16);
  min-width: 48px;
  text-align:center;
}
.contest-rank-item.current-player{
  background: rgba(0,170,255,0.10);
  border-color: rgba(0,170,255,0.22);
}
.contest-rank-item[data-rank="1"] .contest-rank-position{ background: rgba(255,215,0,0.18); }
.contest-rank-item[data-rank="2"] .contest-rank-position{ background: rgba(255,255,255,0.12); }
.contest-rank-item[data-rank="3"] .contest-rank-position{ background: rgba(205,127,50,0.18); }

/* Responsive */
@media (max-width: 560px){
  .contest-rank-item{
    grid-template-columns: 54px 1fr 90px 60px;
  }
  .contest-rank-userid{ display:none; }
  .contest-rank-tickets{ text-align:right; }
}
@media (max-width: 380px){
  .contest-rank-item{ grid-template-columns: 54px 1fr 70px 56px; }
  .lb-refresh{ padding: 10px 10px; }
}

</style>
</head>
<body>
<div class="loading-screen" id="loadingScreen">
  <div class="loading-spinner" aria-label="Loading" role="status">
    <div class="loading-badge" aria-hidden="true"></div>
    <div class="loading-dots" aria-hidden="true">
      <span class="loading-dot"></span>
      <span class="loading-dot"></span>
      <span class="loading-dot"></span>
      <span class="loading-dot"></span>
    </div>
  </div>
</div>
<div class="app-screen main-screen" id="mainScreen">
<div class="balance" id="shibBalance">
<img alt="shib" id="shibIcon" src="https://files.catbox.moe/19ugek.png"/>
<span id="shibBalanceText">0 SHIB</span>
</div>
<button aria-label="Open Contest" class="contest-btn-under-balance" onclick="showContest()">
<img alt="Contest" src="https://app.crybblewars.org/main/leader_button/main-icon-top.webp"/>
</button>
<div aria-hidden="false" class="progress-group-container">
<div aria-label="Ads progress" class="daily-progress-container" role="region">
<div class="daily-progress-text">Ads today: <span id="adsCount">0</span> / 200</div>
<div aria-hidden="false" class="daily-progress-bar">
<div class="daily-progress-fill" id="dailyProgressFill"><span class="progress-percent" id="dailyPercent">0%</span></div>
</div>
</div>
<div aria-label="Spin progress" class="spin-progress-container" role="region">
<div class="spin-progress-text">Spins today: <span id="spinsCount">0</span> / 25</div>
<div aria-hidden="false" class="spin-progress-bar">
<div class="spin-progress-fill" id="spinProgressFill"><span class="progress-percent" id="spinPercent">0%</span></div>
</div>
</div>
</div>
<div class="user-circle" onclick="circleClick()">
<img alt="User" id="userImage" src=""/>
<div class="placeholder" aria-label="User profile">üë§</div>
</div>
<div class="user-username" id="userName"></div>
<div class="user-id" id="userId"></div>
<div class="main-content"></div>
<div class="button-container">
<button class="nav-button" onclick="watchAds()"><span>Watch</span></button>
<button class="nav-button task-btn" onclick="showTask()"><span>Task</span></button>
<button class="nav-button" onclick="showSpin()"><span>Spin</span></button>
<button class="nav-button withdraw-btn-nav" onclick="showWithdraw()"><span>Withdraw</span></button>
<button class="nav-button" onclick="inviteFriends()"><span>Invite</span></button>
</div>
</div>
<div class="app-screen task-screen" id="taskScreen">
<div class="task-header">
<h2 class="task-title">Daily Tasks</h2>
</div>
<div class="task-content-container" id="taskContentContainer">
<div class="task-link-container" id="taskLinkArea" style="display:none;">
<div class="task-link-title">
<span>Open and get 5 SHIB</span>
<span id="taskLinkCountDisplay">0 / 200</span>
</div>
<div class="task-link-progress-bar">
<div class="task-link-progress-fill" id="taskLinkProgressFill" style="width:0%"></div>
</div>
<button class="task-link-button" id="taskLinkBtn" onclick="handleTaskLinkClick()">get 5 SHIB</button>
</div>
<div id="taskListContainer">
</div>
<div class="no-channel-tasks" id="noChannelTasksNotice" style="display:none;">No channel tasks now.</div>
</div>
<button class="task-back-btn" onclick="hideTask()">Back to Main</button>
</div>
<div class="app-screen spin-screen" id="spinScreen">
<div class="idle" id="wheelBox">
<div class="arrow"></div>
<div aria-hidden="true" class="spin-light"></div>
<canvas aria-label="Spin wheel" height="280" id="wheelCanvas" width="280"></canvas>
</div>
<button class="spin-btn" id="spinBtn" onclick="startSpin()">SPIN</button>
<div class="spin-result" id="spinResult"></div>
<button class="spin-back" onclick="hideSpin()">Back</button>
</div>

<div class="app-screen withdraw-screen" id="withdrawScreen">
<div class="withdraw-container">
<div class="w-hero">
<div class="w-hero-top">
<div class="w-badge">Payout Center</div>
<button aria-label="Close" class="w-icon-btn" onclick="hideWithdraw()" type="button">‚úï</button>
</div>
</div>
<div class="w-balance-card">
<div class="w-balance-label">Available balance</div>
<div class="w-balance-row">
<div class="w-balance-value" id="withdrawBalanceDisplay">0</div>
<div class="w-balance-unit">SHIB</div>
</div>
<div class="w-balance-meta">
<span class="w-meta-pill">Minimum: 4,000 SHIB</span>
<span class="w-meta-pill">Fee: 0 SHIB</span>
</div>
</div>
<div class="w-panel">
<div class="w-panel-head">
<div class="w-panel-title">Method</div>
</div>
<div class="withdraw-method-toggle" id="withdrawMethodToggle">
<label class="method-option active" id="methodBinance">
<input checked="" name="withdrawMethod" type="radio" value="binance"/>
<span aria-hidden="true" class="method-icon">üè¶</span>
<span class="label">Binance ID</span>
</label>
<label class="method-option" id="methodFaucetpay">
<input name="withdrawMethod" type="radio" value="faucetpay"/>
<span aria-hidden="true" class="method-icon">üìß</span>
<span class="label">FaucetPay Email</span>
</label>
</div>
</div>
<div class="w-panel">
<div class="w-panel-title">Destination</div>
<div class="w-form">
<div class="input-group" id="binanceGroup">
<label>Binance User ID</label>
<input id="binanceId" placeholder="Enter your Binance ID" type="text"/>
</div>
<div class="input-group" id="faucetpayGroup" style="display:none;">
<label>FaucetPay Email</label>
<input id="faucetpayEmail" placeholder="Enter your FaucetPay email" type="email"/>
</div>
</div>
</div>
<div class="w-panel">
<div class="w-panel-title">Amount</div>
<div class="w-amount">
<div class="input-group w-amount-input" style="margin-bottom:10px;">
<label>Withdrawal Amount</label>
<input id="withdrawAmount" min="4000" placeholder="Enter amount (SHIB)" type="number" value=""/>
</div>
<div aria-label="Quick amounts" class="w-chips">
<button class="w-chip" data-withdraw-chip="4000" type="button">Min</button>
<button class="w-chip" data-withdraw-chip="10000" type="button">10K</button>
<button class="w-chip" data-withdraw-chip="25000" type="button">25K</button>
<button class="w-chip" data-withdraw-chip="max" type="button">Max</button>
</div>
</div>
</div>
<div class="w-actions">
  <button class="withdraw-btn w-primary" disabled="" id="withdrawRequestBtn" onclick="confirmWithdraw()">Withdraw</button>
  <button class="withdraw-btn w-outline" type="button" onclick="displayWithdrawalsFull()">History</button>
</div>
</div>
<button class="withdraw-secondary-btn w-secondary" onclick="hideWithdraw()">Back to Main</button>
<div class="w-bottom-alert" id="withdrawBottomAlert" role="status" aria-live="polite">
  <span class="w-alert-dot" aria-hidden="true"></span>
  Withdrawals are processed within 24 hours. Please double-check your details.
</div>
</div>
</div>


<!-- Fullscreen withdrawal history (opened from History button) -->

<div class="app-screen withdraw-history-screen" id="withdrawHistoryScreen">
<div class="withdraw-history-full" id="withdrawHistoryFull">
<div class="w-history-hero">
<div class="w-history-left">
<div class="w-history-title">Withdrawal History</div>
<div class="w-history-sub">Track your payout requests and their status.</div>
</div>
<button class="back-btn w-history-back" onclick="closeWithdrawHistory()">Back</button>
</div>
<div class="history-list" id="withdrawHistoryList">
<!-- items injected here -->
</div>

<div class="w-bottom-alert" id="withdrawHistoryBottomAlert" role="status" aria-live="polite">
  <span class="w-alert-dot" aria-hidden="true"></span>
  Notice: Withdrawal requests are processed within 24 hours. If the status is Pending, please wait a bit and double‚Äëcheck your details.
</div>
</div>
</div>

<div aria-label="Invite" class="app-screen invite-screen" id="inviteScreen">
<div class="invite-shell">
<div class="invite-topbar">
<button aria-label="Back" class="invite-back-icon" onclick="hideInvite()">‚Üê</button>
<div class="invite-topbar-title">
<div class="invite-topbar-kicker">Invite</div>
<div class="invite-topbar-headline">Invite Friends</div>
</div>
</div>
<div class="invite-hero-card">
<div aria-hidden="true" class="invite-hero-art"></div>
<div class="invite-hero-text">
<div class="invite-hero-title">Earn from every invite</div>
<div class="invite-hero-sub">Get <strong>40%</strong> of the ad revenue generated by your referrals.</div>
</div>
</div>
<div aria-label="Invite stats" class="invite-stats" role="group">
<div class="invite-stat">
<div class="label">Referrals</div>
<div class="value"><span id="referralsCountDisplay">0</span></div>
</div>
<div class="invite-stat">
<div class="label">Rate</div>
<div class="value">40%</div>
</div>
<div class="invite-stat">
<div class="label">Status</div>
<div class="value"><span class="pill">Active</span></div>
</div>
</div>
<div class="invite-link-card">
<div class="invite-link-label">Your invite link</div>
<div class="invite-link-row">
<input class="invite-link-input" dir="ltr" id="referralLinkInput" readonly="" type="text" value="Generating link..."/>
<button class="invite-mini-btn" onclick="copyReferralLink()">Copy</button>
</div>
<div class="invite-actions">
<button class="invite-primary-btn" onclick="shareReferralLink()">Share</button>
<button class="invite-ghost-btn" onclick="copyReferralLink()">Copy again</button>
</div>
<div class="invite-hint">Tip: Share this link. When your friend opens the app from it, they‚Äôll be counted as your referral.</div>
</div>
<div class="invite-note-card">
<div class="invite-note-title">How it works</div>
<ul class="invite-note-list">
<li>Copy or share your invite link.</li>
<li>When a friend opens the app using your link, it‚Äôs registered automatically.</li>
<li>You earn 40% of the referral ad revenue.</li>
</ul>
</div>
<button class="back-btn invite-back-btn" onclick="hideInvite()">Back to Home</button>
</div>
</div>
<!-- Contest Screen -->
<div class="app-screen contest-screen" id="contestScreen">
<div class="contest-header" dir="ltr">
  <div class="contest-hero">
    <div class="contest-hero-top">
      <h2 class="contest-title">üèÜ Prize Contest</h2>
      <div class="contest-badge">PRIZE POOL ‚Ä¢ 100,000 SHIB</div>
    </div>

    <div class="contest-meta">
      <div class="meta-pill meta-countdown" aria-label="Countdown">
        <span class="meta-label">Ends in</span>
        <span class="contest-countdown" id="contestCountdown">10d 00h 00m 00s</span>
      </div>
      <div class="meta-pill meta-info" aria-label="Winners">
        <span class="meta-label">Winners</span>
        <span class="meta-value">Top 5</span>
      </div>
    </div>
  </div>

  <!-- Prize distribution -->
  <div class="prize-vertical-box" id="prizeBox" aria-label="Prize distribution">
    <div class="prize-item prize-top">
      <div class="prize-left">
        <div class="prize-medal">ü•á</div>
        <div class="prize-text">
          <div class="prize-label">1st Place</div>
          <div class="prize-sub">1st place</div>
        </div>
      </div>
      <div class="prize-amount">
        <span class="prize-value">50,000</span><span class="prize-unit">SHIB</span>
      </div>
    </div>

    <div class="prize-item prize-second">
      <div class="prize-left">
        <div class="prize-medal">ü•à</div>
        <div class="prize-text">
          <div class="prize-label">2nd Place</div>
          <div class="prize-sub">2nd place</div>
        </div>
      </div>
      <div class="prize-amount">
        <span class="prize-value">25,000</span><span class="prize-unit">SHIB</span>
      </div>
    </div>

    <div class="prize-item">
      <div class="prize-left">
        <div class="prize-medal">ü•â</div>
        <div class="prize-text">
          <div class="prize-label">3rd Place</div>
          <div class="prize-sub">3rd place</div>
        </div>
      </div>
      <div class="prize-amount">
        <span class="prize-value">10,000</span><span class="prize-unit">SHIB</span>
      </div>
    </div>

    <div class="prize-item">
      <div class="prize-left">
        <div class="prize-medal">üèÖ</div>
        <div class="prize-text">
          <div class="prize-label">4th Place</div>
          <div class="prize-sub">4th place</div>
        </div>
      </div>
      <div class="prize-amount">
        <span class="prize-value">10,000</span><span class="prize-unit">SHIB</span>
      </div>
    </div>

    <div class="prize-item">
      <div class="prize-left">
        <div class="prize-medal">‚≠ê</div>
        <div class="prize-text">
          <div class="prize-label">5th Place</div>
          <div class="prize-sub">5th place</div>
        </div>
      </div>
      <div class="prize-amount">
        <span class="prize-value">5,000</span><span class="prize-unit">SHIB</span>
      </div>
    </div>
  </div>
</div>
<div aria-label="Contest Tickets Summary" class="contest-tickets-container" role="region">
<div class="contest-ticket-row">
<span class="contest-ticket-label">
<img alt="ticket" class="contest-ticket-img" src="https://app.crybblewars.org/main/voucher_button/cards-icon.webp"/>
                    My Tickets
                </span>
<span class="contest-ticket-value" id="myTickets">0</span>
</div>
<div class="contest-ticket-row" style="align-items:flex-end;">
<span class="contest-ticket-label">
<img alt="ticket" class="contest-ticket-img" src="https://app.crybblewars.org/main/voucher_button/cards-icon.webp"/>
                    All Tickets
                </span>
<span class="contest-ticket-value" id="allTickets">0</span>
</div>
</div>
<div class="contest-buttons-horizontal">
<button class="contest-watch-btn" onclick="watchContestAd()">Watch</button>
<button class="contest-rank-btn" onclick="showContestRank()">Ranking</button>
</div>
<button class="contest-back-btn" onclick="hideContest()">Back to Main</button>
</div>
<!-- Contest Ranking Screen -->
<div class="app-screen contest-rank-screen" id="contestRankScreen">
<div class="contest-rank-header">
  <div class="rank-header-left">
    <h2 class="contest-rank-title">üèÜ Top Players</h2>
    <div class="rank-sub" id="rankUpdatedAt" aria-live="polite"></div>
  </div>
  <div class="rank-header-actions">
<button class="back-btn" onclick="hideContestRank()">Back</button>
  </div>
</div>


<!-- PERSONAL USER BOX: shows the current user's avatar + row with (user id) | (username centered) | (tickets) | (rank) -->
<div class="personal-info-box" id="personalUserBox" style="display:none;">
<!-- content injected by JS -->
<img alt="avatar" class="personal-avatar" id="personalAvatar" src=""/>
<div class="personal-info-row">
<div class="personal-id">
<div class="label">ID</div>
<div class="value" id="personalIdValue">-</div>
</div>
<div class="personal-username" style="flex:1">
<div class="label">User</div>
<div class="value" id="personalNameValue">-</div>
</div>
<div class="personal-tickets">
<div class="label">Tickets</div>
<div class="value" id="personalTicketsValue">0</div>
</div>
<div class="personal-rank">
<div class="label">Rank</div>
<div class="value" id="personalRankValue">-</div>
</div>
</div>
</div>
<div aria-live="polite" class="contest-rank-list" id="contestRankList">
<!-- Top players will be injected here from server -->
</div>
</div>
<div class="custom-alert-overlay" id="customAlert">
<div class="custom-alert-box">
<div class="alert-icon" id="alertIcon"></div>
<div class="alert-title" id="alertTitle"></div>
<div class="alert-message" id="alertMessage"></div>
<button class="alert-close-btn" onclick="document.getElementById('customAlert').classList.remove('visible')">OK</button>
</div>
</div>
<!-- Toast container (for top toasts). Created in HTML so CSS applies immediately -->
<div aria-atomic="false" aria-live="polite" class="toast-container" id="toastContainer"></div>
<!-- Background audio player (playlist managed in JS): audio.mp3, audio2.mp3, audio3.mp3, audio4.mp3 -->
<audio id="bgPlayer">
<source id="bgSource" src="audio.mp3" type="audio/mp3"/>
        Your browser does not support the audio element.
    </audio>
<audio id="successSFX">
<source src="success.mp3" type="audio/mp3"/>
</audio>
<audio id="errorSFX">
<source src="error.mp3" type="audio/mp3"/>
</audio>
<script>
        /* ===== AdsGram SDK (replaces libtl.com) ===== */
        const ADSGRAM_BLOCK_ID = 'int-20679';
        let __adsgramController = null;

        function getAdsgramController() {
            if (__adsgramController) return __adsgramController;
            if (!window.Adsgram || typeof window.Adsgram.init !== 'function') {
                throw new Error('AdsGram SDK not loaded');
            }
            __adsgramController = window.Adsgram.init({ blockId: ADSGRAM_BLOCK_ID });
            return __adsgramController;
        }

        // Keep legacy function name so the rest of the app works without changes
        async function show_10245709() {
            const ctrl = getAdsgramController();
            try {
                return await ctrl.show();
            } catch (res) {
                const desc = (res && res.description) ? String(res.description) : '';
                // mimic old "canceled" behavior for skip-like events
                if (/skip|cancel|cancell/i.test(desc)) {
                    throw 'canceled';
                }
                throw res;
            }
        }


        /* ===== Loading ===== */
        const loadingScreen = document.getElementById('loadingScreen');
        const mainScreen = document.getElementById('mainScreen');

        document.addEventListener('DOMContentLoaded',()=>{
            // Simulating a brief loading time for the spinner to be visible
            setTimeout(async ()=>{ 
                await initDailyProgress(); 
                loadingScreen.classList.add('hidden');
                playBGAudio(); 
            }, 7000); 
        });
        
        /* ===== Custom Alert & Audio Functions ===== */
        
        const bgPlayer = document.getElementById('bgPlayer');
        const successSFX = document.getElementById('successSFX');
        const errorSFX = document.getElementById('errorSFX');
        const customAlert = document.getElementById('customAlert');
        const alertBox = customAlert.querySelector('.custom-alert-box');
        const alertTitleEl = document.getElementById('alertTitle');
        const alertMessageEl = document.getElementById('alertMessage');
        const alertIconEl = document.getElementById('alertIcon');

        const toastContainer = document.getElementById('toastContainer');

        const bgPlaylist = ['audio.mp3', 'audio2.mp3', 'audio3.mp3', 'audio4.mp3'];
        let currentBgIndex = -1;

        function playNextBg() {
            if (!Array.isArray(bgPlaylist) || bgPlaylist.length === 0) return;
            currentBgIndex = (currentBgIndex + 1) % bgPlaylist.length;
            const nextSrc = bgPlaylist[currentBgIndex];
            try {
                bgPlayer.src = nextSrc;
                bgPlayer.load();
                bgPlayer.volume = 0.4;
                bgPlayer.play().catch(e => {
                    console.log("bgPlayer play blocked (will wait for user interaction):", e);
                });
            } catch (e) {
                console.warn("Failed to set bgPlayer source:", e);
            }
        }

        bgPlayer.addEventListener('ended', () => {
            playNextBg();
        });

        bgPlayer.addEventListener('error', (e) => {
            console.warn('bgPlayer error, advancing to next track', e);
            playNextBg();
        });

        function playBGAudio() {
            try {
                if (currentBgIndex === -1) {
                    currentBgIndex = 0;
                    bgPlayer.src = bgPlaylist[currentBgIndex];
                    bgPlayer.load();
                }
                bgPlayer.volume = 0.4;
                bgPlayer.play().catch(e => {
                    console.log("Background audio play failed, waiting for user click:", e);
                });
            } catch (e) {
                console.log("Background audio play failed, waiting for user click:", e);
            }
        }
        
        function playSFX(type) {
            let sfx;
            if (type === 'success') {
                sfx = successSFX;
            } else if (type === 'error') {
                sfx = errorSFX;
            } else {
                return;
            }
            sfx.currentTime = 0;
            sfx.volume = 0.8;
            sfx.play().catch(e => console.log("SFX play failed:", e));
        }

        /* =========================
           Toast Notification System (replaces previous overlay alerts for non-blocking UX)
           - Uses same showCustomAlert signature for compatibility with existing code.
           - Creates small top toasts, auto-dismiss after ~2.8s (configurable).
           - Glassmorphism style, soft shadow, rounded corners.
           - Error type gets a subtle shake animation.
           - Does not block page interactions (pointer-events: none).
           - Improved contrast, larger type and multi-line support.
           ========================= */

        /**
         * showToast(type, title, message, opts)
         * type: 'success'|'error'|'warning'|'info'
         * title: short title string
         * message: short descriptive text (supports multi-line)
         * opts: { durationMs: number (optional) }
         */
        function showToast(type, title, message, opts = {}) {
            if (!toastContainer) return;
            const duration = typeof opts.durationMs === 'number' ? opts.durationMs : 3600; // slightly longer default
            const toast = document.createElement('div');
            const safeTitle = String(title || '').slice(0, 160);
            const safeMessage = String(message || '').slice(0, 800);

            const typeClass = `toast--${type || 'info'}`;
            toast.className = `toast ${typeClass}`;
            // build inner HTML (icon left, title + small message)
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            else if (type === 'error') icon = '‚ùå';
            else if (type === 'warning') icon = '‚ö°';
            else if (type === 'info') icon = '‚ÑπÔ∏è';

            toast.innerHTML = `
                <div class="toast-icon" aria-hidden="true">${icon}</div>
                <div class="toast-content">
                    <div class="toast-title">${escapeHtml(safeTitle || capitalizeType(type))}</div>
                    <div class="toast-message">${escapeHtml(safeMessage || '')}</div>
                </div>
            `;

            // append and animate in
            toastContainer.appendChild(toast);

            // small delay to ensure CSS animation triggers
            requestAnimationFrame(() => {
                // apply 'show' state
                toast.classList.add('show');
                // add shake class for error
                if (type === 'error') {
                    // add a class that triggers a shake; the CSS combines with entrance animation
                    toast.classList.add('shake');
                }
            });

            // optional SFX
            if (type === 'error') playSFX('error');
            else if (type === 'success') playSFX('success');

            // auto-dismiss
            const hideAfter = Math.max(1800, duration); // ensure reasonable min
            const timeoutId = setTimeout(() => {
                // start hide animation
                toast.classList.remove('show');
                toast.classList.add('hide');
                // remove after animation
                setTimeout(() => {
                    if (toast && toast.parentNode) toast.parentNode.removeChild(toast);
                }, 300);
            }, hideAfter);

            // Return control object for optional manual dismissal
            return {
                dismiss: () => {
                    clearTimeout(timeoutId);
                    if (toast && toast.parentNode) {
                        toast.classList.remove('show');
                        toast.classList.add('hide');
                        setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
                    }
                }
            };
        }

        // Helper: preserve existing function name so other code calls still work.
        // We replace the previous overlay-based showCustomAlert with a toast-based implementation.
        function showCustomAlert(title, message, type = 'warning') {
            // Normalize type to known values
            const normalized = (String(type || '').toLowerCase());
            const t = ['success','error','warning','info'].includes(normalized) ? normalized : 'info';

            // Preserve newlines and show multi-line message in English if possible
            const msg = String(message || '').replace(/\r\n/g, '\n').trim();

            // Use a compact duration for toasts; success/info shorter, error slightly longer
            const durationMap = { success: 3000, info: 3000, warning: 3600, error: 4200 };
            const duration = durationMap[t] || 3200;

            showToast(t, title || capitalizeType(t), msg, { durationMs: duration });
        }

        // small helper: escape HTML to avoid injection in innerHTML usage
        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function capitalizeType(type) {
            if (!type) return '';
            return String(type).charAt(0).toUpperCase() + String(type).slice(1);
        }

        /* ===== Telegram User & Referral Setup (Modified to include audio) ===== */
        Telegram.WebApp.ready();
        
        let tgUser = null;
        if(Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user){
            tgUser = Telegram.WebApp.initDataUnsafe.user;
            const photoUrl = tgUser.photo_url;
            const userName = tgUser.first_name + (tgUser.last_name? ' '+tgUser.last_name:'');
            const userId = tgUser.id;
            const imgEl  = document.getElementById('userImage');
            const nameEl = document.getElementById('userName');
            const idEl   = document.getElementById('userId');
            const placeHolder = document.querySelector('.placeholder');
            if(photoUrl){
                imgEl.src = photoUrl;
                imgEl.style.display = 'block';
                if (placeHolder) placeHolder.style.display = 'none';
            } else {
                // Show a clean initial instead of a plain "+" when no profile photo exists
                if (placeHolder) {
                    const initial = (userName && userName.trim().length) ? userName.trim().charAt(0).toUpperCase() : 'üë§';
                    placeHolder.textContent = initial;
                }
            }
            nameEl.textContent = userName;
            idEl.textContent   = 'ID: ' + userId;
        }

        function getRefParam() {
            let referrerId = null;
            const REF_PREFIX = 'ref_';

            if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.start_param) {
                const startParam = Telegram.WebApp.initDataUnsafe.start_param;
                if (startParam.startsWith(REF_PREFIX)) {
                    referrerId = startParam.substring(REF_PREFIX.length);
                    console.log('Referrer ID from start_param:', referrerId);
                }
            } 
            return referrerId; 
        }

        let referrerId = getRefParam();
        const API_URL = '/api'; 
        
        // ------------------------------------------------------------------
        // **fetchApi Function**
        // ------------------------------------------------------------------
        async function fetchApi(payload) {
            if (!tgUser) {
                showCustomAlert('Critical Error!', 'User data not initialized. Please restart the app. [CODE: U_NIL]', 'error');
                return { ok: false, error: 'User not initialized' };
            }

            const initData = Telegram.WebApp.initData;
            if (!initData) {
                showCustomAlert('Critical Error!', 'Initialization data is missing. Please restart the app. [CODE: ID_MS]', 'error');
                return { ok: false, error: 'InitData missing' };
            }

            if (typeof Telegram.WebApp.showProgress === 'function') {
                Telegram.WebApp.showProgress();
            }
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...payload,
                        user_id: tgUser.id,
                        initData: initData 
                    }),
                });

                if (typeof Telegram.WebApp.hideProgress === 'function') {
                    Telegram.WebApp.hideProgress();
                }

                const data = await response.json();

                if (!response.ok || !data.ok) {
                    const errorMessage = data.error || `Server Error: ${response.status} ${response.statusText}`;
                    console.error(`API Call failed for type ${payload.type}:`, errorMessage);
                    let alertTitle = 'Operation Failed!';
                    let alertType = 'error';
                    let cleanMessage = errorMessage;

                    if (response.status === 429) {
                        alertTitle = 'Rate Limit Exceeded!';
                        alertType = 'warning';
                        cleanMessage = 'You have exceeded the allowed request limit. Please try again after 5 second.';
                    } else if (errorMessage.includes('banned')) {
                        alertTitle = 'Access Denied!';
                        alertType = 'error';
                        cleanMessage = 'This account has been banned.';
                    } else if (errorMessage.includes('limit reached')) {
                        alertTitle = 'Daily Limit Reached!';
                        alertType = 'warning';
                        cleanMessage = 'You have reached the maximum number of allowed actions for today.';
                    } else if (errorMessage.includes('Server Token') || response.status === 409 || response.status === 408) {
                        alertTitle = 'Security Error!';
                        alertType = 'error';
                        cleanMessage = 'A security-related error occurred. Please try again.';
                    } else if (payload.type === 'completeTask' && errorMessage.includes('already completed')) {
                        alertTitle = 'Task Completed!';
                        alertType = 'warning';
                        cleanMessage = 'Reward already claimed. Task is complete.';
                    } else if (payload.type === 'completeTask' && errorMessage.includes('not joined')) {
                        alertTitle = 'Task Failed!';
                        alertType = 'error';
                        cleanMessage = 'Membership not verified. Please ensure you joined the channel and try again.';
                    } else {
                        alertTitle = 'Operation Failed!';
                        alertType = 'error';
                        cleanMessage = errorMessage;
                    }
                    
                    showCustomAlert(alertTitle, cleanMessage, alertType);
                    return { ok: false, error: errorMessage };
                }

                return data;
            } catch (error) {
                if (typeof Telegram.WebApp.hideProgress === 'function') {
                    Telegram.WebApp.hideProgress();
                }
                console.error(`General Fetch Error for type ${payload.type}:`, error.message);
                showCustomAlert('Connection Error!', 'Could not connect to the server. Please check your internet connection.', 'error');
                return { ok: false, error: error.message };
            }
        }

        // ------------------------------------------------------------------
        // NEW: Function to request Action ID from the Server
        // ------------------------------------------------------------------
        async function requestActionId(actionType) {
            const result = await fetchApi({ 
                type: 'generateActionId', 
                action_type: actionType 
            });
            
            if (result.ok) {
                return result.data.action_id;
            }
            return null;
        }


        /* ===== Rewards, Limits, and Anti-Cheat (Limits here are for display only) ===== */
        const DAILY_MAX = 200;
        const DAILY_MAX_SPINS = 25;
        
        let shibBalance = 0; 
        let adsWatchedToday = 0;
        let spinsToday = 0; 
        let taskCompleted = false; 
        let taskActionState = 'JOIN_OR_CLAIM';
        let withdrawalHistory = [];
        let referralsCount = 0; 
        let isBanned = false; 
        let isProcessingTask = false; 
        let countdownInterval = null;
        
        const sectors = [5, 10, 15, 20, 5]; 

        let currentTask = null;

        // ===== Contest Variables =====
        let contestEndTime = new Date().getTime() + (10 * 24 * 60 * 60 * 1000); // 10 days from now
        let myTickets = 0;
        let allTickets = 0;
        let contestCountdownInterval = null;
        let contestAdLocked = false;

        // ===== Task Link Constants and state (local-storage based) =====
        const TASK_LINK_KEY = 'taskLinkProgress_v1';
        const TASK_LINK_DAILY_MAX = 200; // daily limit (count)
        const TASK_LINK_REWARD = 5; // 5 SHIB per click
        const TASK_LINK_URL = 'https://otieu.com/4/10259911';

        let taskLinkState = { date: null, count: 0 }; // {date:'YYYY-MM-DD', count: number}

        function todayDateString() {
            const d = new Date();
            return d.toISOString().slice(0,10);
        }

        function loadTaskLinkProgressFromStorage() {
            try {
                const raw = localStorage.getItem(TASK_LINK_KEY);
                if (!raw) {
                    taskLinkState = { date: todayDateString(), count: 0 };
                    localStorage.setItem(TASK_LINK_KEY, JSON.stringify(taskLinkState));
                    return;
                }
                const parsed = JSON.parse(raw);
                if (!parsed || parsed.date !== todayDateString()) {
                    taskLinkState = { date: todayDateString(), count: 0 };
                    localStorage.setItem(TASK_LINK_KEY, JSON.stringify(taskLinkState));
                    return;
                }
                taskLinkState = parsed;
            } catch (e) {
                console.warn('Failed to load task link progress from localStorage:', e);
                taskLinkState = { date: todayDateString(), count: 0 };
            }
        }

        function saveTaskLinkProgressToStorage() {
            try {
                taskLinkState.date = todayDateString();
                localStorage.setItem(TASK_LINK_KEY, JSON.stringify(taskLinkState));
            } catch (e) {
                console.warn('Failed to save task link progress to localStorage:', e);
            }
        }

        function updateTaskLinkUI() {
            const area = document.getElementById('taskLinkArea');
            const fill = document.getElementById('taskLinkProgressFill');
            const countDisplay = document.getElementById('taskLinkCountDisplay');
            const btn = document.getElementById('taskLinkBtn');

            if (!area || !fill || !countDisplay || !btn) return;

            area.style.display = 'block';

            const count = taskLinkState.count || 0;
            const percent = Math.min((count / TASK_LINK_DAILY_MAX) * 100, 100);
            fill.style.width = percent + '%';
            countDisplay.textContent = `${count.toLocaleString('en-US')} / ${TASK_LINK_DAILY_MAX.toLocaleString('en-US')}`;

            if (count >= TASK_LINK_DAILY_MAX) {
                btn.disabled = true;
                btn.textContent = 'Daily Limit Reached';
            } else {
                btn.disabled = false;
                btn.textContent = 'Open and get 5 SHIB';
            }
        }

        async function handleTaskLinkClick() {
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }

            if (taskLinkState.count >= TASK_LINK_DAILY_MAX) {
                showCustomAlert('Daily Limit Reached!', `You have reached the daily limit for these instant links (${TASK_LINK_DAILY_MAX}).`, 'warning');
                updateTaskLinkUI();
                return;
            }

            let actionId = null;
            try {
                actionId = await requestActionId('taskLink');
            } catch (e) {
                console.warn('Failed to get action id for task link:', e);
                actionId = null;
            }

            const opened = openExternalLink(TASK_LINK_URL);

            let serverResult = { ok: false };
            if (actionId) {
                try {
                    serverResult = await fetchApi({
                        type: 'taskLinkClick',
                        action_id: actionId,
                        url: TASK_LINK_URL
                    });
                } catch (e) {
                    serverResult = { ok: false };
                }
            }

            if (serverResult && serverResult.ok) {
                if (serverResult.data && serverResult.data.new_balance !== undefined) {
                    shibBalance = serverResult.data.new_balance;
                    taskLinkState.count = serverResult.data.new_count;
                    saveTaskLinkProgressToStorage();
                    updateState({ balance: shibBalance });
                    updateTaskLinkUI();
                    showCustomAlert('Reward', `You received ${TASK_LINK_REWARD} SHIB`, 'success');
                } else {
                    showCustomAlert('Server Sync Warning', 'The server accepted the click but did not return updated data. Please reload the app.', 'warning');
                }
                return;
            }
            
            loadUserData();
        }

        // ------------------------------------------------------------------

        function updateState(data) {
            shibBalance = data.balance !== undefined ? data.balance : shibBalance;
            adsWatchedToday = data.ads_watched_today !== undefined ? data.ads_watched_today : adsWatchedToday;
            spinsToday = data.spins_today !== undefined ? data.spins_today : spinsToday;
            referralsCount = data.referrals_count !== undefined ? data.referrals_count : referralsCount;
            withdrawalHistory = data.withdrawal_history !== undefined ? data.withdrawal_history : withdrawalHistory;
            isBanned = data.is_banned !== undefined ? data.is_banned : isBanned;
            if (data.task_completed === true) {
                taskCompleted = true;
                taskActionState = 'COMPLETED';
            } else if (data.task_completed === false) {
                 taskCompleted = false;
            }

            updateUI();
        }
        
        async function loadUserData() {
            if (!tgUser) return;
            
            const result = await fetchApi({ type: 'getUserData' }); 

            if (result.ok) {
                if (result.data.is_banned) {
                    isBanned = true;
                    mainScreen.classList.remove('visible');
                    showCustomAlert('Account Banned!', 'This account has been permanently restricted for violating policies. Access to the Mini App is denied.', 'error');
                    return;
                }
                
                updateState({
                    balance: result.data.balance,
                    ads_watched_today: result.data.ads_watched_today,
                    spins_today: result.data.spins_today,
                    referrals_count: result.data.referrals_count,
                    is_banned: false, 
                    task_completed: result.data.task_completed || false,
                    withdrawal_history: (result.data.withdrawal_history || []).map(item => ({
                        amount: item.amount,
                        status: item.status,
                        date: new Date(item.created_at).toLocaleDateString('en-GB'),
                        binance_id: item.binance_id || null,
                        faucetpay_email: item.faucetpay_email || null
                    }))
                });

                if (result.data.task_link_clicks_today !== undefined) {
                    taskLinkState.count = result.data.task_link_clicks_today;
                    saveTaskLinkProgressToStorage();
                }

                if (taskCompleted) {
                    taskActionState = 'COMPLETED';
                } else if (taskActionState === 'COMPLETED') { 
                    taskActionState = 'JOIN_OR_CLAIM';
                }
                
                mainScreen.classList.add('visible'); 

            }
        }
        
        async function initDailyProgress(){
            if (!tgUser) return;

            // include minimal user profile to server so photo_url & name saved
            const userPayload = {
                type: 'register',
                ref_by: referrerId ? referrerId : null,
                user: {
                    id: tgUser.id,
                    first_name: tgUser.first_name || null,
                    last_name: tgUser.last_name || null,
                    photo_url: tgUser.photo_url || null
                }
            };

            const registerResult = await fetchApi(userPayload);

            if (registerResult.ok) {
                await loadUserData(); 
            }
        }
        
        
        function updateWithdrawButtonState(){
            const btn = document.getElementById('withdrawRequestBtn');
            const amountEl = document.getElementById('withdrawAmount');
            if (!btn || !amountEl) return;
            const bal = Number(shibBalance || 0);
            const amount = Number(amountEl.value || 0);
            const MIN_WITHDRAW_UI = 4000;
            btn.disabled = !(bal >= MIN_WITHDRAW_UI && amount >= MIN_WITHDRAW_UI && amount <= bal);
        }

function updateUI(){
            document.getElementById('shibBalanceText').textContent = Number(shibBalance || 0).toLocaleString('en-US') + ' SHIB';
            document.getElementById('withdrawBalanceDisplay').textContent = Number(shibBalance || 0).toLocaleString('en-US');
            updateWithdrawButtonState();

            document.getElementById('adsCount').textContent = Number(adsWatchedToday || 0).toLocaleString('en-US');
            const adsPercent = Math.min((adsWatchedToday / DAILY_MAX) * 100, 100);
            document.getElementById('dailyProgressFill').style.width = adsPercent + '%';
            document.getElementById('dailyPercent').textContent = Math.round(adsPercent) + '%';

            document.getElementById('spinsCount').textContent = Number(spinsToday || 0).toLocaleString('en-US'); 
            const spinsPercent = Math.min((spinsToday / DAILY_MAX_SPINS) * 100, 100);
            document.getElementById('spinProgressFill').style.width = spinsPercent + '%';
            document.getElementById('spinPercent').textContent = Math.round(spinsPercent) + '%';

            document.getElementById('referralsCountDisplay').textContent = Number(referralsCount || 0).toLocaleString('en-US');
            
            const perTaskBtn = currentTask ? document.querySelector(`button[data-task-id="${currentTask.id}"]`) : null;

            if (perTaskBtn) {
                if (!isProcessingTask && countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }

                if (currentTask && currentTask.is_completed) {
                    perTaskBtn.disabled = true;
                    perTaskBtn.textContent = 'Claimed';
                    perTaskBtn.classList.add('completed');
                } else {
                    perTaskBtn.disabled = isProcessingTask || perTaskBtn.dataset.locked === '1';
                    perTaskBtn.classList.remove('completed');

                    if (isProcessingTask) {
                    } else if (taskActionState === 'CLAIM') {
                        perTaskBtn.textContent = 'Claim';
                    } else {
                        perTaskBtn.textContent = 'Open';
                    }
                }
            }

            const adButton = document.querySelector('button[onclick="watchAds()"]');
            if (adButton) {
                if (isBanned || adsWatchedToday >= DAILY_MAX) {
                    adButton.disabled = true;
                    adButton.querySelector('span').textContent = 'LIMIT REACHED';
                } else {
                    adButton.disabled = false;
                    adButton.querySelector('span').textContent = 'Ads';
                }
            }

            const spinBtn = document.getElementById('spinBtn');
            if (spinBtn) {
                if (spinBtn) {
                    if (isBanned || spinsToday >= DAILY_MAX_SPINS) {
                        spinBtn.disabled = true;
                        spinBtn.textContent = `LIMIT REACHED (${Number(spinsToday).toLocaleString('en-US')}/${DAILY_MAX_SPINS})`;
                    } else if (!spinning) {
                        spinBtn.disabled = false;
                        spinBtn.textContent = 'SPIN';
                    }
                }
            }

            updateTaskLinkUI();

            displayWithdrawals();

            updateContestUI();
        }
        
        // ***************************************************************
        // UPDATED watchAds FUNCTION: better messages (English), improved error handling & UI reset
        // ***************************************************************
        async function watchAds(){
            if (isBanned) {
                 showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                 return;
            }
            
            if (adsWatchedToday >= DAILY_MAX) {
                showCustomAlert('Daily Limit Reached!', `You have completed all ads for today (${DAILY_MAX}). Please come back later.`, 'warning');
                return;
            }

            const actionId = await requestActionId('watchAd');
            if (!actionId) return;

            // Show two ads sequentially using libtl SDK. We'll handle failures and ensure UI resets.
            try {
                await show_10245709();
                await show_10245709();

                const adResult = await fetchApi({
                    type: 'watchAd',
                    action_id: actionId
                });

                if (adResult.ok) {
                    const actualReward = adResult.data.actual_reward;
                    
                    updateState({
                        balance: adResult.data.new_balance,
                        ads_watched_today: adResult.data.new_ads_count
                    });
                    
                    if (referrerId) {
                        fetchApi({
                            type: 'commission',
                            referrer_id: referrerId,
                            referee_id: tgUser.id
                        }).then(r => {
                            if (r.ok) { console.log('Commission sent successfully.'); }
                            else { console.warn('Commission failed to send:', r.error); }
                        });
                    }
                    
                    let alertTitle = 'Reward Granted!';
                    let alertType = 'success';
                    let alertMessage = `You received ${Number(actualReward || 0).toLocaleString('en-US')} SHIB for watching the ad.`;

                    if(adResult.data.new_ads_count >= DAILY_MAX){
                        alertTitle = 'Daily Task Completed!';
                        alertMessage = `Congratulations! You have completed all today's ads (${DAILY_MAX}). Come back later.`;
                    }

                    // Provide both an English toast and also a smaller server-synced message
                    showCustomAlert(alertTitle, alertMessage, alertType);
                } else {
                    showCustomAlert('Reward Error', 'Server did not return reward details. Please try again.', 'error');
                    await loadUserData();
                }
            } catch (e) {
                console.error("AdsGram Ad sequence failed:", e);
                if (typeof e === 'string' && e.includes('canceled')) {
                    showCustomAlert('Ad Cancelled', 'The ad sequence was interrupted. Watch the full ad to receive the reward.', 'warning');
                } else {
                    showCustomAlert('Ad Load Failed', 'One of the ads failed to load. Please try again.', 'error');
                }
            } finally {
                // ensure UI is consistent
                await loadUserData();
            }
        }
        // ***************************************************************
        // END OF UPDATED watchAds FUNCTION
        // ***************************************************************
        
        function circleClick(){ console.log('Circle clicked'); }

        /* ===== Task Screen Functions (UPDATED LOGIC with dynamic tasks) ===== */

        async function fetchTasks() {
            const res = await fetchApi({ type: 'getTasks' });
            if (res.ok && Array.isArray(res.data.tasks)) {
                return res.data.tasks;
            }
            return [];
        }

        async function fetchTask(taskId) {
            const tasks = await fetchTasks();
            return tasks.find(t => parseInt(t.task_id) === parseInt(taskId)) || null;
        }

        function normalizeTaskLink(link) {
            if (!link) return '';
            link = link.trim();
            if (/^t\.me\//i.test(link)) {
                return 'https://' + link;
            }
            if (/^@/.test(link)) {
                return 'https://t.me/' + link.substring(1);
            }
            if (!/^https?:\/\//i.test(link)) {
                return 'https://' + link;
            }
            return link;
        }

        function openExternalLink(link) {
            if (!link) return false;
            const normalized = normalizeTaskLink(link);
            try {
                if (typeof Telegram !== 'undefined' && Telegram.WebApp && typeof Telegram.WebApp.openTelegramLink === 'function') {
                    Telegram.WebApp.openTelegramLink(normalized);
                    return true;
                } else {
                    window.open(normalized, '_blank');
                    return true;
                }
            } catch (e) {
                console.warn('Failed to open link via WebApp, fallback to window.open:', e);
                try { window.open(normalized, '_blank'); return true; } catch (err) { return false; }
            }
        }

        function renderTasksList(tasks) {
            const container = document.getElementById('taskListContainer');
            const noChannelNotice = document.getElementById('noChannelTasksNotice');
            if (!container) return;

            const availableTasks = Array.isArray(tasks) ? tasks.filter(t => !t.is_completed) : [];

            if (!Array.isArray(availableTasks) || availableTasks.length === 0) {
                container.innerHTML = `
                    <div class="task-item-card">
                        <div class="task-left">
                            <span class="task-dot" aria-hidden="true"></span>
                            <div class="task-text-info">
                                <div class="task-name">No tasks now</div>
                                <div class="task-meta">Check again later.</div>
                            </div>
                        </div>
                    </div>
                `;
                if (noChannelNotice) noChannelNotice.style.display = 'none';
                return;
            }

            if (noChannelNotice) noChannelNotice.style.display = 'none';

            const html = availableTasks.map(t => {
                const rewardText = `Reward: ${Number(t.reward || 0).toLocaleString('en-US')} SHIB`;
                const safeLink = (t.link || '').replace(/"/g, '&quot;');
                const name = escapeHtml(t.name || 'Task');
                return `
                    <div class="task-item-card" data-task-id="${t.task_id}">
                        <div class="task-left">
                            <span class="task-dot" aria-hidden="true"></span>
                            <div class="task-text-info">
                                <div class="task-name">${name}</div>
                                <div class="task-meta"><span class="task-reward">${escapeHtml(rewardText)}</span></div>
                            </div>
                        </div>
                        <button class="task-action-btn-new" data-task-link="${safeLink}" data-task-id="${t.task_id}" onclick="onTaskButtonClick(event)">Open</button>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        async function onTaskButtonClick(event) {
            event = event || window.event;
            const btn = event.currentTarget || event.target;
            const taskId = btn.getAttribute('data-task-id');
            const taskLink = btn.getAttribute('data-task-link') || '';

            if (!taskId) {
                showCustomAlert('Task Error', 'Task id not found on this button.', 'error');
                return;
            }

            if (btn.dataset.locked === '1') {
                return;
            }

            const btnText = (btn.textContent || '').trim().toLowerCase();
            if (btnText === 'claim') {
                btn.dataset.locked = '1';
                btn.disabled = true;

                if (isProcessingTask) {
                    btn.dataset.locked = '0';
                    btn.disabled = false;
                    return;
                }

                const task = await fetchTask(taskId);
                if (!task) {
                    btn.dataset.locked = '0';
                    btn.disabled = false;
                    showCustomAlert('Task Error', 'Selected task not found. Please refresh the tasks list.', 'error');
                    return;
                }
                currentTask = {
                    id: parseInt(task.task_id),
                    name: task.name,
                    link: task.link,
                    reward: task.reward,
                    is_completed: !!task.is_completed
                };

                if (currentTask.is_completed) {
                    const el = document.querySelector(`div[data-task-id="${taskId}"]`);
                    if (el) el.remove();
                    btn.dataset.locked = '0';
                    btn.disabled = false;
                    showCustomAlert('Task Completed!', 'Reward already claimed for this task.', 'warning');
                    return;
                }

                claimTaskReward();
                return;
            }

            const task = await fetchTask(taskId);
            if (!task) {
                showCustomAlert('Task Error', 'Selected task not found. Please refresh the tasks list.', 'error');
                return;
            }

            currentTask = {
                id: parseInt(task.task_id),
                name: task.name,
                link: task.link,
                reward: task.reward,
                is_completed: !!task.is_completed
            };

            if (currentTask.is_completed) {
                const el = document.querySelector(`div[data-task-id="${taskId}"]`);
                if (el) el.remove();
                showCustomAlert('Task Completed!', 'Reward already claimed for this task.', 'warning');
                return;
            }

            if (taskLink && taskLink.trim() !== '') {
                const opened = openExternalLink(taskLink);
                if (opened) {
                    btn.textContent = 'Claim';
                    showCustomAlert('Opened Task', `The task has been opened. After joining press "Claim" to receive ${Number(currentTask.reward || 0).toLocaleString('en-US')} SHIB.`, 'info');
                    btn.dataset.locked = '0';
                    btn.disabled = false;
                } else {
                    showCustomAlert('Open Link Failed', 'Unable to open the link. Please try manually.', 'error');
                }
            } else {
                btn.textContent = 'Claim';
                showCustomAlert('No Link', 'This task has no join link. Press Claim to attempt verification.', 'warning');
                btn.dataset.locked = '0';
                btn.disabled = false;
            }
        }

        async function selectTask(taskId) {
            const btn = document.querySelector(`#taskListContainer button[data-task-id="${taskId}"]`);
            if (btn) {
                btn.click();
                return;
            }
            const task = await fetchTask(taskId);
            if (!task) {
                showCustomAlert('Task Error', 'Selected task not found. Please refresh the tasks list.', 'error');
                return;
            }
            currentTask = {
                id: parseInt(task.task_id),
                name: task.name,
                link: task.link,
                reward: task.reward,
                is_completed: !!task.is_completed
            };
            showCustomAlert('Task Selected', `Selected: ${currentTask.name}\nReward: ${Number(currentTask.reward || 0).toLocaleString('en-US')} SHIB`, 'info');
        }

        async function showTask(){
            if (isBanned) {
                 showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                 return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('taskScreen').classList.add('visible');

            const tasks = await fetchTasks();
            renderTasksList(tasks);

            loadTaskLinkProgressFromStorage();
            updateTaskLinkUI();

            currentTask = null;

            loadUserData();
        }

        function hideTask(){
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
                isProcessingTask = false;
                taskActionState = currentTask && currentTask.is_completed ? 'COMPLETED' : 'JOIN_OR_CLAIM';
                updateUI();
            }
            document.getElementById('taskScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }

        async function claimTaskReward(){
            const taskBtn = currentTask ? document.querySelector(`button[data-task-id="${currentTask.id}"]`) : null;

            if (isBanned) {
                 showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                 return;
            }
            if (isProcessingTask) return; 
            if (!currentTask) {
                showCustomAlert('No Task Selected', 'Please select a task from the list first.', 'warning');
                return;
            }

            if (taskBtn) {
                taskBtn.dataset.locked = '1';
                taskBtn.disabled = true;
            }

            isProcessingTask = true;
            updateUI(); 

            const countdownTime = 5; 
            let countdown = countdownTime; 
            
            if (taskBtn) taskBtn.textContent = countdown;
            
            countdownInterval = setInterval(() => {
                countdown--;
                if (countdown >= 0) {
                    if (taskBtn) taskBtn.textContent = countdown;
                    if(countdownTime - countdown > 1){
                         showCustomAlert('Verifying Membership...', `Please wait ${countdown} seconds for channel membership verification.`, 'info');
                    }
                } else {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    if (taskBtn) taskBtn.textContent = 'Verifying...';
                    showCustomAlert('Verifying...', 'Contacting server to confirm membership and claim reward.', 'info');

                    verifyAndClaim();
                }
            }, 1000);
            
        }

        async function verifyAndClaim() {
            const taskBtn = currentTask ? document.querySelector(`button[data-task-id="${currentTask.id}"]`) : null;

            if (!currentTask) {
                isProcessingTask = false;
                showCustomAlert('No Task Selected', 'Select a task before claiming.', 'warning');
                if (taskBtn) {
                    taskBtn.dataset.locked = '0';
                    taskBtn.disabled = false;
                }
                return;
            }

            const taskId = currentTask.id;

            const actionId = await requestActionId(`completeTask_${taskId}`);
            if (!actionId) {
                isProcessingTask = false;
                taskActionState = 'JOIN_OR_CLAIM';
                if (taskBtn) {
                    taskBtn.dataset.locked = '0';
                    taskBtn.disabled = false;
                }
                updateUI();
                return;
            }

            const result = await fetchApi({
                type: 'completeTask',
                action_id: actionId,
                task_id: taskId
            });
            
            isProcessingTask = false;

            if (result.ok) {
                updateState({ 
                    balance: result.data.new_balance
                });

                if (currentTask) currentTask.is_completed = true;

                const el = document.querySelector(`div[data-task-id="${taskId}"]`);
                if (el) el.remove();

                const tasks = await fetchTasks();
                renderTasksList(tasks);

                showCustomAlert('Reward Claimed!', `You received ${Number(result.data.actual_reward || currentTask.reward || 0).toLocaleString('en-US')} SHIB for completing the task!`, 'success');
                
            } else {
                await loadUserData();
                const tasks = await fetchTasks();
                renderTasksList(tasks);
                taskActionState = 'JOIN_OR_CLAIM';
                if (taskBtn) taskBtn.textContent = 'Open';
            }

            if (taskBtn) {
                taskBtn.dataset.locked = '0';
                taskBtn.disabled = false;
            }

            updateUI();
        }

        function handleTaskAction() {
            const taskBtn = document.getElementById('taskActionBtn');

            if (!currentTask) {
                showCustomAlert('No Task Selected', 'Please choose a task from the list first.', 'warning');
                return;
            }
            
            if (currentTask.is_completed) {
                showCustomAlert('Task Completed!', 'Reward already claimed for this task.', 'warning');
                return;
            }
            
            if (isProcessingTask) return;
            
            const channelLink = currentTask.link || '';

            if (taskActionState === 'JOIN_OR_CLAIM') {
                if (channelLink && typeof Telegram.WebApp.openTelegramLink === 'function') {
                     Telegram.WebApp.openTelegramLink(channelLink);
                } else if (channelLink) {
                     window.open(channelLink, '_blank');
                } else {
                     showCustomAlert('No Link', 'This task has no join link. Click Claim to verify.', 'warning');
                }
                
                setTimeout(() => {
                    taskActionState = 'CLAIM'; 
                    if (taskBtn) {
                        taskBtn.disabled = false;
                        taskBtn.textContent = 'Claim';
                    }
                    showCustomAlert('Action Required', 'Please ensure you joined the channel. Click the button again to start the reward verification.', 'info');
                }, 1500);


            } else if (taskActionState === 'CLAIM') {
                claimTaskReward();
            }
        }

        /* ===== Invite Screen Functions (No changes needed) ===== */
        
        function inviteFriends() {
            if (isBanned) {
                 showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                 return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('inviteScreen').classList.add('visible');
            generateReferralLink();
            loadUserData();
        }

        function hideInvite(){
            document.getElementById('inviteScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }
        
        function generateReferralLink() {
            const referralLinkInput = document.getElementById('referralLinkInput');
            
            if (!tgUser) {
                referralLinkInput.value = 'User data not available.';
                return;
            }
            
            const userId = tgUser.id;
            const botPath = "Bot_ad_watchbot/earn"; 
            const inviteLink = `https://t.me/${botPath}?startapp=ref_${userId}`;
            
            referralLinkInput.value = inviteLink;
        }

        function copyReferralLink() {
            const inviteLink = document.getElementById('referralLinkInput').value;
            
            if (inviteLink === 'User data not available.' || inviteLink === 'Generating Link...') {
                showCustomAlert('Error!', 'The referral link is not ready yet. Please wait a moment.', 'warning');
                return;
            }

            navigator.clipboard.writeText(inviteLink).then(() => {
                try { Telegram.WebApp.HapticFeedback.notificationOccurred('success'); } catch(e){}
                showCustomAlert('Link Copied!', 'The referral link has been copied to the clipboard.', 'success');
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                showCustomAlert('Copy Failed!', 'Failed to copy the link. Please try again.', 'error');
            });
        }

        function shareReferralLink() {
            const inviteLink = document.getElementById('referralLinkInput').value;

            if (inviteLink === 'User data not available.' || inviteLink === 'Generating Link...' || inviteLink === 'Generating link...') {
                showCustomAlert('Link not ready', 'Please wait a moment until your invite link is generated.', 'warning');
                return;
            }

            const message = `Join me using my invite link:\n${inviteLink}`;
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${encodeURIComponent(message)}`;

            // Prefer native share where available
            if (navigator.share) {
                navigator.share({ title: 'Invite Link', text: message, url: inviteLink }).catch(()=>{});
            }

            try {
                if (window.Telegram && Telegram.WebApp) {
                    if (Telegram.WebApp.openTelegramLink) {
                        Telegram.WebApp.openTelegramLink(shareUrl);
                    } else if (Telegram.WebApp.openLink) {
                        Telegram.WebApp.openLink(shareUrl);
                    } else {
                        window.open(shareUrl, '_blank');
                    }
                    try { Telegram.WebApp.HapticFeedback.impactOccurred('light'); } catch(e){}
                } else {
                    window.open(shareUrl, '_blank');
                }
            } catch (e) {
                window.open(shareUrl, '_blank');
            }
        }

        /* ===== End of Invite Screen Functions ===== */


        /* ===== Spin Wheel (Wheel Code) ===== */
        const colors = ['#00bfff', '#ff8c00', '#28a745', '#ff4500', '#00f2fe'];
        const prizeValues = sectors; 
        const canvas = document.getElementById('wheelCanvas');
        const wheelBox = document.getElementById('wheelBox');
        const ctx = canvas.getContext('2d');
        const spinResult = document.getElementById('spinResult');
        const spinBtn    = document.getElementById('spinBtn'); 
        let spinning = false;
        let wheelAnimating = false;
        let currentAngle = 0;
        if (wheelBox) wheelBox.classList.add('idle');

        // Preload the icon that will be drawn into every sector (35x35 target)
        const wheelIcon = new Image();
        wheelIcon.crossOrigin = "anonymous";
        wheelIcon.src = 'https://files.catbox.moe/4se3k0.jpg';
        let wheelIconLoaded = false;
        wheelIcon.onload = () => { wheelIconLoaded = true; drawWheel(); };
        wheelIcon.onerror = () => { wheelIconLoaded = false; console.warn('Wheel icon failed to load; emoji fallback will be used.'); drawWheel(); };

        function drawWheel() {
            if (!ctx) return;

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 130;
            const sectorCount = sectors.length;
            const arc = (2 * Math.PI) / sectorCount;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Smoother edges / premium rendering
            ctx.imageSmoothingEnabled = true;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';

            // ---- Sectors (keep SAME colors, add subtle depth) ----
            sectors.forEach((val, i) => {
                const start = i * arc - Math.PI / 2;
                const end = start + arc;

                // Base sector fill (no color changes)
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, start, end);
                ctx.closePath();

                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();

                // Subtle 3D shading overlay (white/black alpha only)
                ctx.clip();
                const shade = ctx.createRadialGradient(
                    centerX - radius * 0.28, centerY - radius * 0.32, radius * 0.12,
                    centerX, centerY, radius
                );
                shade.addColorStop(0.00, 'rgba(255,255,255,0.22)');
                shade.addColorStop(0.45, 'rgba(255,255,255,0.04)');
                shade.addColorStop(0.80, 'rgba(0,0,0,0.10)');
                shade.addColorStop(1.00, 'rgba(0,0,0,0.20)');
                ctx.fillStyle = shade;
                ctx.fillRect(centerX - radius - 8, centerY - radius - 8, (radius + 8) * 2, (radius + 8) * 2);

                // Very light outer-edge gloss (keeps color, adds polish)
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius - 1.5, start, end);
                ctx.lineWidth = 3;
                ctx.strokeStyle = 'rgba(255,255,255,0.10)';
                ctx.stroke();

                // Shiba icon (same as before, no labels)
                const angle = start + arc / 2;
                const imgX = centerX + radius * 0.56 * Math.cos(angle);
                const imgY = centerY + radius * 0.56 * Math.sin(angle);
                const iconSize = 34;

                // soft shadow under the badge (neutral)
                ctx.save();
                ctx.shadowColor = 'rgba(0,0,0,0.22)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 4;
                ctx.beginPath();
                ctx.arc(imgX, imgY, iconSize / 2 + 2, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0,0,0,0.03)';
                ctx.fill();
                ctx.restore();

                if (wheelIconLoaded) {
                    try {
                        // circular clip for the icon
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(imgX, imgY, iconSize / 2, 0, Math.PI * 2);
                        ctx.closePath();
                        ctx.clip();
                        ctx.drawImage(wheelIcon, imgX - iconSize / 2, imgY - iconSize / 2, iconSize, iconSize);
                        ctx.restore();

                        // refined badge ring (soft, not harsh)
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(imgX, imgY, iconSize / 2 + 1, 0, Math.PI * 2);
                        ctx.strokeStyle = 'rgba(255,255,255,0.70)';
                        ctx.lineWidth = 1.5;
                        ctx.shadowColor = 'rgba(255,255,255,0.10)';
                        ctx.shadowBlur = 6;
                        ctx.stroke();

                        // tiny highlight arc
                        ctx.beginPath();
                        ctx.arc(imgX, imgY, iconSize / 2 + 0.4, -Math.PI * 0.85, -Math.PI * 0.10);
                        ctx.strokeStyle = 'rgba(255,255,255,0.22)';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        ctx.restore();
                    } catch (e) {
                        // fallback emoji (Shiba)
                        ctx.save();
                        ctx.translate(imgX, imgY);
                        ctx.rotate(angle + Math.PI / 2);
                        ctx.fillStyle = '#000';
                        ctx.fillText('üê∂', 0, 0);
                        ctx.restore();
                    }
                } else {
                    ctx.save();
                    ctx.translate(imgX, imgY);
                    ctx.rotate(angle + Math.PI / 2);
                    ctx.fillStyle = '#000';
                    ctx.fillText('üê∂', 0, 0);
                    ctx.restore();
                }

                ctx.restore();
            });

            // ---- Soft section separation (no harsh/raised lines) ----
            ctx.save();
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // soft highlight line (very subtle)
            ctx.strokeStyle = 'rgba(255,255,255,0.16)';
            ctx.lineWidth = 1.35;
            ctx.shadowColor = 'rgba(255,255,255,0.10)';
            ctx.shadowBlur = 6;
            for (let i = 0; i < sectorCount; i++) {
                const a = i * arc - Math.PI / 2;
                const r0 = 18;           // leave center clean
                const r1 = radius - 3;   // avoid harsh outer edge
                ctx.beginPath();
                ctx.moveTo(centerX + r0 * Math.cos(a), centerY + r0 * Math.sin(a));
                ctx.lineTo(centerX + r1 * Math.cos(a), centerY + r1 * Math.sin(a));
                ctx.stroke();
            }

            // soft shade line for gentle depth
            ctx.shadowColor = 'rgba(0,0,0,0.12)';
            ctx.shadowBlur = 8;
            ctx.strokeStyle = 'rgba(0,0,0,0.10)';
            ctx.lineWidth = 1.05;
            for (let i = 0; i < sectorCount; i++) {
                const a = i * arc - Math.PI / 2;
                const r0 = 18;
                const r1 = radius - 4;
                const off = 0.012;
                ctx.beginPath();
                ctx.moveTo(centerX + r0 * Math.cos(a + off), centerY + r0 * Math.sin(a + off));
                ctx.lineTo(centerX + r1 * Math.cos(a + off), centerY + r1 * Math.sin(a + off));
                ctx.stroke();
            }

            ctx.restore();

            // ---- Global inner shadow (subtle depth) ----
            ctx.save();
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.clip();

            const innerShadow = ctx.createRadialGradient(centerX, centerY, radius * 0.55, centerX, centerY, radius);
            innerShadow.addColorStop(0.00, 'rgba(0,0,0,0.00)');
            innerShadow.addColorStop(0.72, 'rgba(0,0,0,0.00)');
            innerShadow.addColorStop(1.00, 'rgba(0,0,0,0.22)');
            ctx.fillStyle = innerShadow;
            ctx.fillRect(centerX - radius - 10, centerY - radius - 10, (radius + 10) * 2, (radius + 10) * 2);
            ctx.restore();

            // ---- Light glossy highlight (screen blend, very subtle) ----
            ctx.save();
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.clip();

            ctx.globalCompositeOperation = 'screen';
            const gloss = ctx.createLinearGradient(centerX - radius, centerY - radius, centerX + radius, centerY + radius);
            gloss.addColorStop(0.00, 'rgba(255,255,255,0.00)');
            gloss.addColorStop(0.24, 'rgba(255,255,255,0.05)');
            gloss.addColorStop(0.35, 'rgba(255,255,255,0.10)');
            gloss.addColorStop(0.55, 'rgba(255,255,255,0.03)');
            gloss.addColorStop(1.00, 'rgba(255,255,255,0.00)');
            ctx.fillStyle = gloss;
            ctx.fillRect(centerX - radius, centerY - radius, radius * 2, radius * 2);

            ctx.globalCompositeOperation = 'source-over';
            ctx.restore();

            // ---- Refined outer ring (beveled rim) ----
            // Outer rim shadow
            ctx.save();
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius + 7, 0, 2 * Math.PI);
            ctx.lineWidth = 14;
            ctx.shadowColor = 'rgba(0,0,0,0.26)';
            ctx.shadowBlur = 14;
            ctx.shadowOffsetY = 6;
            ctx.strokeStyle = 'rgba(0,0,0,0.10)';
            ctx.stroke();
            ctx.restore();

            // Outer rim highlight / bevel
            ctx.save();
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius + 6, 0, 2 * Math.PI);
            ctx.lineWidth = 12;
            const rim = ctx.createRadialGradient(centerX, centerY, radius + 1, centerX, centerY, radius + 12);
            rim.addColorStop(0.00, 'rgba(255,255,255,0.70)');
            rim.addColorStop(0.55, 'rgba(255,255,255,0.18)');
            rim.addColorStop(1.00, 'rgba(0,0,0,0.22)');
            ctx.strokeStyle = rim;
            ctx.stroke();
            ctx.restore();

            // Inner rim line (crisp edge)
            ctx.save();
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius - 0.5, 0, 2 * Math.PI);
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'rgba(255,255,255,0.30)';
            ctx.stroke();
            ctx.restore();

            // ---- Center decoration (kept as-is, no text/icons) ----
            ctx.beginPath();
            ctx.fillStyle = '#fff';
            ctx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
            ctx.fill();
            ctx.strokeStyle = '#ff3366';
            ctx.lineWidth = 4;
            ctx.stroke();

            ctx.beginPath();
            ctx.fillStyle = '#ff3366';
            ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
            ctx.fill();

            ctx.shadowColor = 'transparent';
        }
        drawWheel();

        async function startSpin(){
            if(spinning) return;
            
            if (isBanned) {
                 showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                 return;
            }
            
            if (spinsToday >= DAILY_MAX_SPINS) {
                showCustomAlert('Daily Limit Reached', `You have used all spins for today (${DAILY_MAX_SPINS}).`, 'warning');
                return;
            }
            
            const preSpinActionId = await requestActionId('preSpin');
            if (!preSpinActionId) return;

            const preSpinReqResult = await fetchApi({ 
                type: 'preSpin',
                action_id: preSpinActionId
            });

            if (!preSpinReqResult.ok) {
                await loadUserData(); 
                return; 
            }
            
            const spinResultActionId = await requestActionId('spinResult');
            if (!spinResultActionId) {
                showCustomAlert('Security Error!', 'Failed to get confirmation token. Please try again.', 'error');
                await loadUserData(); 
                return;
            }
            
            try {
                await show_10245709();
                await show_10245709();

                spinning = true;
                spinBtn.disabled = true;
                spinResult.textContent = '';
canvas.classList.add('spinning');

                const spinResultRes = await fetchApi({ 
                    type: 'spinResult',
                    action_id: spinResultActionId
                });
                
                if (spinResultRes.ok) {
                    const finalPrize = spinResultRes.data.actual_prize;
                    const prizeIndex = spinResultRes.data.prize_index !== undefined ? spinResultRes.data.prize_index : 0; 
                    
                    const sectorCount = sectors.length; 
                    const arc = 2 * Math.PI / sectorCount; 
                    
                    const winningAngle = prizeIndex * arc + arc / 2; 
                    
                    let rotationToApply = Math.PI / 2 - winningAngle;
                    
                    rotationToApply = rotationToApply + (5 * 2 * Math.PI); 
                    
                    currentAngle += rotationToApply;

                                        // Premium spin motion: ease-out with a very subtle bounce
                    wheelAnimating = true;
                    const startAngle = currentAngle - rotationToApply;
                    const targetAngle = currentAngle;
                    const bounce = Math.PI / 120; // ~1.5deg, very subtle

                    const finalizeSpin = async () => {
                        canvas.style.transition = '';
                        canvas.style.transform = `rotate(${targetAngle}rad)`;
                        canvas.classList.remove('spinning');
                        if (wheelBox) {
                            wheelBox.classList.remove('spinning');
                            wheelBox.classList.add('idle');
                        }
                      
                        updateState({ 
                            balance: spinResultRes.data.new_balance,
                            spins_today: spinResultRes.data.new_spins_count
                        });
                        
                        spinResult.textContent = '';
showCustomAlert('Congratulations!', `You won ${Number(finalPrize || 0).toLocaleString('en-US')} SHIB!`, 'success');
                        
                        await loadUserData();
                        // unlock UI after wheel settles
                        wheelAnimating = false;
                        spinning = false;
                        if (spinBtn) spinBtn.disabled = false;
                        updateUI();
                    };

                    // start visual states
                    if (wheelBox) {
                        wheelBox.classList.add('spinning');
                        wheelBox.classList.remove('idle');
                        wheelBox.classList.add('spin-flash');
                        setTimeout(() => wheelBox.classList.remove('spin-flash'), 650);
                    }

                    if (canvas.animate) {
                        // cancel any previous animations
                        canvas.getAnimations().forEach(a => a.cancel());
                        const anim = canvas.animate(
                            [
                                { transform: `rotate(${startAngle}rad)`, offset: 0 },
                                { transform: `rotate(${targetAngle + bounce}rad)`, offset: 0.95, easing: 'cubic-bezier(0.22,0,0.2,1)' },
                                { transform: `rotate(${targetAngle}rad)`, offset: 1, easing: 'cubic-bezier(0.2,1,0.2,1)' }
                            ],
                            { duration: 3200, fill: 'forwards' }
                        );
                        anim.onfinish = finalizeSpin;
                    } else {
                        // Fallback: CSS transition + tiny overshoot
                        canvas.style.transition = 'transform 3s cubic-bezier(0.22,0,0.2,1)';
                        requestAnimationFrame(() => {
                            canvas.style.transform = `rotate(${targetAngle + bounce}rad)`;
                        });
                        setTimeout(() => {
                            canvas.style.transition = 'transform 240ms cubic-bezier(0.2,1,0.2,1)';
                            canvas.style.transform = `rotate(${targetAngle}rad)`;
                        }, 2950);
                        setTimeout(finalizeSpin, 3200);
                    }
 

                } else {
                    canvas.classList.remove('spinning');
                    canvas.style.transition = '';
                    spinResult.textContent = '';
showCustomAlert('Error!', 'Error receiving prize from the server. Please try again.', 'error');
                    await loadUserData(); 
                }
            } catch (e) {
                console.error("AdsGram Ad failed to show or was dismissed:", e);
                if (typeof e === 'string' && e.includes('canceled')) {
                    showCustomAlert('Ad Cancelled', 'The ad was not watched completely. The attempt was not counted.', 'warning');
                } else {
                    showCustomAlert('Ad Load Failed', 'Ad failed to load. The attempt was not counted. Please try again.', 'error');
                }
                await loadUserData();
            } finally {
                // Avoid resetting while the wheel animation is running
                if (!wheelAnimating) {
                    // Ensure wheel and button are reset in error paths to prevent "freeze/ÿ™ÿπŸÑŸäŸÇ"
                    try {
                        canvas.classList.remove('spinning');
                        canvas.style.transition = '';
                    } catch (err) {}
                    spinning = false;
                    if (spinBtn) spinBtn.disabled = false;
                    updateUI();
                }
            }
        }

        /* ===== Navigation and Withdraw (No changes needed) ===== */
        function showSpin(){
            if (isBanned) {
                 showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                 return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('spinScreen').classList.add('visible');
            loadUserData();
            updateUI(); 
        }
        function hideSpin(){
            document.getElementById('spinScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }
        
        function showWithdraw(){
            if (isBanned) {
                 showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                 return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('withdrawScreen').classList.add('visible');
            loadUserData();
            displayWithdrawals(); 
        }
        
        function hideWithdraw(){
            document.getElementById('withdrawScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }
        
        function displayWithdrawals() {
            const container = document.getElementById('withdrawalHistoryContainer');
            if (!container) {
                return;
            }
            if (!withdrawalHistory || withdrawalHistory.length === 0) {
                container.innerHTML = '<div class="no-records">No withdrawal requests currently.</div>';
                return;
            }

            let tableHTML = '<table class="history-table">';
            tableHTML += '<thead><tr><th>Date</th><th>Amount (SHIB)</th><th>Status</th></tr></thead>';
            tableHTML += '<tbody>';

            withdrawalHistory.slice(0,5).forEach(record => {
                const statusText = record.status === 'pending' ? 'Pending' : 'Completed';
                const statusClass = record.status === 'pending' ? 'status-pending' : 'status-completed';
                const dest = record.binance_id ? record.binance_id : (record.faucetpay_email ? record.faucetpay_email : '-');
                tableHTML += `
                    <tr>
                        <td>${record.date}</td>
                        <td>${Number(record.amount).toLocaleString('en-US')}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function displayWithdrawalsFull() {
            mainScreen.classList.remove('visible');
            document.getElementById('withdrawScreen').classList.remove('visible');
            const screen = document.getElementById('withdrawHistoryScreen');
            const list = document.getElementById('withdrawHistoryList');
            screen.classList.add('visible');

            if (!withdrawalHistory || withdrawalHistory.length === 0) {
                list.innerHTML = `<div class="history-empty">No withdrawal records.</div>`;
                return;
            }

            const html = withdrawalHistory.map(rec => {
                const isBinance = !!rec.binance_id;
                const method = isBinance ? 'Binance' : (rec.faucetpay_email ? 'FaucetPay' : '‚Äî');
                const dest = isBinance ? rec.binance_id : (rec.faucetpay_email ? rec.faucetpay_email : '-');
                const statusText = rec.status === 'pending' ? 'Pending' : 'Completed';
                const statusClass = rec.status === 'pending' ? 'status-pending' : 'status-completed';
                return `
                    <div class="history-item">
                        <div class="left">
                            <div class="history-row"><strong>Date:</strong> <span>${escapeHtml(rec.date || '-') }</span></div>
                            <div class="history-row"><strong>Method:</strong> <span>${escapeHtml(method)}</span></div>
                            <div class="history-row history-dest"><strong>Dest:</strong> <span>${escapeHtml(dest)}</span></div>
                        </div>
                        <div class="right">
                            <div class="amount">${Number(rec.amount).toLocaleString('en-US')} SHIB</div>
                            <div class="${statusClass}">${statusText}</div>
                        </div>
                    </div>
                `;
            }).join('');
            list.innerHTML = html;
        }

        function closeWithdrawHistory(){
            document.getElementById('withdrawHistoryScreen').classList.remove('visible');
            document.getElementById('withdrawScreen').classList.add('visible');
            displayWithdrawals(); 
        }

        async function confirmWithdraw(){
            const btn = document.getElementById('withdrawRequestBtn');
            if (window.__withdrawSubmitting) return;
            window.__withdrawSubmitting = true;
            if (btn){
                btn.disabled = true;
                btn.classList.add('is-loading');
                btn.setAttribute('aria-busy','true');
            }
            try{
            if (isBanned) {
                 showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                 return;
            }
            
            const selectedMethod = document.querySelector('input[name="withdrawMethod"]:checked') ? document.querySelector('input[name="withdrawMethod"]:checked').value : 'binance';
            const binanceId = document.getElementById('binanceId').value.trim();
            const faucetpayEmail = document.getElementById('faucetpayEmail').value.trim();
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            
            if(selectedMethod === 'binance') {
                if(!binanceId || binanceId.length < 4){ 
                    showCustomAlert('Invalid Input!', 'Please enter a valid Binance User ID.', 'warning'); 
                    return; 
                }
            } else {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if(!faucetpayEmail || !emailRegex.test(faucetpayEmail)){
                    showCustomAlert('Invalid Input!', 'Please enter a valid FaucetPay email address.', 'warning'); 
                    return;
                }
            }

            if(isNaN(amount) || amount < 4000){ 
                showCustomAlert('Invalid Amount!', 'The minimum withdrawal amount is 4000 SHIB.', 'warning'); 
                return; 
            }
            if(amount > shibBalance){ 
                showCustomAlert('Balance Error!', `Your balance is insufficient. Your current balance is ${Number(shibBalance).toLocaleString('en-US')} SHIB.`, 'error'); 
                return; 
            }
            
            const actionId = await requestActionId('withdraw');
            if (!actionId) return;

            const payload = {
                type: 'withdraw',
                amount: amount,
                action_id: actionId
            };
            if (selectedMethod === 'faucetpay') {
                payload.faucetpay_email = faucetpayEmail;
            } else {
                payload.binanceId = binanceId;
            }

            const result = await fetchApi(payload);

            if (result.ok) {
                updateState({ balance: result.data.new_balance });
                
                await loadUserData(); 
                displayWithdrawals(); 
                
                const destText = selectedMethod === 'faucetpay' ? `FaucetPay: ${faucetpayEmail}` : `Binance ID: ${binanceId}`;
                showCustomAlert('Request Sent!', `Details:\n${destText}\nAmount: ${Number(amount).toLocaleString('en-US')} SHIB\n\nThe transfer will be processed within 24 hours.`, 'success');
            }
        
            } finally {
                window.__withdrawSubmitting = false;
                if (btn){
                    btn.classList.remove('is-loading');
                    btn.removeAttribute('aria-busy');
                }
                if (typeof updateWithdrawButtonState === 'function'){
                    updateWithdrawButtonState();
                }
            }
        }
        
        document.addEventListener('click', (e) => {
            const mBin = document.getElementById('methodBinance');
            const mFaucet = document.getElementById('methodFaucetpay');
            if (e.target.closest('#methodBinance')) {
                mBin.classList.add('active');
                mFaucet.classList.remove('active');
                document.getElementById('binanceGroup').style.display = 'block';
                document.getElementById('faucetpayGroup').style.display = 'none';
            } else if (e.target.closest('#methodFaucetpay')) {
                mFaucet.classList.add('active');
                mBin.classList.remove('active');
                document.getElementById('binanceGroup').style.display = 'none';
                document.getElementById('faucetpayGroup').style.display = 'block';
            }
        });
        // Update withdraw button state live while typing the amount
        document.addEventListener('input', (e) => {
            if (e && e.target && e.target.id === 'withdrawAmount') {
                updateWithdrawButtonState();
            }
        });



        

        // Quick amount chips (Min / presets / Max)
        document.addEventListener('click', (e) => {
            const chip = e.target && e.target.closest ? e.target.closest('[data-withdraw-chip]') : null;
            if (!chip) return;
            const amountEl = document.getElementById('withdrawAmount');
            if (!amountEl) return;
            const bal = Number(shibBalance || 0);
            let v = chip.getAttribute('data-withdraw-chip');
            let next = 0;
            if (v === 'max') next = bal;
            else next = Number(v);
            if (!Number.isFinite(next) || next <= 0) return;
            amountEl.value = Math.floor(next);
            amountEl.dispatchEvent(new Event('input', { bubbles: true }));
            amountEl.focus();
        });

// ===== Contest Functions (UPDATED to use server data for tickets and ranking) =====
        function showContest() {
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('contestScreen').classList.add('visible');
            startContestCountdown();
            loadContestData();
        }

        function hideContest() {
            clearInterval(contestCountdownInterval);
            document.getElementById('contestScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }

        function startContestCountdown() {
            contestCountdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = contestEndTime - now;

                if (distance < 0) {
                    clearInterval(contestCountdownInterval);
                    document.getElementById('contestCountdown').textContent = "Contest Ended";
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById('contestCountdown').textContent = 
                    `${days}d ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
            }, 1000);
        }

        // Load contest data (trusted from server). Server should return { my_tickets, all_tickets }.
        async function loadContestData() {
            const res = await fetchApi({ type: 'getContestData' });
            if (res.ok && res.data) {
                myTickets = res.data.my_tickets || 0;
                allTickets = res.data.all_tickets || 0;
                // if server returns contest time, update local countdown
                if (res.data && res.data.time && res.data.time.end_time) {
                    const end = new Date(res.data.time.end_time).getTime();
                    if (!isNaN(end)) {
                        contestEndTime = end;
                    }
                }
            } else {
                myTickets = 0;
                allTickets = 0;
            }
            updateContestUI();
        }

        function updateContestUI() {
            document.getElementById('myTickets').textContent = Number(myTickets || 0).toLocaleString('en-US');
            document.getElementById('allTickets').textContent = Number(allTickets || 0).toLocaleString('en-US');
        }

        async function watchContestAd() {
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }

            // Prevent automated/frequent clicks by locking the button for a short duration
            if (contestAdLocked) {
                showCustomAlert('Please wait', 'The contest watch button is temporarily locked to prevent abuse. Try again shortly.', 'warning');
                return;
            }

            const btn = document.querySelector('.contest-watch-btn');
            if (btn) {
                contestAdLocked = true;
                btn.disabled = true;
                btn.classList.add('locked');
            }

            const actionId = await requestActionId('contestWatchAd');
            if (!actionId) {
                if (btn) {
                    setTimeout(() => { contestAdLocked = false; btn.disabled = false; btn.classList.remove('locked'); }, 3000);
                }
                return;
            }

            try {
                await show_10245709();

                const result = await fetchApi({
                    type: 'contestWatchAd',
                    action_id: actionId
                });

                if (result.ok) {
                    // Update tickets from server's authoritative response
                    if (result.data) {
                        myTickets = result.data.my_tickets !== undefined ? result.data.my_tickets : myTickets;
                        allTickets = result.data.all_tickets !== undefined ? result.data.all_tickets : allTickets;
                    } else {
                        myTickets += 5; // fallback minimal update if server doesn't return structured data
                    }
                    updateContestUI();
                    showCustomAlert('Contest Reward!', `You earned 5 tickets! You now have ${Number(myTickets).toLocaleString('en-US')} tickets.`, 'success');
                } else {
                    showCustomAlert('Contest Error', 'Server did not confirm ticket reward. Please try again.', 'error');
                }
            } catch (e) {
                showCustomAlert('Ad Failed!', 'Ad failed to load. Please try again.', 'error');
            } finally {
                // Ensure unlock after a short delay to mitigate auto-clicking
                const btnEl = document.querySelector('.contest-watch-btn');
                setTimeout(() => {
                    contestAdLocked = false;
                    if (btnEl) {
                        btnEl.disabled = false;
                        btnEl.classList.remove('locked');
                    }
                }, 8000); // 8 seconds lock
            }
        }

        function showContestRank() {
            mainScreen.classList.remove('visible');
            document.getElementById('contestScreen').classList.remove('visible');
            document.getElementById('contestRankScreen').classList.add('visible');

            // Add class to body to hide duplicate top user info as requested
            document.body.classList.add('hide-top-user');

            loadContestRank();
        }

        function hideContestRank() {
            document.getElementById('contestRankScreen').classList.remove('visible');
            document.getElementById('contestScreen').classList.add('visible');

            // Remove the hiding class
            document.body.classList.remove('hide-top-user');
        }

        // Load ranking from server. Server must return { players: [ { first_name, photo_url, user_id, tickets, username } ] } ordered by rank.
        async function loadContestRank() {
            const res = await fetchApi({ type: 'getContestRank' });
            let players = [];
            if (res.ok && Array.isArray(res.data.players)) {
                players = res.data.players;
            } else {
                players = [];
            }

            const list = document.getElementById('contestRankList');
            const updatedAtEl = document.getElementById('rankUpdatedAt');
            const stampUpdated = () => {
                if (!updatedAtEl) return;
                updatedAtEl.textContent = `Updated: ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            };

            if (!list) return;

            if (!players || players.length === 0) {
                list.innerHTML = `<div style="text-align:center;color:#cfeeff;padding:20px;border-radius:14px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.10);">No entries yet.</div>`;
                renderPersonalUserBox(players);
                stampUpdated();
                return;
            }

            stampUpdated();

            // We'll use a single default avatar when photo is missing
            const DEFAULT_AVATAR = 'https://giftgogame.com/static/thumbnails/5170233102089322756.webp';

            // Current user id from Telegram init data (if available)
            const currentUserId = tgUser && tgUser.id ? String(tgUser.id) : null;

            // Build each row using required order and fields:
            // [ avatar(circle) | first_name (+ You if current) and username | user_id | tickets | rank ]
            list.innerHTML = players.map((player, index) => {
                const pos = index + 1;

                // Prefer explicit first_name sent by server; fallback to name or empty
                const firstNameRaw = player.first_name || player.name || '';
                const firstNameSafe = String(firstNameRaw).replace(/</g,'&lt;').replace(/>/g,'&gt;') || 'User';

                // Determine user id field (server should provide user_id only)
                const userIdRaw = player.user_id !== undefined ? player.user_id : (player.userId !== undefined ? player.userId : '');
                const userIdSafe = String(userIdRaw).replace(/</g,'&lt;').replace(/>/g,'&gt;');

                // Username (telegram handle) if provided by server
                const rawUsername = player.username || player.user_name || player.tg_username || '';
                const usernameSafe = String(rawUsername).replace(/</g,'&lt;').replace(/>/g,'&gt;');

                // Use photo_url field if present; fallback to avatar or default
                const photoUrl = player.photo_url || player.photo || player.avatar || '';

                // Use the provided photo_url for the current user if available (tgUser.photo_url)
                let avatarSrc = photoUrl || DEFAULT_AVATAR;
                if (currentUserId !== null && String(userIdRaw) === currentUserId) {
                    // override avatar for current user with Telegram WebApp photo_url if available
                    if (tgUser && tgUser.photo_url) {
                        avatarSrc = tgUser.photo_url;
                    }
                }

                // Tickets (server returns number)
                const tickets = Number(player.tickets || player.tickets_count || player.points || 0).toLocaleString('en-US');

                // Detect current user
                const isCurrent = currentUserId !== null && String(userIdRaw) === currentUserId;
                const rowClass = isCurrent ? 'contest-rank-item current-player' : 'contest-rank-item';

                // first_name display: show full first_name and append " (You)" visually next to the name (only text)
                const displayName = isCurrent ? `${firstNameSafe} (You)` : `${firstNameSafe}`;

                // username display (show @username if available)
                const usernameDisplay = usernameSafe ? `@${usernameSafe}` : '';

                // Construct safe HTML for the row with strict truncation rules applied via CSS
                // Note: tickets shown as number only per requirement (e.g., "400")
                return `
                    <div class="${rowClass}" data-rank="${pos}" role="article" aria-label="Player ${pos}">
                        <img src="${avatarSrc || DEFAULT_AVATAR}" class="contest-rank-avatar" alt="" onerror="this.onerror=null;this.src='${DEFAULT_AVATAR}'">
                        <div class="contest-rank-name" title="${firstNameSafe}">
                            <div class="name-main">${escapeHtml(displayName)}</div>
                            <div class="contest-rank-username">${escapeHtml(usernameDisplay)}</div>
                        </div>
                        <div class="contest-rank-userid" title="${userIdSafe}">${escapeHtml(userIdSafe)}</div>
                        <div class="contest-rank-tickets">${tickets}</div>
                        <div class="contest-rank-position">${pos}</div>
                    </div>
                `;
            }).join('');

            // After rendering, also render the personal user info box with data found in players (authoritative)
            renderPersonalUserBox(players);

            // After rendering, scroll to the current player's position (if present) for visibility
            if (currentUserId) {
                // small timeout to ensure DOM paints
                setTimeout(() => {
                    const el = list.querySelector('.contest-rank-item.current-player');
                    if (el) {
                        // smooth scroll into view within the rank container
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 120);
            }
        }

        // Render the personal user golden box using tgUser and authoritative players array when available

        /* ===== Leaderboard UI helpers removed (search/podium) ===== */



        function renderPersonalUserBox(players) {
            const box = document.getElementById('personalUserBox');
            const avatarEl = document.getElementById('personalAvatar');
            const idEl = document.getElementById('personalIdValue');
            const nameEl = document.getElementById('personalNameValue');
            const ticketsEl = document.getElementById('personalTicketsValue');
            const rankEl = document.getElementById('personalRankValue');

            // default hide
            if (!box || !tgUser) {
                if (box) box.style.display = 'none';
                return;
            }

            const currentUserId = String(tgUser.id);
            // find authoritative player entry if available
            let playerEntry = null;
            if (Array.isArray(players) && players.length > 0) {
                playerEntry = players.find(p => {
                    const pid = p.user_id !== undefined ? String(p.user_id) : (p.userId !== undefined ? String(p.userId) : '');
                    return pid === currentUserId;
                });
            }

            // Avatar priority: playerEntry.photo_url > tgUser.photo_url > default
            const DEFAULT_AVATAR = 'https://giftgogame.com/static/thumbnails/5170233102089322756.webp';
            let avatarSrc = DEFAULT_AVATAR;
            if (playerEntry && (playerEntry.photo_url || playerEntry.avatar || playerEntry.photo)) {
                avatarSrc = playerEntry.photo_url || playerEntry.avatar || playerEntry.photo;
            } else if (tgUser.photo_url) {
                avatarSrc = tgUser.photo_url;
            }

            // Username priority: playerEntry.first_name > tgUser.first_name > fallback
            let displayName = tgUser.first_name || 'User';
            if (playerEntry && (playerEntry.first_name || playerEntry.name)) {
                displayName = playerEntry.first_name || playerEntry.name;
            }

            // Tickets priority: playerEntry.tickets or myTickets
            let ticketCount = myTickets || 0;
            if (playerEntry && (playerEntry.tickets !== undefined || playerEntry.tickets_count !== undefined || playerEntry.points !== undefined)) {
                ticketCount = Number(playerEntry.tickets || playerEntry.tickets_count || playerEntry.points || 0);
            }

            // Compute rank if players array provided
            let rankText = '-';
            if (Array.isArray(players) && players.length > 0) {
                const idx = players.findIndex(p => {
                    const pid = p.user_id !== undefined ? String(p.user_id) : (p.userId !== undefined ? String(p.userId) : '');
                    return pid === currentUserId;
                });
                if (idx !== -1) rankText = (idx + 1).toString();
                else rankText = '-';
            }

            // ID display
            const userIdDisplay = currentUserId;

            // set DOM
            avatarEl.src = avatarSrc || DEFAULT_AVATAR;
            avatarEl.onerror = function(){ this.onerror=null; this.src = DEFAULT_AVATAR; };

            idEl.textContent = userIdDisplay;
            nameEl.textContent = displayName;
            ticketsEl.textContent = Number(ticketCount || 0).toLocaleString('en-US');
            rankEl.textContent = rankText;

            box.style.display = 'flex';
        }

        // Final event listener to ensure background audio starts on the first user interaction
        document.addEventListener('click', function handler() {
            playBGAudio();
            document.removeEventListener('click', handler);
        });
    </script>

<script>
/* Prevent double-tap to zoom (iOS Safari) */
(function(){
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function (event) {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive: false });
})();
</script>

</body>
</html>