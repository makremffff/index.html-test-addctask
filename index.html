ÿØ<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIB Ads WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap'); 

        :root{
            --primary:#4a90e2;
            --accent:#ff8c00;
            --danger:#ff2a2a;
            --success:#28a745;
            --bg:#0d0c1d;
            --card:#ffffff;
            --muted:#9aa4b2;
            --glass: rgba(255,255,255,0.06);
        }

        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%}
        body{font-family:'Vazirmatn', Arial, Helvetica, sans-serif;overflow:hidden;background: var(--bg);color:#111;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
        
        /* App container and screens */
        .app-screen {
            position: fixed;
            inset: 0;
            background: url('img.png') no-repeat center center;
            background-size: cover;
            transition: opacity .4s ease-in, transform .3s ease;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none; 
            z-index: 10; 
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 16px;
        }
        .app-screen.visible {
            opacity: 1;
            pointer-events: auto;
            z-index: 20; 
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity .5s ease-out;
            background: linear-gradient(180deg,#0b1630,#081223);
        }
        .loading-screen.hidden{opacity:0;pointer-events:none}

        .loader {
          --ANIMATION-DELAY-MULTIPLIER: 70ms;
          padding: 0;
          margin: 0;
          display: flex;
          flex-direction: row;
          justify-content: center;
          align-items: center;
          overflow: hidden;
        }

        .loader span {
          padding: 0;
          margin: 0 4px;
          letter-spacing: -5rem;
          transform: translateY(4rem);
          animation: hideAndSeek 1s alternate infinite cubic-bezier(0.86, 0, 0.07, 1);
        }

        .loader .l { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 0); color:#ff3b3b; }
        .loader .o { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 1); color:#ff8c00; }
        .loader .a { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 2); color:#ffd700; }
        .loader .d { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 3); color:#4caf50; }
        .loader .ispan { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 4); color:#00bfff; }
        .loader .n { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 5); color:#6a5acd; }
        .loader .g { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 6); color:#ff1493; }

        .letter {
          width: fit-content;
          height: 3rem;
        }

        @keyframes hideAndSeek {
          0% { transform: translateY(4rem); opacity:0 }
          100% { transform: translateY(0rem); opacity:1 }
        }

        /* Top bar & user info */
        .topbar {
            position: absolute;
            left: 0;
            right: 0;
            top: 6px;
            display:flex;
            align-items:center;
            gap:10px;
            padding: 0 14px;
            z-index: 100;
            pointer-events:none;
        }
        .user-wrap { display:flex; gap:10px; align-items:center; pointer-events:auto;}
        .user-circle{
            width:56px;height:56px;border-radius:50%;border:2px dashed rgba(255,255,255,0.12);
            display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.1));
            overflow:hidden;cursor:pointer;transition:all .18s ease; flex:0 0 56px;
        }
        .user-circle:hover{transform:translateY(-3px)}
        .user-circle img{width:100%;height:100%;object-fit:cover;border-radius:50%;display:block}
        .user-meta { color:#e6f0ff; font-size:13px; line-height:1; pointer-events:none; max-width:170px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
        .user-meta .name { font-weight:700; color:#fff; display:block; font-size:14px }
        .user-meta .id { color:var(--muted); font-size:12px }

        .balance-wrap { margin-left:auto; display:flex; align-items:center; gap:10px; pointer-events:auto; }
        .balance { background:#0f1724;border:1px solid rgba(255,255,255,0.04);border-radius:12px;padding:8px 12px;font-family:'Courier New',monospace;font-size:15px;color:#fff; z-index:101;box-shadow:0 4px 12px rgba(0,0,0,.6)}
        .session-badge { padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700; color:#fff; display:inline-block; margin-right:8px; min-width:86px; text-align:center; }
        .session-normal { background: linear-gradient(90deg,#2ecc71,#10b981); }
        .session-cooldown { background: linear-gradient(90deg,#f59e0b,#f97316); }
        .session-suspicious { background: linear-gradient(90deg,#ef4444,#dc2626); }

        /* Progress containers */
        .progress-group-container {
            position: absolute;
            top: 82px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 92%;
            max-width: 440px;
            z-index: 102;
            pointer-events:auto;
        }
        .progress-card {
            background: rgba(255,255,255,0.06);
            padding:12px;
            border-radius:12px;
            display:flex;
            flex-direction:column;
            gap:6px;
            border:1px solid rgba(255,255,255,0.03);
            box-shadow: 0 6px 18px rgba(2,6,23,0.6);
        }
        .progress-title { font-weight:800; color:#e6f7ff; font-size:13px; display:flex; justify-content:space-between; align-items:center }
        .progress-bar { width:100%; height:10px; background:rgba(255,255,255,0.06); border-radius:999px; overflow:hidden }
        .progress-fill { height:100%; background:linear-gradient(90deg,var(--accent),#ff3355); width:0%; transition:width .45s cubic-bezier(.2,.8,.2,1) }

        /* Main area */
        .main-content{flex:1;display:flex;justify-content:center;align-items:center;padding-top:180px}
        .card-center { width:100%; max-width:720px; padding:18px; border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.08)); border:1px solid rgba(255,255,255,0.03); box-shadow:0 20px 60px rgba(2,6,23,0.6); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:12px; }

        /* Button bar */
        .button-container{
            position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
            display:grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            background:rgba(255,255,255,0.02);padding:10px;border-radius:20px;
            width: 96%;
            max-width: 640px;
            box-shadow:0 8px 30px rgba(0,0,0,0.6);
            pointer-events:auto;
        }
        .nav-button{
            position:relative;background:linear-gradient(145deg,var(--primary),#2b6fb2);color:#fff;border:none;padding:10px 0;border-radius:10px;font-size:13px;font-weight:800;cursor:pointer;transition:all .12s ease;display:flex;align-items:center;justify-content:center;min-height:44px;
        }
        .nav-button:disabled{opacity:.5;cursor:not-allowed; transform:none}
        .nav-button .btn-loading { display:none; margin-left:8px; }
        .nav-button.locked { opacity:.6; pointer-events:none }

        .nav-button.task-btn{ background:linear-gradient(145deg,#ffc107,#ff9800); color:#111; }
        .nav-button.withdraw-btn-nav{ background:linear-gradient(145deg,#ff2a2a,#cc2121); }

        /* Task screen */
        .task-screen{
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content: flex-start; 
            padding-top: 80px; 
            padding-bottom: 120px; 
            overflow-y: auto;
            background: linear-gradient(180deg,#071026,#081430);
        }
        .task-header{ width:90%; max-width:420px; text-align:center; color:#fff; margin-bottom:12px}
        .task-title{ font-family: 'Vazirmatn', sans-serif; font-size:22px; color:#e6f7ff; font-weight:800; margin:0 }

        .task-content-container { width:100%; max-width:420px; padding:12px; display:flex; flex-direction:column; gap:10px; }
        .task-item-card { background: rgba(255,255,255,0.03); padding:12px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid rgba(255,255,255,0.02) }
        .task-text-info { color:#e6f7ff; font-size:15px; font-weight:700; }
        .task-action-btn-new { background:linear-gradient(145deg,#ff7a7a,#ff3b3b); border:none; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:800; min-width:88px; text-transform:none; box-shadow:0 6px 0 rgba(176,30,30,0.8); transition:transform .12s ease }
        .task-action-btn-new:disabled { opacity:.6; cursor:not-allowed; box-shadow:none }
        .task-action-btn-new.completed { background:linear-gradient(145deg,#28a745,#1e7e34); box-shadow:0 6px 0 #1c6d32}

        .task-link-container { background: rgba(255,255,255,0.03); padding:10px; border-radius:10px; display:flex; flex-direction:column; gap:8px; }
        .task-link-button { background:linear-gradient(145deg,#00bfff,#0077b3); color:#fff; padding:8px 12px; border-radius:8px; font-weight:800; box-shadow:0 6px 0 #005a8d; border:none; cursor:pointer; }

        .task-back-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background:linear-gradient(145deg, #6c757d, #5a6268);
            color:#fff;border:none;padding:12px 28px;border-radius:12px;font-size:15px;font-weight:800;cursor:pointer;box-shadow:0 6px 0 #4e555b;width:90%;max-width:350px;z-index:1000;
        }

        /* Spin screen */
        .spin-screen{
            display:flex;flex-direction:column;align-items:center;justify-content:center;padding-top:120px; transition:opacity .3s ease;background: linear-gradient(180deg,#041025,#071131);
        }
        #wheelBox{position:relative;margin-bottom:18px}
        #wheelCanvas{border-radius:50%; box-shadow:0 30px 80px rgba(0,0,0,0.7); background-color:#fff; border:2px solid #eee; transform-origin:center center; transition:transform 4s cubic-bezier(.22,0,.2,1); will-change:transform;}
        #wheelCanvas.spinning{ box-shadow:0 0 40px rgba(255, 102, 136, 0.25), 0 15px 35px rgba(0,0,0,0.4); }
        .arrow{ position:absolute; top:-18px; left:50%; transform:translateX(-50%); width:0;height:0; border-left:16px solid transparent; border-right:16px solid transparent; border-top:26px solid var(--accent); filter:drop-shadow(0 6px 12px rgba(0,0,0,.3)); z-index:10;}
        .spin-btn{background:linear-gradient(145deg,var(--accent),#ff3366);color:#fff;border:none;padding:12px 36px;border-radius:999px;font-size:16px;font-weight:800;cursor:pointer;box-shadow:0 8px 0 #b32b48}
        .spin-btn:disabled{opacity:.6; cursor:not-allowed}
        .spin-result{margin-top:12px;font-size:16px;color:#fff;text-align:center; min-height:40px}

        .spin-back{margin-top:16px;background:linear-gradient(145deg,#6c757d,#5a6268);color:#fff;border:none;padding:10px 22px;border-radius:8px;font-size:15px;font-weight:800;cursor:pointer;box-shadow:0 6px 0 #4e555b}

        /* Withdraw */
        .withdraw-screen{ display:flex; flex-direction:column; align-items:center; padding-top:90px; overflow-y:auto; background: linear-gradient(180deg,#071026,#081430) }
        .withdraw-header{ width:90%; max-width:420px; padding:12px; border-radius:12px; background: rgba(255,255,255,0.03); color:#fff; display:flex; flex-direction:column; gap:8px; align-items:center; }
        .input-form-container { width:100%; max-width:420px; background: rgba(255,255,255,0.02); padding:16px; border-radius:12px; border:1px solid rgba(255,255,255,0.03) }
        .input-group{ width:100%; margin-bottom:12px; display:flex; flex-direction:column; gap:6px; }
        .input-group label{ font-size:13px; color:#e6f7ff; font-weight:700 }
        .input-group input{ width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:#fff; outline:none; font-size:14px }
        .withdraw-buttons{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap }
        .withdraw-btn{ background:linear-gradient(145deg,#28a745,#1e7e34); color:#fff; border:none; padding:12px 18px; border-radius:10px; font-size:15px; font-weight:800; cursor:pointer; box-shadow:0 6px 0 #1c6d32 }
        .back-btn{ background:linear-gradient(145deg,#6c757d,#5a6268); color:#fff; border:none; padding:12px 18px; border-radius:10px; font-size:15px; font-weight:800; cursor:pointer; box-shadow:0 6px 0 #4e555b }
        .note{ margin-top:12px; font-size:13px; color:#cbd5e1; text-align:center; }

        /* Withdraw history full */
        .withdraw-history-full { display:flex; flex-direction:column; padding:20px 14px; overflow-y:auto; background:#f7f7fb }
        .history-list{ width:100%; max-width:720px; margin:0 auto; padding-bottom:60px }
        .history-item{ display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:10px; background:#fff; margin-bottom:10px; border:1px solid #eee }

        /* Invite */
        .invite-screen{ display:flex; flex-direction:column; align-items:center; padding-top:90px; overflow-y:auto; background: linear-gradient(180deg,#071026,#081430) }
        .invite-header{ width:90%; max-width:420px; padding:12px; border-radius:12px; background: rgba(255,255,255,0.03); color:#fff; display:flex; flex-direction:column; gap:8px; align-items:center; }
        .input-form-container .copy-link-btn{ background:linear-gradient(145deg,#00bfff,#0077b3); color:#fff; border:none; padding:12px 18px; border-radius:10px; font-weight:800; box-shadow:0 6px 0 #005a8d; width:100% }

        /* Contest screens */
        .contest-screen { display:flex; flex-direction:column; align-items:center; padding-top:40px; overflow-y:auto; background: linear-gradient(135deg,#001f3f,#003366); color:#fff }
        .contest-header { width:90%; max-width:420px; padding:12px; border-radius:12px; background: rgba(255,255,255,0.03); display:flex; flex-direction:column; gap:10px; align-items:center; }
        .prize-vertical-box { width:100%; max-width:320px; background: rgba(255,255,255,0.02); padding:10px; border-radius:12px; display:flex; flex-direction:column; gap:8px }
        .contest-buttons-horizontal { display:flex; gap:10px; margin-top:8px; }

        .contest-screen .contest-watch-btn, .contest-rank-btn { background:linear-gradient(145deg,#ff8c00,#ff4500); color:#fff; border:none; padding:10px 18px; border-radius:10px; font-weight:800; cursor:pointer; box-shadow:0 6px 0 #cc3700 }
        .contest-watch-btn.locked { opacity:.6; cursor:not-allowed; box-shadow:none }

        .contest-back-btn { position:fixed; bottom:16px; left:50%; transform:translateX(-50%); width:90%; max-width:360px; padding:12px 18px; border-radius:12px; background:linear-gradient(145deg,#6c757d,#5a6268); color:#fff; border:none; box-shadow:0 6px 0 #4e555b; font-weight:800 }

        /* Ranking screen */
        .contest-rank-screen { display:flex; flex-direction:column; padding:14px; overflow-y:auto; background: linear-gradient(135deg,#001f3f,#003366); color:#fff; align-items:center }
        .contest-rank-list { width:100%; max-width:720px; margin:0 auto; padding-bottom:60px }
        .contest-rank-item { display:flex; align-items:center; gap:12px; padding:10px; border-radius:12px; background: rgba(255,255,255,0.02); margin-bottom:10px; }
        .contest-rank-avatar { width:56px; height:56px; border-radius:50%; object-fit:cover; flex:0 0 56px }

        /* Toaster (inline, non-intrusive) */
        #toastContainer {
            position: fixed;
            right: 12px;
            bottom: 86px;
            display:flex;
            flex-direction:column;
            gap:8px;
            z-index: 999999;
            max-width: 92%;
        }
        .toast {
            background: rgba(0,0,0,0.72);
            color:#fff;
            padding:10px 12px;
            border-radius:10px;
            box-shadow:0 8px 30px rgba(2,6,23,0.6);
            font-weight:700;
            transform-origin:right bottom;
            animation: toastIn .18s ease;
            max-width:320px;
        }
        .toast.success { background: linear-gradient(90deg,#10b981,#059669) }
        .toast.error { background: linear-gradient(90deg,#ef4444,#dc2626) }
        .toast.warning { background: linear-gradient(90deg,#f59e0b,#f97316) }

        @keyframes toastIn { from { transform:translateY(6px) scale(.98); opacity:0 } to { transform:none; opacity:1 } }

        /* Small spinner used on buttons */
        .small-spinner {
            width:14px; height:14px; border-radius:50%; border:2px solid rgba(255,255,255,0.18); border-top-color:#fff; animation:spin .9s linear infinite; display:inline-block; vertical-align:middle;
        }
        @keyframes spin { to { transform:rotate(360deg) } }

        /* micro-animations */
        .pulse { animation: pulseAnim .9s ease; }
        @keyframes pulseAnim { 0% { transform:scale(1) } 50% { transform:scale(1.06) } 100% { transform:scale(1) } }

        /* utility */
        .hidden { display:none !important }
        .text-muted { color:var(--muted) }

        /* responsive */
        @media (max-width:720px) {
            .progress-group-container { top: 96px; width: 94% }
            .button-container { grid-template-columns: repeat(5, 1fr); gap:8px; max-width: 100% }
            .user-meta { max-width:120px }
            .balance { font-size:13px }
        }

        /* Prevent horizontal overflow */
        html, body { max-width:100%; overflow-x:hidden; }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen" aria-hidden="false">
      <div class="loader" aria-hidden="true">
        <span class="l">L</span>
        <span class="o">O</span>
        <span class="a">A</span>
        <span class="d">D</span>
        <span class="ispan">I</span>
        <span class="n">N</span>
        <span class="g">G</span>
      </div>
    </div>
    
    <div class="app-screen main-screen visible" id="mainScreen" aria-hidden="false">
        <div class="topbar" role="region" aria-label="User Info">
            <div class="user-wrap">
                <div class="user-circle" id="userCircle" onclick="circleClick()" title="Open profile">
                    <img id="userImage" src="" alt="User" />
                </div>
                <div class="user-meta" aria-live="polite">
                    <span class="name" id="userName">Guest</span>
                    <span class="id" id="userId">ID: -</span>
                </div>
            </div>

            <div class="balance-wrap">
                <div id="sessionBadge" class="session-badge session-normal">NORMAL</div>
                <div class="balance" id="shibBalance">0 SHIB</div>
            </div>
        </div>

        <div class="progress-group-container" aria-hidden="false">
            <div class="progress-card">
                <div class="progress-title">Ads today <span id="adsCount" class="text-muted">0 / 200</span></div>
                <div class="progress-bar"><div id="dailyProgressFill" class="progress-fill" style="width:0%"></div></div>
            </div>
            <div class="progress-card">
                <div class="progress-title">Spins today <span id="spinsCount" class="text-muted">0 / 25</span></div>
                <div class="progress-bar"><div id="spinProgressFill" class="progress-fill" style="width:0%"></div></div>
            </div>
        </div>

        <div class="main-content">
            <div class="card-center" id="centerCard">
                <div style="font-size:20px;color:#e6f7ff;font-weight:900">Welcome to SHIB Ads</div>
                <div style="font-size:13px;color:#cfe8ff;text-align:center;max-width:440px">Watch short ads, complete tasks and spin the wheel to earn SHIB. Your account is secured with multi-layer protection.</div>
            </div>
        </div>
        
        <div class="button-container" role="navigation" aria-label="Main navigation">
            <button id="adsBtn" class="nav-button" onclick="watchAds()"><span>Ads</span> <span class="btn-loading" id="adsBtnLoading"></span></button>
            <button id="taskNavBtn" class="nav-button task-btn" onclick="showTask()"><span>Task</span></button>
            <button id="spinNavBtn" class="nav-button" onclick="showSpin()"><span>Spin</span></button>
            <button id="withdrawNavBtn" class="nav-button withdraw-btn-nav" onclick="showWithdraw()"><span>Withdraw</span></button>
            <button id="inviteNavBtn" class="nav-button" onclick="inviteFriends()"><span>Invite</span></button>
        </div>
    </div>

    <div class="app-screen task-screen" id="taskScreen" aria-hidden="true">
        <div class="task-header">
            <h2 class="task-title">Daily Tasks</h2>
            <div style="font-size:13px;color:#cfe8ff">Complete tasks to earn SHIB. Buttons lock briefly to discourage automation.</div>
        </div>
        
        <div class="task-content-container" id="taskContentContainer">
            <div id="taskLinkArea" class="task-link-container" style="display:none;">
                <div class="task-link-title">
                    <span>Open and get 5 SHIB</span>
                    <span id="taskLinkCountDisplay" class="text-muted">0 / 200</span>
                </div>
                <div class="task-link-progress-bar">
                    <div class="task-link-progress-fill" id="taskLinkProgressFill" style="width:0%"></div>
                </div>
                <button class="task-link-button" id="taskLinkBtn" onclick="handleTaskLinkClick()">Open and get 5 SHIB</button>
            </div>

            <div id="taskListContainer">
                </div>

            <div id="noChannelTasksNotice" class="no-channel-tasks" style="display:none;color:#cfe8ff">No channel tasks now.</div>
        </div>

        <button class="task-back-btn" onclick="hideTask()">Back to Main</button>
    </div>

    <div class="app-screen spin-screen" id="spinScreen" aria-hidden="true">
        <div id="wheelBox">
            <div class="arrow"></div>
            <canvas id="wheelCanvas" width="280" height="280" aria-hidden="false" role="img" aria-label="Prize Wheel"></canvas>
        </div>
        <button class="spin-btn" id="spinBtn" onclick="startSpin()">SPIN <span id="spinLoading" style="display:inline-block;margin-left:8px"></span></button>
        <div class="spin-result" id="spinResult"></div>
        <button class="spin-back" onclick="hideSpin()">Back</button>
    </div>

    <div class="app-screen withdraw-screen" id="withdrawScreen" aria-hidden="true">
        <div class="withdraw-header">
            <div class="withdraw-header-top">
                <h3 class="withdraw-title">üí∞ Request SHIB Withdrawal</h3>
            </div>
            <div class="current-balance-info" style="color:#fff">Your Balance: <span id="withdrawBalanceDisplay">0 SHIB</span></div>
        </div>
        
        <div class="input-form-container" role="form" aria-label="Withdrawal form">
            <div class="input-group">
                <label>Choose Withdrawal Method</label>
                <div class="withdraw-method-toggle" id="withdrawMethodToggle">
                    <label class="method-option active" id="methodBinance">
                        <input type="radio" name="withdrawMethod" value="binance" checked>
                        <span class="label">Binance ID</span>
                    </label>
                    <label class="method-option" id="methodFaucetpay">
                        <input type="radio" name="withdrawMethod" value="faucetpay">
                        <span class="label">FaucetPay Email</span>
                    </label>
                </div>
            </div>

            <div class="input-group" id="binanceGroup">
                <label>Binance User ID</label>
                <input type="text" id="binanceId" placeholder=" Binance ID">
            </div>

            <div class="input-group" id="faucetpayGroup" style="display:none;">
                <label>FaucetPay Email</label>
                <input type="email" id="faucetpayEmail" placeholder="your@email.com">
            </div>

            <div class="input-group">
                <label>Amount in SHIB (Min 2000)</label>
                <input type="number" id="withdrawAmount" min="2000" value="" placeholder="">
            </div>
            <div class="withdraw-buttons">
                <button class="withdraw-btn" onclick="confirmWithdraw()">Send Request</button>
                <button class="back-btn" onclick="displayWithdrawalsFull()" style="max-width:220px">Open History</button>
            </div>
        </div>
        
        <div class="note">
            ‚ö†Ô∏è Important: The withdrawal will be processed manually within 24 hours. Ensure your Binance ID or FaucetPay email is correct.
        </div>

        <button class="back-btn" onclick="hideWithdraw()">Back to Main</button>
    </div>

    <div class="app-screen withdraw-history-screen" id="withdrawHistoryScreen" style="background:#f7f7fb" aria-hidden="true">
        <div class="withdraw-history-full" id="withdrawHistoryFull">
            <div class="withdraw-history-header" style="display:flex;justify-content:space-between;align-items:center">
                <h2 style="margin:0">Withdrawal History</h2>
                <div><button class="back-btn" onclick="closeWithdrawHistory()">Back</button></div>
            </div>

            <div class="history-list" id="withdrawHistoryList">
                <!-- items injected here -->
            </div>
        </div>
    </div>

    <div class="app-screen invite-screen" id="inviteScreen" aria-hidden="true">
        <div class="invite-header">
            <h2 class="invite-title">ü§ù Invite Friends & Earn SHIB</h2>
            <div class="referrals-count-info" style="color:#fff">
                Your Referrals: <span id="referralsCountDisplay">0</span>
            </div>
        </div>
        
        <div class="input-form-container">
            <div class="input-group">
                <label>Your Referral Link</label>
                <input type="text" id="referralLinkInput" readonly value="Generating Link...">
            </div>
            <div class="invite-buttons">
                <button class="copy-link-btn" onclick="copyReferralLink()">Copy Link</button>
            </div>
        </div>
        
        <div class="note">
            üöÄ Share this link to invite new users. You will earn 40% of the revenue from every referral you bring through ads!
        </div>

        <button class="back-btn" onclick="hideInvite()">Back to Main</button>
    </div>

    <div class="app-screen contest-screen" id="contestScreen" aria-hidden="true">
        <div class="contest-header">
            <h2 class="contest-title">üèÜ Contest</h2>
            <div class="contest-countdown" id="contestCountdown">15d 00h 00m 00s</div>
            <div class="prize-vertical-box" id="prizeBox">
                <div class="prize-item"><div class="prize-label">1st Place</div><div class="prize-value">500,000 SHIB</div></div>
                <div class="prize-item"><div class="prize-label">2nd Place</div><div class="prize-value">250,000 SHIB</div></div>
                <div class="prize-item"><div class="prize-label">3rd Place</div><div class="prize-value">100,000 SHIB</div></div>
                <div class="prize-item"><div class="prize-label">4th Place</div><div class="prize-value">100,000 SHIB</div></div>
                <div class="prize-item"><div class="prize-label">5th Place</div><div class="prize-value">50,000 SHIB</div></div>
            </div>
        </div>
        
        <div class="contest-tickets-container" role="region" aria-label="Contest Tickets Summary" style="width:90%;max-width:420px;margin-top:12px">
            <div style="display:flex;justify-content:space-between;gap:12px">
                <div style="display:flex;flex-direction:column;align-items:flex-start">
                    <div style="font-size:13px;color:#cfe8ff;font-weight:800">My Tickets</div>
                    <div style="font-size:18px;color:#ffd700;font-weight:900" id="myTickets">0</div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end">
                    <div style="font-size:13px;color:#cfe8ff;font-weight:800">All Tickets</div>
                    <div style="font-size:18px;color:#ffd700;font-weight:900" id="allTickets">0</div>
                </div>
            </div>
        </div>
        
        <div class="contest-buttons-horizontal" style="margin-top:12px">
            <button class="contest-watch-btn" onclick="watchContestAd()">Watch</button>
            <button class="contest-rank-btn" onclick="showContestRank()">Ranking</button>
        </div>
        
        <button class="contest-back-btn" onclick="hideContest()">Back to Main</button>
    </div>

    <div class="app-screen contest-rank-screen" id="contestRankScreen" aria-hidden="true">
        <div style="width:90%;max-width:720px;margin:12px auto;display:flex;justify-content:space-between;align-items:center">
            <h2 style="color:#e6f7ff">üèÜ Top Players</h2>
            <div><button class="back-btn" onclick="hideContestRank()">Back</button></div>
        </div>

        <div id="personalUserBox" class="personal-info-box" style="display:none;width:90%;max-width:720px;margin:0 auto 12px;padding:10px;border-radius:12px;background:linear-gradient(90deg,#2b2a2a,rgba(255,215,0,0.06));color:#fff">
            <img src="" alt="avatar" class="personal-avatar" id="personalAvatar">
            <div style="display:flex;flex-direction:row;align-items:center;gap:12px;width:100%;justify-content:space-between">
                <div style="display:flex;flex-direction:column;align-items:flex-start">
                    <div style="font-size:12px;color:rgba(255,255,255,0.75);font-weight:700">ID</div>
                    <div id="personalIdValue" style="color:#ffd700;font-weight:900">-</div>
                </div>
                <div style="flex:1;text-align:center">
                    <div style="font-size:12px;color:rgba(255,255,255,0.75);font-weight:700">User</div>
                    <div id="personalNameValue" style="color:#ffd700;font-weight:900">-</div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end">
                    <div style="font-size:12px;color:rgba(255,255,255,0.75);font-weight:700">Tickets</div>
                    <div id="personalTicketsValue" style="color:#ffd700;font-weight:900">0</div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end">
                    <div style="font-size:12px;color:rgba(255,255,255,0.75);font-weight:700">Rank</div>
                    <div id="personalRankValue" style="color:#00bfff;font-weight:900">-</div>
                </div>
            </div>
        </div>

        <div class="contest-rank-list" id="contestRankList" aria-live="polite" style="width:90%;max-width:720px;margin:0 auto;padding-bottom:40px">
            <!-- Top players will be injected here from server -->
        </div>
    </div>

    <!-- Toaster container -->
    <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

    <!-- Background audio player (playlist managed in JS): audio.mp3, audio2.mp3, audio3.mp3, audio4.mp3 -->
    <audio id="bgPlayer" preload="none">
        <source id="bgSource" src="audio.mp3" type="audio/mp3">
    </audio>

    <audio id="successSFX">
        <source src="success.mp3" type="audio/mp3"> 
    </audio>
    <audio id="errorSFX">
        <source src="error.mp3" type="audio/mp3"> 
    </audio>

    <script src='//libtl.com/sdk.js' data-zone='10245709' data-sdk='show_10245709'></script>
    <script>
        /* ===== Lightweight Utilities & Security UX Integration ===== */

        // Local keys
        const LS_SESSION = 'shib_session_token_v1';
        const LS_FINGERPRINT = 'shib_fp_v1';

        // Basic state
        let tgUser = null;
        let sessionToken = localStorage.getItem(LS_SESSION) || null;
        let fingerprintHash = localStorage.getItem(LS_FINGERPRINT) || null;

        // Reusable UI elements
        const loadingScreen = document.getElementById('loadingScreen');
        const toastContainer = document.getElementById('toastContainer');
        const sessionBadge = document.getElementById('sessionBadge');

        // Audio
        const bgPlayer = document.getElementById('bgPlayer');
        const successSFX = document.getElementById('successSFX');
        const errorSFX = document.getElementById('errorSFX');

        // Background playlist
        const bgPlaylist = ['audio.mp3', 'audio2.mp3', 'audio3.mp3', 'audio4.mp3'];
        let currentBgIndex = -1;
        function playNextBg() {
            if (!Array.isArray(bgPlaylist) || bgPlaylist.length === 0) return;
            currentBgIndex = (currentBgIndex + 1) % bgPlaylist.length;
            try {
                bgPlayer.src = bgPlaylist[currentBgIndex];
                bgPlayer.load();
                bgPlayer.volume = 0.35;
                bgPlayer.play().catch(()=>{});
            } catch(e){}
        }
        bgPlayer.addEventListener('ended', playNextBg);
        bgPlayer.addEventListener('error', playNextBg);

        function playBGAudio() {
            try {
                if (currentBgIndex === -1) currentBgIndex = 0;
                bgPlayer.src = bgPlaylist[currentBgIndex];
                bgPlayer.volume = 0.35;
                bgPlayer.play().catch(()=>{});
            } catch(e){}
        }

        function playSFX(type){
            const sfx = type === 'success' ? successSFX : errorSFX;
            if(!sfx) return;
            try { sfx.currentTime = 0; sfx.volume = 0.8; sfx.play().catch(()=>{}); } catch(e){}
        }

        // Toast (non-intrusive)
        function showToast(msg, type='success', timeout=3800) {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            toastContainer.appendChild(t);
            playSFX(type === 'success' ? 'success' : 'error');
            setTimeout(()=> {
                t.style.opacity = '0';
                t.style.transform = 'translateY(6px) scale(.98)';
                setTimeout(()=> t.remove(), 220);
            }, timeout);
        }

        // Session badge utility
        function setSessionState(state) {
            const el = sessionBadge;
            el.classList.remove('session-normal','session-cooldown','session-suspicious');
            if (state === 'normal') {
                el.textContent = 'NORMAL';
                el.classList.add('session-normal');
            } else if (state === 'cooldown') {
                el.textContent = 'COOLDOWN';
                el.classList.add('session-cooldown');
            } else if (state === 'suspicious') {
                el.textContent = 'SUSPICIOUS';
                el.classList.add('session-suspicious');
            } else {
                el.textContent = 'UNKNOWN';
                el.classList.add('session-suspicious');
            }
        }

        // simple button lock to deter auto-clicking
        function lockButton(btn, ms = 3000) {
            if(!btn) return;
            btn.disabled = true;
            btn.classList.add('locked');
            const spinner = btn.querySelector('.small-spinner');
            if(!spinner) {
                const s = document.createElement('span');
                s.className = 'small-spinner';
                s.style.marginLeft = '8px';
                btn.appendChild(s);
            }
            setTimeout(()=>{
                btn.disabled = false;
                btn.classList.remove('locked');
                const s = btn.querySelector('.small-spinner');
                if(s) s.remove();
            }, ms);
        }

        // Lightweight SHA-256 helper for fingerprint (browser)
        async function sha256Hex(message) {
            const enc = new TextEncoder();
            const data = enc.encode(message);
            const hash = await crypto.subtle.digest('SHA-256', data);
            const arr = Array.from(new Uint8Array(hash));
            return arr.map(b => b.toString(16).padStart(2,'0')).join('');
        }

        // Build client fingerprint and cache
        async function buildFingerprint() {
            try {
                const nav = navigator || {};
                const fpObj = {
                    ua: nav.userAgent || '',
                    lang: nav.language || '',
                    platform: nav.platform || '',
                    hw: nav.hardwareConcurrency || 0,
                    memory: nav.deviceMemory || 0,
                    width: screen.width || 0,
                    height: screen.height || 0,
                    availWidth: screen.availWidth || 0,
                    availHeight: screen.availHeight || 0,
                    timezoneOffset: new Date().getTimezoneOffset(),
                    vendor: nav.vendor || ''
                };
                const raw = JSON.stringify(fpObj);
                const h = await sha256Hex(raw);
                localStorage.setItem(LS_FINGERPRINT, h);
                fingerprintHash = h;
                return { hash: h, raw: fpObj };
            } catch (e) {
                return { hash: 'unknown', raw: {} };
            }
        }

        // DevTools heuristic detection
        function detectDevTools() {
            try {
                const threshold = 160;
                const widthDiff = Math.abs(window.outerWidth - window.innerWidth);
                const heightDiff = Math.abs(window.outerHeight - window.innerHeight);
                if (widthDiff > threshold || heightDiff > threshold) return true;
                // Overwrite detection: check for debugger keyword time anomalies
                const start = performance.now();
                // small code that may take slightly longer if devtools paused
                for(let i=0;i<100000;i++) { Math.sqrt(i) }
                const end = performance.now();
                if (end - start > 80) return true;
            } catch(e){}
            return false;
        }

        // Global fetch wrapper which includes initData, fingerprint and session token and devtools flag
        const API_URL = '/api';
        async function fetchApi(payload) {
            // attach session/token and fingerprint
            payload.session_token = sessionToken || null;
            payload.fingerprint_hash = fingerprintHash || null;
            payload.client = {
                ua: navigator.userAgent || '',
                lang: navigator.language || '',
                tz_offset: new Date().getTimezoneOffset(),
                screen: { w: screen.width||0, h: screen.height||0 }
            };
            // devtools heuristic
            payload.devtools = detectDevTools();

            // include Telegram init data if present
            if (typeof Telegram !== 'undefined' && Telegram.WebApp && Telegram.WebApp.initData) {
                payload.initData = Telegram.WebApp.initData;
                payload.initDataUnsafe = Telegram.WebApp.initDataUnsafe || null;
            }

            // Ensure we show subtle progress on the WebApp if available
            try {
                if (typeof Telegram !== 'undefined' && Telegram.WebApp && typeof Telegram.WebApp.showProgress === 'function') {
                    Telegram.WebApp.showProgress();
                }
            } catch(e){}

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json' },
                    body: JSON.stringify(payload)
                });
                try { if (typeof Telegram !== 'undefined' && Telegram.WebApp && typeof Telegram.WebApp.hideProgress === 'function') Telegram.WebApp.hideProgress(); } catch(e){}
                const data = await res.json().catch(()=>({ ok:false, error:'Invalid JSON' }));
                // If server indicates a session_state or warning, reflect in UI
                if (data && data.data && data.data.session_state) {
                    setSessionState(data.data.session_state);
                }
                return data;
            } catch (err) {
                try { if (typeof Telegram !== 'undefined' && Telegram.WebApp && typeof Telegram.WebApp.hideProgress === 'function') Telegram.WebApp.hideProgress(); } catch(e){}
                showToast('Connection error. Check your network.', 'error', 3500);
                return { ok:false, error: err.message || 'Network' };
            }
        }

        /* ===== Initialisation & Registration ===== */

        Telegram.WebApp.ready();

        document.addEventListener('DOMContentLoaded', async () => {
            // build fingerprint (async) and store locally
            await buildFingerprint();

            // Short simulated loader to present polished UX
            setTimeout(async () => {
                // Attempt initial register / session creation on server
                await initDailyProgress();
                loadingScreen.classList.add('hidden');
                playBGAudio();
            }, 2800);
        });

        async function initDailyProgress(){
            if (!Telegram.WebApp.initDataUnsafe || !Telegram.WebApp.initDataUnsafe.user) {
                // still allow usage in limited mode but will fail server-side validation
            }
            // Prepare minimal payload for register
            const userObj = Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user ? Telegram.WebApp.initDataUnsafe.user : null;

            const payload = {
                type: 'register',
                ref_by: (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.start_param && Telegram.WebApp.initDataUnsafe.start_param.startsWith('ref_')) ? Telegram.WebApp.initDataUnsafe.start_param.split('ref_')[1] : null,
                user: userObj
            };

            const res = await fetchApi(payload);
            if (res && res.ok) {
                // server may return session_token
                if (res.data && res.data.session_token) {
                    sessionToken = res.data.session_token;
                    localStorage.setItem(LS_SESSION, sessionToken);
                }
                await loadUserData();
                showToast('Welcome back!', 'success', 2200);
            } else {
                // if register failed, still attempt to show main screen but indicate suspicious state
                setSessionState('suspicious');
                showToast('Initialization warning. Some features may be limited.', 'warning', 3600);
            }
        }

        /* ===== User Data & UI Sync ===== */

        let shibBalance = 0;
        let adsWatchedToday = 0;
        let spinsToday = 0;
        let referralsCount = 0;
        let withdrawalHistory = [];

        function updateUIElements(){
            document.getElementById('shibBalance').textContent = (shibBalance || 0).toLocaleString() + ' SHIB';
            document.getElementById('withdrawBalanceDisplay').textContent = (shibBalance || 0).toLocaleString() + ' SHIB';
            document.getElementById('adsCount').textContent = `${adsWatchedToday} / 200`;
            document.getElementById('spinsCount').textContent = `${spinsToday} / 25`;
            const adsPercent = Math.min((adsWatchedToday / 200) * 100, 100);
            document.getElementById('dailyProgressFill').style.width = adsPercent + '%';
            const spinsPercent = Math.min((spinsToday / 25) * 100, 100);
            document.getElementById('spinProgressFill').style.width = spinsPercent + '%';
            document.getElementById('referralsCountDisplay').textContent = (referralsCount || 0).toLocaleString();
        }

        async function loadUserData() {
            if (!Telegram.WebApp.initDataUnsafe || !Telegram.WebApp.initDataUnsafe.user) return;
            const result = await fetchApi({ type: 'getUserData' });
            if (result && result.ok && result.data) {
                const data = result.data;
                if (data.is_banned) {
                    // If server reports banned, show suspicious state and block UI
                    setSessionState('suspicious');
                    showToast('Account restricted. Access limited.', 'error', 4000);
                    // hide main controls
                    document.querySelectorAll('.nav-button').forEach(b=>b.disabled=true);
                    return;
                }
                // Update authoritative values from server
                shibBalance = data.balance || 0;
                adsWatchedToday = data.ads_watched_today || 0;
                spinsToday = data.spins_today || 0;
                referralsCount = data.referrals_count || 0;
                withdrawalHistory = data.withdrawal_history || [];
                if (data.session_state) setSessionState(data.session_state);
                else setSessionState('normal');
                // If server returns session_token refresh local copy
                if (data.session_token) {
                    sessionToken = data.session_token;
                    localStorage.setItem(LS_SESSION, sessionToken);
                }
                // Update UI
                updateUIElements();
                // Render withdrawals preview if present
                displayWithdrawals();
            } else {
                setSessionState('suspicious');
                showToast('Failed to sync user data securely.', 'warning', 3000);
            }
        }

        /* ===== Fingerprint helper to include with specific actions ===== */
        async function ensureFingerprint() {
            if (!fingerprintHash) {
                await buildFingerprint();
            }
            return fingerprintHash;
        }

        /* ===== Anti-automation UX: lock + show spinner helper ===== */
        function withActionLock(button, fn, lockMs = 3000) {
            if (!button) {
                // fallback: run function
                return fn();
            }
            if (button.disabled) return;
            lockButton(button, lockMs);
            return fn();
        }

        /* ===== Reworked toast-based "alerts" usage in code (non-intrusive) ===== */
        function showCustomAlert(title, message, type = 'warning') {
            // non-blocking toast summarizing
            const msg = title ? `${title}: ${message}` : message;
            showToast(msg, type === 'error' ? 'error' : (type === 'success' ? 'success' : 'warning'));
        }

        /* ===== Telegram user init (display only) ===== */
        if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
            tgUser = Telegram.WebApp.initDataUnsafe.user;
            const imgEl  = document.getElementById('userImage');
            const nameEl = document.getElementById('userName');
            const idEl   = document.getElementById('userId');
            if (tgUser.photo_url) {
                imgEl.src = tgUser.photo_url;
                imgEl.style.display = 'block';
            } else {
                imgEl.src = '';
            }
            nameEl.textContent = tgUser.first_name + (tgUser.last_name? ' '+tgUser.last_name:'');
            idEl.textContent   = 'ID: ' + (tgUser.id || '-');
        }

        /* ===== Actions: Ads / Task Link / Task / Spin / Withdraw / Invite / Contest ===== */

        // Request Action ID and use it for server security. The client always requests this from server.
        async function requestActionId(actionType) {
            const fp = await ensureFingerprint();
            const res = await fetchApi({ type: 'generateActionId', action_type: actionType });
            if (res && res.ok && res.data && res.data.action_id) return res.data.action_id;
            return null;
        }

        // WATCH ADS: adapt to anti-bot UX: lock, progress, two-ad sequence (existing), show toast
        async function watchAds(){
            const btn = document.getElementById('adsBtn');
            return withActionLock(btn, async () => {
                // quick sanity
                if (!tgUser) { showCustomAlert('User not ready', 'Please open via Telegram to continue.', 'warning'); return; }
                // request action id
                const actionId = await requestActionId('watchAd');
                if (!actionId) { showCustomAlert('Security', 'Unable to obtain secure token. Try again.', 'error'); return; }

                // Show ad sequence with loader
                document.getElementById('adsBtnLoading').innerHTML = '<span class="small-spinner"></span>';
                try {
                    await show_10245709();
                    await show_10245709();
                } catch(e) {
                    document.getElementById('adsBtnLoading').innerHTML = '';
                    showCustomAlert('Ad Error', 'Ad failed to play fully.', 'warning');
                    return;
                }

                // Send watchAd verification to server
                const res = await fetchApi({ type:'watchAd', action_id: actionId });
                document.getElementById('adsBtnLoading').innerHTML = '';
                if (res && res.ok) {
                    // server authoritative new balance
                    shibBalance = res.data.new_balance || shibBalance;
                    adsWatchedToday = res.data.new_ads_count || adsWatchedToday;
                    updateUIElements();
                    // UX micro-animation
                    document.getElementById('shibBalance').classList.add('pulse');
                    setTimeout(()=>document.getElementById('shibBalance').classList.remove('pulse'),800);
                    showToast(`You received ${res.data.actual_reward} SHIB`, 'success', 2800);
                } else {
                    // server will reply with error or silent shadow-ban behavior (server may return ok:true even on shadow ban)
                    if (res && res.error) {
                        if (res.error.toLowerCase().includes('banned')) {
                            setSessionState('suspicious');
                            showCustomAlert('Access Denied!', 'This account has been restricted.', 'error');
                        } else {
                            showCustomAlert('Ad Failed', res.error, 'error');
                        }
                    } else {
                        showCustomAlert('Ad Failed', 'Unknown error when awarding reward.', 'error');
                    }
                }
            }, 3000);
        }

        // TASK LINK logic
        const TASK_LINK_URL = 'https://otieu.com/4/10259911';
        async function handleTaskLinkClick() {
            const btn = document.getElementById('taskLinkBtn');
            return withActionLock(btn, async () => {
                if (!tgUser) { showCustomAlert('User not ready', 'Please open via Telegram to continue.', 'warning'); return; }
                const actionId = await requestActionId('taskLink');
                if (!actionId) { showCustomAlert('Security', 'Unable to obtain secure token. Try again.', 'error'); return; }

                // open external link
                const opened = openExternalLink(TASK_LINK_URL);
                if (!opened) {
                    showCustomAlert('Open Failed', 'Unable to open the link.', 'error');
                    return;
                }
                // inform server
                const res = await fetchApi({ type:'taskLinkClick', action_id: actionId, url: TASK_LINK_URL });
                if (res && res.ok) {
                    shibBalance = res.data.new_balance || shibBalance;
                    updateUIElements();
                    showToast(`+${res.data.actual_reward} SHIB`, 'success', 2400);
                } else {
                    showCustomAlert('Task Link', res && res.error ? res.error : 'Could not claim reward.', 'warning');
                }
            }, 3000);
        }

        // TASK FLOW: fetch tasks list, open, claim, verify
        async function fetchTasks() {
            const res = await fetchApi({ type:'getTasks' });
            if (res && res.ok && Array.isArray(res.data.tasks)) {
                return res.data.tasks;
            }
            return [];
        }

        function renderTasksList(tasks) {
            const container = document.getElementById('taskListContainer');
            const noChannelNotice = document.getElementById('noChannelTasksNotice');
            if (!container) return;

            const availableTasks = Array.isArray(tasks) ? tasks.filter(t => !t.is_completed) : [];

            if (!Array.isArray(availableTasks) || availableTasks.length === 0) {
                container.innerHTML = `<div class="task-item-card"><span class="task-text-info">No tasks now.</span></div>`;
                if (noChannelNotice) noChannelNotice.style.display = 'none';
                return;
            }

            if (noChannelNotice) noChannelNotice.style.display = 'none';

            const html = availableTasks.map(t => {
                const rewardText = `Reward: ${t.reward} SHIB`;
                const safeLink = (t.link || '').replace(/"/g, '&quot;');
                return `
                    <div class="task-item-card" data-task-id="${t.task_id}">
                        <span class="task-text-info">${t.name} ‚Äî ${rewardText}</span>
                        <button class="task-action-btn-new" data-task-link="${safeLink}" data-task-id="${t.task_id}" onclick="onTaskButtonClick(event)">
                            Open
                        </button>
                    </div>
                `;
            }).join('');
            container.innerHTML = html;
        }

        async function onTaskButtonClick(event) {
            event = event || window.event;
            const btn = event.currentTarget || event.target;
            const taskId = btn.getAttribute('data-task-id');
            const taskLink = btn.getAttribute('data-task-link') || '';

            if (!taskId) { showCustomAlert('Task Error', 'Task id not found', 'error'); return; }

            // If button text is Claim, proceed to claim flow
            if ((btn.textContent || '').trim().toLowerCase() === 'claim') {
                return withActionLock(btn, async () => {
                    const actionId = await requestActionId(`completeTask_${taskId}`);
                    if (!actionId) { showCustomAlert('Security','Failed to obtain token','error'); return; }
                    const res = await fetchApi({ type:'completeTask', action_id: actionId, task_id: taskId });
                    if (res && res.ok) {
                        shibBalance = res.data.new_balance || shibBalance;
                        updateUIElements();
                        btn.disabled = true;
                        btn.classList.add('completed');
                        btn.textContent = 'Claimed';
                        showToast(`+${res.data.actual_reward} SHIB`, 'success', 2600);
                    } else {
                        showCustomAlert('Verification Failed', res && res.error ? res.error : 'Task verification failed', 'warning');
                    }
                }, 3000);
            }

            // Otherwise open the link and change button to Claim
            if (taskLink && taskLink.trim() !== '') {
                const opened = openExternalLink(taskLink);
                if (opened) {
                    btn.textContent = 'Claim';
                    showToast('Opened task. Click Claim after completing the action.', 'warning', 3500);
                } else {
                    showCustomAlert('Open Link Failed', 'Unable to open the link. Try again.', 'error');
                }
            } else {
                btn.textContent = 'Claim';
                showToast('No external link. Click Claim to attempt verification.', 'warning', 2800);
            }
        }

        async function showTask(){
            document.getElementById('mainScreen').classList.remove('visible');
            document.getElementById('taskScreen').classList.add('visible');
            const tasks = await fetchTasks();
            renderTasksList(tasks);
            // Load task-link status from server via getUserData
            await loadUserData();
        }

        function hideTask(){
            document.getElementById('taskScreen').classList.remove('visible');
            document.getElementById('mainScreen').classList.add('visible');
        }

        // SPIN WHEEL
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const sectors = [5,10,15,20,5];
        const colors = ['#00bfff','#ff8c00','#28a745','#ff4500','#00f2fe'];
        let spinning = false;
        let currentAngle = 0;

        function drawWheel() {
            const centerX = canvas.width/2;
            const centerY = canvas.height/2;
            const radius = 126;
            const sectorCount = sectors.length;
            const arc = 2*Math.PI/sectorCount;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.font = '18px Vazirmatn, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            sectors.forEach((val,i)=>{
                const start = i*arc - Math.PI/2;
                const end = start + arc;
                ctx.beginPath();
                ctx.fillStyle = colors[i%colors.length];
                ctx.moveTo(centerX,centerY);
                ctx.arc(centerX,centerY,radius,start,end);
                ctx.closePath();
                ctx.fill();
                // label
                const angle = start + arc/2;
                const textX = centerX + radius*0.6*Math.cos(angle);
                const textY = centerY + radius*0.6*Math.sin(angle);
                ctx.save();
                ctx.translate(textX,textY);
                ctx.rotate(angle + Math.PI/2);
                ctx.fillStyle = '#000';
                ctx.fillText(`${val} SHIB`, 0, 0);
                ctx.restore();
            });
            // center circle
            ctx.beginPath(); ctx.fillStyle='#fff'; ctx.arc(centerX,centerY,20,0,2*Math.PI); ctx.fill();
        }
        drawWheel();

        async function startSpin(){
            const btn = document.getElementById('spinBtn');
            if (spinning) return;
            return withActionLock(btn, async () => {
                if (!tgUser) { showCustomAlert('User not ready', 'Please open via Telegram to continue.', 'warning'); return; }
                const pre = await requestActionId('preSpin');
                if (!pre) { showCustomAlert('Security', 'Failed to secure spin.', 'error'); return; }
                const preRes = await fetchApi({ type:'preSpin', action_id: pre });
                if (!preRes || !preRes.ok) { showCustomAlert('Spin Error','Server denied spin','error'); return; }
                // Show two ads (as before)
                try {
                    await show_10245709();
                    await show_10245709();
                } catch(e) {
                    showCustomAlert('Ad Error','Spin requires watching ads fully', 'warning');
                    return;
                }
                // Request final action id
                const actionId = await requestActionId('spinResult');
                if (!actionId) { showCustomAlert('Security','Failed to get final token', 'error'); return; }
                // Start spin animation
                spinning = true;
                btn.disabled = true;
                canvas.classList.add('spinning');
                const res = await fetchApi({ type:'spinResult', action_id: actionId });
                if (res && res.ok) {
                    const prize = res.data.actual_prize;
                    const idx = res.data.prize_index || 0;
                    const sectorsLen = sectors.length;
                    const arc = 2*Math.PI/sectorsLen;
                    const winningAngle = idx*arc + arc/2;
                    const rotationToApply = (Math.PI/2 - winningAngle) + (6 * 2 * Math.PI);
                    currentAngle += rotationToApply;
                    canvas.style.transition = 'transform 4s cubic-bezier(.22,0,.2,1)';
                    requestAnimationFrame(()=> canvas.style.transform = `rotate(${currentAngle}rad)`);
                    setTimeout(async ()=>{
                        canvas.style.transition = '';
                        canvas.classList.remove('spinning');
                        spinning = false;
                        btn.disabled = false;
                        // update authoritative values
                        shibBalance = res.data.new_balance || shibBalance;
                        spinsToday = res.data.new_spins_count || spinsToday;
                        updateUIElements();
                        // micro animation + toast
                        document.getElementById('spinResult').textContent = `You won ${prize} SHIB!`;
                        document.getElementById('spinResult').classList.add('pulse');
                        setTimeout(()=>document.getElementById('spinResult').classList.remove('pulse'),900);
                        showToast(`üéâ You won ${prize} SHIB!`, 'success', 3500);
                    }, 4200);
                } else {
                    canvas.classList.remove('spinning');
                    spinning = false;
                    btn.disabled = false;
                    showCustomAlert('Spin Error', res && res.error ? res.error : 'Failed to get spin result', 'error');
                }
            }, 4000);
        }

        /* ===== Withdraw / History ===== */
        async function confirmWithdraw(){
            const btn = document.querySelector('.withdraw-btn');
            return withActionLock(btn, async () => {
                const selectedMethod = document.querySelector('input[name="withdrawMethod"]:checked') ? document.querySelector('input[name="withdrawMethod"]:checked').value : 'binance';
                const binanceId = document.getElementById('binanceId').value.trim();
                const faucetpayEmail = document.getElementById('faucetpayEmail').value.trim();
                const amount = parseFloat(document.getElementById('withdrawAmount').value);
                if (selectedMethod === 'binance' && (!binanceId || binanceId.length < 3)) { showCustomAlert('Invalid','Enter valid Binance ID','warning'); return; }
                if (selectedMethod === 'faucetpay') {
                    const r = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!faucetpayEmail || !r.test(faucetpayEmail)) { showCustomAlert('Invalid','Enter valid FaucetPay email','warning'); return; }
                }
                if (isNaN(amount) || amount < 2000) { showCustomAlert('Invalid Amount','Minimum 2000 SHIB','warning'); return; }
                if (amount > shibBalance) { showCustomAlert('Balance Error','Insufficient balance', 'error'); return; }

                const actionId = await requestActionId('withdraw');
                if (!actionId) { showCustomAlert('Security','Failed to obtain token','error'); return; }
                const payload = { type:'withdraw', amount: amount, action_id: actionId };
                if (selectedMethod === 'faucetpay') payload.faucetpay_email = faucetpayEmail;
                else payload.binanceId = binanceId;
                const res = await fetchApi(payload);
                if (res && res.ok) {
                    shibBalance = res.data.new_balance || shibBalance;
                    updateUIElements();
                    showToast('Withdrawal request submitted. Processing within 24hrs.', 'success', 4200);
                    displayWithdrawals();
                } else {
                    showCustomAlert('Withdraw Failed', res && res.error ? res.error : 'Failed to submit request', 'error');
                }
            }, 3000);
        }

        function displayWithdrawals() {
            const container = document.getElementById('withdrawalHistoryContainer');
            // if no container in this layout, skip (we render full view elsewhere)
        }

        function displayWithdrawalsFull() {
            document.getElementById('mainScreen').classList.remove('visible');
            document.getElementById('withdrawScreen').classList.remove('visible');
            const screen = document.getElementById('withdrawHistoryScreen');
            const list = document.getElementById('withdrawHistoryList');
            screen.classList.add('visible');
            if (!withdrawalHistory || withdrawalHistory.length === 0) {
                list.innerHTML = `<div class="history-empty">No withdrawal records.</div>`;
                return;
            }
            const html = withdrawalHistory.map(rec => {
                const dest = rec.binance_id ? rec.binance_id : (rec.faucetpay_email ? rec.faucetpay_email : '-');
                const statusText = rec.status === 'pending' ? 'Pending' : 'Completed';
                return `
                    <div class="history-item">
                        <div style="display:flex;flex-direction:column">
                            <div><strong>Date:</strong> ${rec.date}</div>
                            <div><strong>Dest:</strong> ${dest}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-weight:800;color:#ff2a2a">${rec.amount.toLocaleString()} SHIB</div>
                            <div style="color:${rec.status==='pending'?'#ff8c00':'#28a745'};font-weight:700">${statusText}</div>
                        </div>
                    </div>
                `;
            }).join('');
            list.innerHTML = html;
        }

        function closeWithdrawHistory(){
            document.getElementById('withdrawHistoryScreen').classList.remove('visible');
            document.getElementById('withdrawScreen').classList.add('visible');
        }

        /* ===== Invite & Referral ===== */
        function inviteFriends() {
            document.getElementById('mainScreen').classList.remove('visible');
            document.getElementById('inviteScreen').classList.add('visible');
            generateReferralLink();
            loadUserData();
        }
        function hideInvite(){ document.getElementById('inviteScreen').classList.remove('visible'); document.getElementById('mainScreen').classList.add('visible'); }

        function generateReferralLink() {
            const referralLinkInput = document.getElementById('referralLinkInput');
            if (!tgUser) { referralLinkInput.value = 'User data not available.'; return; }
            const userId = tgUser.id;
            const botPath = "Bot_ad_watchbot/earn";
            const inviteLink = `https://t.me/${botPath}?startapp=ref_${userId}`;
            referralLinkInput.value = inviteLink;
        }
        function copyReferralLink() {
            const inviteLink = document.getElementById('referralLinkInput').value;
            if (!inviteLink || inviteLink === 'User data not available.') { showCustomAlert('Error!','Referral not ready','warning'); return; }
            navigator.clipboard.writeText(inviteLink).then(() => {
                if (Telegram.WebApp && Telegram.WebApp.HapticFeedback) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                showToast('Referral link copied', 'success', 2200);
            }).catch(()=> showCustomAlert('Copy Failed','Could not copy link','error'));
        }

        /* ===== Contest functions ===== */
        let contestEndTime = Date.now() + (15*24*60*60*1000);
        let myTickets = 0, allTickets = 0;
        let contestCountdownInterval = null;

        function showContest() {
            document.getElementById('mainScreen').classList.remove('visible');
            document.getElementById('contestScreen').classList.add('visible');
            startContestCountdown();
            loadContestData();
        }
        function hideContest() {
            clearInterval(contestCountdownInterval);
            document.getElementById('contestScreen').classList.remove('visible');
            document.getElementById('mainScreen').classList.add('visible');
        }
        function startContestCountdown() {
            if (contestCountdownInterval) clearInterval(contestCountdownInterval);
            contestCountdownInterval = setInterval(()=>{
                const now = Date.now();
                const d = contestEndTime - now;
                if (d < 0) { document.getElementById('contestCountdown').textContent = 'Contest Ended'; clearInterval(contestCountdownInterval); return; }
                const days = Math.floor(d/(1000*60*60*24));
                const hours = Math.floor((d%(1000*60*60*24))/(1000*60*60));
                const minutes = Math.floor((d%(1000*60*60))/(1000*60));
                const seconds = Math.floor((d%(1000*60))/1000);
                document.getElementById('contestCountdown').textContent = `${days}d ${hours.toString().padStart(2,'0')}h ${minutes.toString().padStart(2,'0')}m ${seconds.toString().padStart(2,'0')}s`;
            },1000);
        }
        async function loadContestData() {
            const res = await fetchApi({ type:'getContestData' });
            if (res && res.ok && res.data) {
                myTickets = res.data.my_tickets || 0;
                allTickets = res.data.all_tickets || 0;
                if (res.data.time && res.data.time.end_time) {
                    const end = new Date(res.data.time.end_time).getTime();
                    if (!isNaN(end)) contestEndTime = end;
                }
                document.getElementById('myTickets').textContent = myTickets;
                document.getElementById('allTickets').textContent = allTickets;
            } else {
                document.getElementById('myTickets').textContent = 0;
                document.getElementById('allTickets').textContent = 0;
            }
        }
        async function watchContestAd() {
            const btn = document.querySelector('.contest-watch-btn');
            return withActionLock(btn, async () => {
                const actionId = await requestActionId('contestWatchAd');
                if (!actionId) { showCustomAlert('Security','Could not secure action','error'); return; }
                try {
                    await show_10245709();
                    const res = await fetchApi({ type:'contestWatchAd', action_id: actionId });
                    if (res && res.ok) {
                        myTickets = res.data.my_tickets || myTickets;
                        allTickets = res.data.all_tickets || allTickets;
                        document.getElementById('myTickets').textContent = myTickets;
                        document.getElementById('allTickets').textContent = allTickets;
                        showToast('You earned 5 tickets!', 'success', 2200);
                    } else {
                        showCustomAlert('Ad Failed','Could not grant contest tickets','error');
                    }
                } catch(e) {
                    showCustomAlert('Ad Error','Failed to load ad','error');
                }
            }, 4000);
        }

        function showContestRank() {
            document.getElementById('mainScreen').classList.remove('visible');
            document.getElementById('contestScreen').classList.remove('visible');
            document.getElementById('contestRankScreen').classList.add('visible');
            document.body.classList.add('hide-top-user');
            loadContestRank();
        }
        function hideContestRank() { document.getElementById('contestRankScreen').classList.remove('visible'); document.getElementById('contestScreen').classList.add('visible'); document.body.classList.remove('hide-top-user'); }

        async function loadContestRank(){
            const res = await fetchApi({ type:'getContestRank' });
            const list = document.getElementById('contestRankList');
            if (!res || !res.ok || !Array.isArray(res.data.players) || res.data.players.length===0) {
                list.innerHTML = `<div style="text-align:center;color:#cfeeff;padding:20px;">No entries yet.</div>`;
                renderPersonalUserBox([]);
                return;
            }
            const players = res.data.players;
            const currentUserId = tgUser && tgUser.id ? String(tgUser.id) : null;
            const DEFAULT_AVATAR = 'https://giftgogame.com/static/thumbnails/5170233102089322756.webp';
            list.innerHTML = players.map((player, index) => {
                const pos = index + 1;
                const firstNameSafe = (player.first_name || `User ${player.user_id}`).replace(/</g,'&lt;').replace(/>/g,'&gt;');
                const userIdSafe = String(player.user_id || '');
                const usernameSafe = player.username ? `@${(player.username||'').replace(/</g,'&lt;')}` : '';
                let avatarSrc = player.photo_url || DEFAULT_AVATAR;
                if (currentUserId !== null && String(player.user_id) === currentUserId && tgUser && tgUser.photo_url) avatarSrc = tgUser.photo_url;
                const tickets = Number(player.tickets || 0).toLocaleString();
                const isCurrent = currentUserId !== null && String(player.user_id) === currentUserId;
                const rowClass = isCurrent ? 'contest-rank-item current-player' : 'contest-rank-item';
                const displayName = isCurrent ? `${firstNameSafe} (You)` : `${firstNameSafe}`;
                return `
                    <div class="${rowClass}" role="article" aria-label="Player ${pos}">
                        <img src="${avatarSrc}" class="contest-rank-avatar" alt="" onerror="this.onerror=null;this.src='${DEFAULT_AVATAR}'">
                        <div style="flex:1;min-width:0">
                            <div style="font-weight:900;color:#e6f7ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${displayName}</div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.7);font-weight:700">${usernameSafe}</div>
                        </div>
                        <div style="flex:0 0 120px;color:#cfeeff;font-weight:700">${userIdSafe}</div>
                        <div style="flex:0 0 110px;text-align:right;color:#ffd700;font-weight:900">${tickets}</div>
                        <div style="flex:0 0 44px;text-align:center;color:#00bfff;font-weight:700">${pos}</div>
                    </div>
                `;
            }).join('');
            renderPersonalUserBox(players);
            // scroll-to-current
            setTimeout(()=> {
                const el = list.querySelector('.contest-rank-item.current-player');
                if (el) el.scrollIntoView({ behavior:'smooth', block:'center' });
            },120);
        }

        function renderPersonalUserBox(players) {
            const box = document.getElementById('personalUserBox');
            const avatarEl = document.getElementById('personalAvatar');
            const idEl = document.getElementById('personalIdValue');
            const nameEl = document.getElementById('personalNameValue');
            const ticketsEl = document.getElementById('personalTicketsValue');
            const rankEl = document.getElementById('personalRankValue');

            if (!box || !tgUser) { if (box) box.style.display='none'; return; }
            const currentUserId = String(tgUser.id);
            let playerEntry = null;
            if (Array.isArray(players) && players.length>0) {
                playerEntry = players.find(p => String(p.user_id)===currentUserId);
            }
            const DEFAULT_AVATAR = 'https://giftgogame.com/static/thumbnails/5170233102089322756.webp';
            let avatarSrc = DEFAULT_AVATAR;
            if (playerEntry && (playerEntry.photo_url)) avatarSrc = playerEntry.photo_url;
            else if (tgUser.photo_url) avatarSrc = tgUser.photo_url;
            avatarEl.src = avatarSrc;
            idEl.textContent = currentUserId;
            nameEl.textContent = (playerEntry && (playerEntry.first_name)) ? playerEntry.first_name : (tgUser.first_name||'User');
            const ticketCount = playerEntry && playerEntry.tickets ? Number(playerEntry.tickets) : myTickets || 0;
            ticketsEl.textContent = ticketCount.toLocaleString();
            let rankText = '-';
            if (Array.isArray(players) && players.length>0) {
                const idx = players.findIndex(p => String(p.user_id)===currentUserId);
                if (idx !== -1) rankText = (idx+1).toString();
            }
            rankEl.textContent = rankText;
            box.style.display = 'flex';
        }

        /* ===== Utilities: opening external links safely ===== */
        function normalizeTaskLink(link) {
            if (!link) return '';
            link = link.trim();
            if (/^t\.me\//i.test(link)) return 'https://' + link;
            if (/^@/.test(link)) return 'https://t.me/' + link.substring(1);
            if (!/^https?:\/\//i.test(link)) return 'https://' + link;
            return link;
        }
        function openExternalLink(link) {
            if (!link) return false;
            const normalized = normalizeTaskLink(link);
            try {
                if (typeof Telegram !== 'undefined' && Telegram.WebApp && typeof Telegram.WebApp.openTelegramLink === 'function') {
                    Telegram.WebApp.openTelegramLink(normalized);
                    return true;
                } else {
                    window.open(normalized, '_blank');
                    return true;
                }
            } catch (e) {
                try { window.open(normalized, '_blank'); return true; } catch (err) { return false; }
            }
        }

        /* ===== Event listeners (UI bindings) ===== */
        document.addEventListener('click', (e) => {
            const mBin = document.getElementById('methodBinance');
            const mFaucet = document.getElementById('methodFaucetpay');
            if (e.target.closest('#methodBinance')) {
                mBin.classList.add('active'); mFaucet.classList.remove('active');
                document.getElementById('binanceGroup').style.display = 'block';
                document.getElementById('faucetpayGroup').style.display = 'none';
            } else if (e.target.closest('#methodFaucetpay')) {
                mFaucet.classList.add('active'); mBin.classList.remove('active');
                document.getElementById('binanceGroup').style.display = 'none';
                document.getElementById('faucetpayGroup').style.display = 'block';
            }
        });

        // ensure audio start on first interaction
        document.addEventListener('click', function handler() {
            playBGAudio();
            document.removeEventListener('click', handler);
        });
    </script>
</body>
</html>